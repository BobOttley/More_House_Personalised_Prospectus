<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>More House School - Enquiry Form</title>
    <style>
        /* More House School Official Brand Colours */
        :root {
            --morehouse-navy: #1a2b5c;
            --morehouse-pink: #FFB3C1;
            --morehouse-deep-pink: #FF6B9D;
            --morehouse-light-pink: #FFE5EC;
            --morehouse-text: #2C3E50;
            --morehouse-white: #FFFFFF;
            --morehouse-light-grey: #F5F5F5;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Georgia','Times New Roman',serif;line-height:1.6;color:var(--morehouse-text);background:linear-gradient(135deg,var(--morehouse-navy) 0%,#2c3e6b 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .form-container{max-width:700px;width:100%;margin:0 auto;background:white;color:var(--morehouse-text);padding:40px;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
        .school-logo{text-align:center;margin-bottom:2rem}
        .school-logo img{width:120px;height:120px;border-radius:50%;border:3px solid var(--morehouse-pink)}
        h1{color:var(--morehouse-navy);margin-bottom:10px;font-size:2.5rem;text-align:center;font-family:'Georgia',serif;font-weight:400}
        .subtitle{color:var(--morehouse-deep-pink);margin-bottom:30px;font-size:1.2rem;font-style:italic;text-align:center}
        .intro-text{background:var(--morehouse-light-pink);padding:20px;border-radius:10px;margin-bottom:30px;border-left:4px solid var(--morehouse-deep-pink)}
        .intro-text p{margin:0;font-size:1rem;line-height:1.6}
        .form-group{margin-bottom:20px;text-align:left}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:var(--morehouse-navy);font-family:'Arial','Helvetica',sans-serif}
        .required{color:var(--morehouse-deep-pink)}
        .form-group input,.form-group select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;transition:border-color .3s;font-family:'Arial','Helvetica',sans-serif}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--morehouse-deep-pink);box-shadow:0 0 0 3px rgba(255,107,157,.1)}
        .section-label{font-weight:bold;color:var(--morehouse-navy);margin:30px 0 15px;display:block;font-size:1.2rem;border-bottom:2px solid var(--morehouse-pink);padding-bottom:5px}
        .checkbox-group{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;background:var(--morehouse-light-pink);padding:20px;border-radius:10px;border:2px solid var(--morehouse-pink)}
        .checkbox-item{display:flex;align-items:center;gap:10px;padding:10px 15px;background:white;border-radius:8px;border:2px solid #ddd;transition:all .3s;cursor:pointer}
        .checkbox-item:hover{border-color:var(--morehouse-deep-pink);background:#fff9f0;transform:translateY(-2px)}
        .checkbox-item input[type="checkbox"]{cursor:pointer;width:18px;height:18px;accent-color:var(--morehouse-deep-pink)}
        .checkbox-item label{cursor:pointer;margin:0;font-weight:normal;color:var(--morehouse-text);font-size:.9rem}
        .checkbox-item input[type="checkbox"]:checked+label{color:var(--morehouse-navy);font-weight:600}
        .submit-btn{background:linear-gradient(135deg,var(--morehouse-deep-pink),var(--morehouse-navy));color:white;padding:15px 40px;border:none;border-radius:50px;font-size:1.2rem;cursor:pointer;width:100%;margin-top:30px;font-weight:600;text-transform:uppercase;letter-spacing:1px;transition:all .3s;font-family:'Arial','Helvetica',sans-serif}
        .submit-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,107,157,.4)}
        .submit-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .loading-spinner{display:none;width:20px;height:20px;border:2px solid #fff;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .success-message{display:none;background:#d4edda;color:#155724;padding:20px;border-radius:10px;border:1px solid #c3e6cb;margin-top:20px;text-align:center}
        .error-message{display:none;background:#f8d7da;color:#721c24;padding:20px;border-radius:10px;border:1px solid #f5c6cb;margin-top:20px;text-align:center}
        .footer-text{text-align:center;margin-top:30px;font-size:.9rem;color:var(--morehouse-text);opacity:.8}
        .privacy-notice{background:var(--morehouse-light-grey);padding:15px;border-radius:8px;margin-top:20px;font-size:.85rem;color:var(--morehouse-text);border-left:3px solid var(--morehouse-navy)}
        @media (max-width:768px){.form-container{padding:30px 20px;margin:10px}h1{font-size:2rem}.subtitle{font-size:1rem}.form-row{grid-template-columns:1fr;gap:15px}.checkbox-group{grid-template-columns:1fr}.section-label{font-size:1.1rem}}
        /* Webhook configuration UI (hidden by default; enabled only in debug/local) */
        .webhook-config{background:var(--morehouse-light-grey);padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #ddd}
        .webhook-config label{font-size:.9rem;margin-bottom:5px}
        .webhook-config input{font-size:14px;padding:8px}
        .webhook-config-toggle{background:var(--morehouse-navy);color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-size:.8rem;margin-bottom:15px;display:none}
        .debug-info{background:#f8f9fa;padding:10px;border-radius:5px;margin-top:10px;font-size:12px;color:#666;border:1px solid #dee2e6}

        /* NEW: SIMPLIFIED Access Options Styles */
        .access-options {
            display: none;
            animation: slideUp 0.6s ease-out;
        }

        .access-options.show {
            display: block;
        }

        .access-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .access-header h2 {
            color: var(--morehouse-navy);
            margin-bottom: 15px;
            font-size: 2.2em;
            font-weight: 400;
        }

        .access-header p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 40px 0;
        }

        .option-card {
            padding: 30px 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .option-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--morehouse-deep-pink);
        }

        .online-option:hover {
            border-color: var(--morehouse-navy);
        }

        .option-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--morehouse-navy);
        }

        .option-description {
            font-size: 1em;
            color: #666;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .btn-access {
            display: inline-block;
            padding: 12px 30px;
            border: 2px solid var(--morehouse-navy);
            border-radius: 25px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            background: white;
            color: var(--morehouse-navy);
            width: 100%;
        }

        .btn-access:hover {
            background: var(--morehouse-navy);
            color: white;
            transform: translateY(-2px);
        }

        .offline-option .btn-access {
            border-color: var(--morehouse-deep-pink);
            color: var(--morehouse-deep-pink);
        }

        .offline-option .btn-access:hover {
            background: var(--morehouse-deep-pink);
            color: white;
        }

        .simple-tip {
            text-align: center;
            background: var(--morehouse-light-pink);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--morehouse-deep-pink);
            margin: 30px 0;
        }

        .simple-tip p {
            margin: 0;
            color: var(--morehouse-text);
            font-size: 0.95em;
            line-height: 1.5;
        }

        .back-btn {
            background: transparent;
            color: var(--morehouse-navy);
            border: 2px solid var(--morehouse-navy);
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }

        .back-btn:hover {
            background: var(--morehouse-navy);
            color: white;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .option-card {
                padding: 25px 20px;
            }
            
            .access-header h2 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <!-- ORIGINAL FORM SECTION -->
        <div id="formSection">
            <div class="school-logo">
                <img src="https://yt3.googleusercontent.com/_BXVh2JJHQb3ViHUH-hDR_G1YU44EFmu3JSbyhsj5Qmnfy-niQEoIjynQd4Voo8el0RjUm_wUDo=s160-c-k-c0x00ffffff-no-rj" alt="More House School Logo">
            </div>

            <h1>More House School</h1>
            <p class="subtitle">Create Your Personalised Prospectus</p>

            <div class="intro-text">
                <p><strong>Welcome to More House School's personalised prospectus experience.</strong> Please complete this form to receive a bespoke prospectus tailored to your daughter's interests and your family's priorities.</p>
            </div>

            <!-- Debug Information Panel -->
            <div class="debug-info" id="debugInfo">
                <strong>Connection Info:</strong><br>
                Current URL: <span id="currentUrl"></span><br>
                Webhook Target: <span id="webhookTarget"></span><br>
                Status: <span id="connectionStatus">Checking...</span>
            </div>

            <!-- Webhook Configuration (hidden except on localhost or with ?debug=1) -->
            <button type="button" class="webhook-config-toggle" id="webhookToggle">Webhook Configuration</button>
            <div class="webhook-config" id="webhookConfig" style="display:none;">
                <div class="form-group">
                    <label for="webhookUrl">Webhook URL (testing only)</label>
                    <input type="url" id="webhookUrl" value="" placeholder="https://your-service.onrender.com/webhook">
                </div>
            </div>

            <form id="inquiryForm">
                <span class="section-label">Family Information</span>
                
                <div class="form-group">
                    <label for="parentName">Parent/Guardian Name <span class="required">*</span></label>
                    <input type="text" id="parentName" required placeholder="e.g. Mrs Sarah Smith">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Daughter's First Name <span class="required">*</span></label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="familySurname">Family Surname <span class="required">*</span></label>
                        <input type="text" id="familySurname" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="parentEmail">Parent Email Address <span class="required">*</span></label>
                        <input type="email" id="parentEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="contactNumber">Contact Number <span class="required">*</span></label>
                        <input type="tel" id="contactNumber" required placeholder="e.g. 020 7235 2855">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ageGroup">Current Age Group <span class="required">*</span></label>
                        <select id="ageGroup" required>
                            <option value="">Select age group...</option>
                            <option value="9-11">Ages 9-11 (Years 5-6)</option>
                            <option value="11-16">Ages 11-16 (Years 7-11)</option>
                            <option value="16-18">Ages 16-18 (Sixth Form)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="entryYear">Planned Entry Year <span class="required">*</span></label>
                        <select id="entryYear" required>
                            <option value="">Select entry year...</option>
                            <option value="2025">September 2025</option>
                            <option value="2026">September 2026</option>
                            <option value="2027">September 2027</option>
                            <option value="2028">September 2028</option>
                            <option value="2029">September 2029</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="hearAboutUs">How did you hear about More House School? <span class="required">*</span></label>
                    <select id="hearAboutUs" required>
                        <option value="">Please select...</option>
                        <option value="current-school">Current School</option>
                        <option value="friend-family">Friend or Family</option>
                        <option value="google-search">Google or Search Engine</option>
                        <option value="publication">Publication</option>
                        <option value="social-media">Social Media</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <span class="section-label">Academic Interests</span>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="sciences"><label for="sciences">Sciences</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="mathematics"><label for="mathematics">Mathematics</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="english"><label for="english">English & Literature</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="languages"><label for="languages">Modern Languages</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="humanities"><label for="humanities">History & Geography</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="business"><label for="business">Business Studies</label></div>
                </div>

                <span class="section-label">Creative & Performance Interests</span>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="drama"><label for="drama">Drama & Theatre</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="music"><label for="music">Music & Singing</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="art"><label for="art">Art & Design</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="creative_writing"><label for="creative_writing">Creative Writing</label></div>
                </div>

                <span class="section-label">Co-curricular Interests</span>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="sport"><label for="sport">Sport & Physical Education</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="leadership"><label for="leadership">Leadership & Student Voice</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="community_service"><label for="community_service">Community Service</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="outdoor_education"><label for="outdoor_education">Outdoor Education</label></div>
                </div>

                <span class="section-label">What matters most to your family?</span>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="academic_excellence"><label for="academic_excellence">Academic Excellence</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pastoral_care"><label for="pastoral_care">Outstanding Pastoral Care</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="university_preparation"><label for="university_preparation">University Preparation</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="personal_development"><label for="personal_development">Personal Development</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="career_guidance"><label for="career_guidance">Career Guidance</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="extracurricular_opportunities"><label for="extracurricular_opportunities">Extracurricular Opportunities</label></div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="loading-spinner" id="loadingSpinner"></span>
                    <span id="submitText">Create My Personalised Prospectus</span>
                </button>
            </form>

            <div class="success-message" id="successMessage">
                <h3>Thank you for your enquiry!</h3>
                <p>Your personalised prospectus request has been submitted successfully.</p>
                <p id="prospectusLink"></p>
            </div>

            <div class="error-message" id="errorMessage">
                <h3>Submission Error</h3>
                <p id="errorText">There was an issue submitting your form. Please try again.</p>
            </div>

            <div class="privacy-notice">
                <strong>Privacy Notice:</strong> The information you provide will be used solely for creating your personalised prospectus and supporting your admissions journey.
            </div>

            <div class="footer-text">
                <p><strong>More House School</strong><br>22-24 Pont Street, Knightsbridge, London SW1X 0AA</p>
            </div>
        </div>

        <!-- SIMPLIFIED ACCESS OPTIONS SECTION -->
        <div id="accessOptions" class="access-options">
            <div class="school-logo">
                <img src="https://yt3.googleusercontent.com/_BXVh2JJHQb3ViHUH-hDR_G1YU44EFmu3JSbyhsj5Qmnfy-niQEoIjynQd4Voo8el0RjUm_wUDo=s160-c-k-c0x00ffffff-no-rj" alt="More House School Logo">
            </div>

            <div class="access-header">
                <h2>Your Prospectus is Ready!</h2>
                <p>Choose how you'd like to access your personalised prospectus:</p>
            </div>
            
            <div class="options-container">
                <div class="option-card online-option" onclick="viewOnlineProspectus()">
                    <div class="option-title">View Online</div>
                    <div class="option-description">
                        Interactive prospectus with videos and dynamic content
                    </div>
                    <a href="javascript:void(0)" class="btn-access" id="onlineBtn">
                        View Online Now
                    </a>
                </div>
                
                <div class="option-card offline-option" onclick="downloadOfflineProspectus()">
                    <div class="option-title">Download Offline</div>
                    <div class="option-description">
                        Complete prospectus file for offline viewing and printing
                    </div>
                    <a href="javascript:void(0)" class="btn-access" id="offlineBtn">
                        Download Offline
                    </a>
                </div>
            </div>
            
            <div class="simple-tip">
                <p><strong>Tip:</strong> You can use both options - view online for the full experience, then download for offline reference.</p>
            </div>

            <div style="text-align:center;margin-top:30px;">
                <button class="back-btn" onclick="showFormSection()">Create Another Prospectus</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store prospectus data
        let currentProspectusData = null;

        // --- EXISTING WEBHOOK CONFIGURATION (unchanged) ---
        function getWebhookUrl() {
            const currentHost = window.location.hostname;
            
            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                return 'http://localhost:3000/webhook';
            }
            
            const RENDER_URL = 'https://more-house-personalised-prospectus.onrender.com';
            
            if (window.location.origin.includes('onrender.com')) {
                return `${window.location.origin}/webhook`;
            }
            
            return `${RENDER_URL}/webhook`;
        }

        // Webhook visibility and configuration
        const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const debugParam = /[?&](debug|showWebhook)=1/.test(location.search);
        const showWebhookUI = isLocalhost || debugParam;

        const webhookToggle = document.getElementById('webhookToggle');
        const webhookConfig = document.getElementById('webhookConfig');
        const webhookUrlInput = document.getElementById('webhookUrl');

        // Set up debug information
        const currentUrlSpan = document.getElementById('currentUrl');
        const webhookTargetSpan = document.getElementById('webhookTarget');
        const connectionStatusSpan = document.getElementById('connectionStatus');
        
        currentUrlSpan.textContent = window.location.href;
        const webhookUrl = getWebhookUrl();
        webhookTargetSpan.textContent = webhookUrl;

        if (showWebhookUI) {
            webhookToggle.style.display = 'inline-block';
            webhookUrlInput.value = webhookUrl;
            webhookToggle.addEventListener('click', () => {
                webhookConfig.style.display = webhookConfig.style.display === 'none' ? 'block' : 'none';
            });
        } else {
            webhookToggle.style.display = 'none';
            webhookConfig.style.display = 'none';
        }

        // Test webhook connectivity on page load
        async function testWebhookConnectivity() {
            try {
                connectionStatusSpan.textContent = 'Testing connection...';
                const testUrl = webhookUrl.replace('/webhook', '/health');
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'cors',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    connectionStatusSpan.textContent = 'Connected';
                    connectionStatusSpan.style.color = '#28a745';
                } else {
                    connectionStatusSpan.textContent = `Server responded with ${response.status}`;
                    connectionStatusSpan.style.color = '#ffc107';
                }
            } catch (error) {
                connectionStatusSpan.textContent = `Connection failed: ${error.message}`;
                connectionStatusSpan.style.color = '#dc3545';
                console.error('Webhook connectivity test failed:', error);
            }
        }

        testWebhookConnectivity();

        // --- NEW: ACCESS OPTIONS FUNCTIONS ---
        function showAccessOptions(prospectusData) {
            currentProspectusData = prospectusData;
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('accessOptions').classList.add('show');
        }

        function showFormSection() {
            document.getElementById('accessOptions').classList.remove('show');
            document.getElementById('formSection').style.display = 'block';
            currentProspectusData = null;
        }

        function viewOnlineProspectus() {
            if (!currentProspectusData) return;
            
            const onlineBtn = document.getElementById('onlineBtn');
            onlineBtn.innerHTML = 'Loading...';
            
            // Open online version
            if (currentProspectusData.slug) {
                window.open(`/${currentProspectusData.slug}`, '_blank');
            } else if (currentProspectusData.prospectus && currentProspectusData.prospectus.url) {
                window.open(currentProspectusData.prospectus.url, '_blank');
            }
            
            setTimeout(() => {
                onlineBtn.innerHTML = 'View Online Now';
            }, 2000);
        }

        function downloadOfflineProspectus() {
            if (!currentProspectusData) return;
            
            const offlineBtn = document.getElementById('offlineBtn');
            offlineBtn.innerHTML = 'Preparing Download...';
            
            // Create download link
            let downloadUrl;
            if (currentProspectusData.slug) {
                downloadUrl = `/download/${currentProspectusData.slug}`;
            } else if (currentProspectusData.id) {
                downloadUrl = `/api/download/${currentProspectusData.id}`;
            }
            
            if (downloadUrl) {
                const link = document.createElement('a');
                link.href = downloadUrl;
                const firstName = currentProspectusData.firstName || 'Student';
                const surname = currentProspectusData.familySurname || 'Family';
                const year = currentProspectusData.entryYear || '2025';
                link.download = `${firstName}-${surname}-Prospectus-${year}-OFFLINE.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            setTimeout(() => {
                offlineBtn.innerHTML = 'Download Offline';
            }, 3000);
        }

        // --- ENHANCED FORM SUBMISSION HANDLER ---
        document.getElementById('inquiryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const submitText = document.getElementById('submitText');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            submitBtn.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            submitText.textContent = 'Creating Your Prospectus...';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                // Collect form data (unchanged)
                const formData = {
                    parentName: document.getElementById('parentName').value.trim(),
                    firstName: document.getElementById('firstName').value.trim(),
                    familySurname: document.getElementById('familySurname').value.trim(),
                    parentEmail: document.getElementById('parentEmail').value.trim(),
                    contactNumber: document.getElementById('contactNumber').value.trim(),
                    ageGroup: document.getElementById('ageGroup').value,
                    entryYear: document.getElementById('entryYear').value,
                    hearAboutUs: document.getElementById('hearAboutUs').value,
                    sciences: document.getElementById('sciences').checked,
                    mathematics: document.getElementById('mathematics').checked,
                    english: document.getElementById('english').checked,
                    languages: document.getElementById('languages').checked,
                    humanities: document.getElementById('humanities').checked,
                    business: document.getElementById('business').checked,
                    drama: document.getElementById('drama').checked,
                    music: document.getElementById('music').checked,
                    art: document.getElementById('art').checked,
                    creative_writing: document.getElementById('creative_writing').checked,
                    sport: document.getElementById('sport').checked,
                    leadership: document.getElementById('leadership').checked,
                    community_service: document.getElementById('community_service').checked,
                    outdoor_education: document.getElementById('outdoor_education').checked,
                    academic_excellence: document.getElementById('academic_excellence').checked,
                    pastoral_care: document.getElementById('pastoral_care').checked,
                    university_preparation: document.getElementById('university_preparation').checked,
                    personal_development: document.getElementById('personal_development').checked,
                    career_guidance: document.getElementById('career_guidance').checked,
                    extracurricular_opportunities: document.getElementById('extracurricular_opportunities').checked,
                    submissionTimestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    referrer: document.referrer || 'direct'
                };

                console.log('Form data collected:', formData);

                const finalWebhookUrl = (showWebhookUI && webhookUrlInput.value) ? 
                    webhookUrlInput.value : webhookUrl;

                console.log('Submitting to:', finalWebhookUrl);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(finalWebhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    mode: 'cors',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }

                const result = await response.json();
                console.log('Webhook response:', result);

                // Reset form
                document.getElementById('inquiryForm').reset();

                // Show access options instead of just success message
                showAccessOptions(result);

            } catch (error) {
                console.error('Form submission error:', error);
                
                let errorMsg = 'There was an issue submitting your form. Please try again.';
                
                if (error.name === 'AbortError') {
                    errorMsg = 'Request timed out. Please check your connection and try again.';
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'Connection blocked by security policy. Please contact support.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Unable to connect to server. Please check your internet connection.';
                } else {
                    errorMsg = `Error: ${error.message}`;
                }
                
                document.getElementById('errorText').textContent = errorMsg;
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({ behavior: 'smooth' });
            } finally {
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                submitText.textContent = 'Create My Personalised Prospectus';
            }
        });

        // --- EXISTING FORM FUNCTIONALITY (unchanged) ---
        document.querySelectorAll('.checkbox-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const cb = this.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const requiredFields = document.querySelectorAll('input[required], select[required]');
            requiredFields.forEach(field => {
                field.addEventListener('blur', function() {
                    this.style.borderColor = this.value.trim() ? '#28a745' : '#dc3545';
                });
                field.addEventListener('input', function() {
                    if (this.value.trim()) this.style.borderColor = '#28a745';
                });
            });
            
            const emailField = document.getElementById('parentEmail');
            emailField.addEventListener('blur', function() {
                const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value);
                this.style.borderColor = this.value && !ok ? '#dc3545' : (this.value ? '#28a745' : '#ddd');
            });

            const phoneField = document.getElementById('contactNumber');
            phoneField.addEventListener('blur', function() {
                const ok = /^[\d\s\+\-\(\)]{10,}$/.test(this.value);
                this.style.borderColor = this.value && !ok ? '#dc3545' : (this.value ? '#28a745' : '#ddd');
            });
        });
    </script>
</body>
</html>