<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admissions Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0e1116; --card:#161a22; --ink:#e6e8ef; --muted:#aab2c5; --accent:#6ea8fe; --good:#49c774; --warn:#f5b759; --bad:#ff7d7d; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    header{padding:20px 24px;border-bottom:1px solid #232938;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px;letter-spacing:.2px}
    .wrap{padding:20px;max-width:1200px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .card{background:var(--card);border:1px solid #232938;border-radius:10px;padding:16px}
    .stat{display:flex;flex-direction:column;gap:6px}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat .value{font-weight:700;font-size:26px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px 8px;border-bottom:1px solid #252b3a;font-size:13px}
    th{color:#cbd3e5;text-align:left}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#24304b;color:#cfe0ff;border:1px solid #2d3b5b;font-size:12px}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .footer{margin-top:16px;color:var(--muted);font-size:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} .row{grid-template-columns:1fr} }
    @media (max-width: 520px){ .grid{grid-template-columns:1fr} }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <h1>Admissions Dashboard</h1>
    <div class="muted" id="lastUpdated">Loading…</div>
  </header>

  <div class="wrap">
    <!-- Top stats -->
    <div class="grid" id="topStats">
      <div class="card stat"><div class="label">Ready for Contact</div><div class="value" id="statReady">0</div></div>
      <div class="card stat"><div class="label">Highly Engaged</div><div class="value" id="statEngaged">0</div></div>
      <div class="card stat"><div class="label">New Inquiries (7d)</div><div class="value" id="statNew">0</div></div>
      <div class="card stat"><div class="label">Total Families</div><div class="value" id="statTotal">0</div></div>
    </div>

    <!-- Two columns -->
    <div class="row">
      <div class="card">
        <h3 style="margin:0 0 10px 0;">Priority Families</h3>
        <table id="tblPriority">
          <thead><tr><th>Name</th><th>Age Group</th><th>Entry Year</th><th class="right">Engagement</th></tr></thead>
          <tbody><tr><td class="muted" colspan="4">Loading…</td></tr></tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px 0;">Recently Active</h3>
        <table id="tblRecent">
          <thead><tr><th>Name</th><th>Activity</th><th>When</th><th class="right">Score</th></tr></thead>
          <tbody><tr><td class="muted" colspan="4">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin:0 0 10px 0;">Top Interests (from inquiries)</h3>
      <table id="tblInterests">
        <thead><tr><th>Subject</th><th class="right">Count</th></tr></thead>
        <tbody><tr><td class="muted" colspan="2">Loading…</td></tr></tbody>
      </table>
      <div class="footer">Data source: <code>GET /api/dashboard-data</code></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin:0 0 10px 0;">Raw Inquiries (for debugging)</h3>
      <table id="tblInquiries">
        <thead>
          <tr>
            <th>Family</th><th>Email</th><th>Age Group</th><th>Entry Year</th><th>Status</th><th>Received</th>
          </tr>
        </thead>
        <tbody><tr><td class="muted" colspan="6">Loading…</td></tr></tbody>
      </table>
      <div class="footer">From <code>GET /api/analytics/inquiries</code></div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      function fmtDate(s) {
        if (!s) return '—';
        try { return new Date(s).toLocaleString(); } catch (_) { return s; }
      }
      function el(id){ return document.getElementById(id); }
      function setText(id, val){ var n = el(id); if(n) n.textContent = val; }

      async function fetchJSON(url){
        const r = await fetch(url, { headers: { 'Cache-Control':'no-cache' }});
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      }

      function renderTable(tbody, rowsHtml) {
        tbody.innerHTML = rowsHtml || '<tr><td class="muted" colspan="99">No data</td></tr>';
      }

      async function loadDashboard() {
        try {
          const data = await fetchJSON('/api/dashboard-data');

          // Top stats
          setText('statReady', data.metrics.readyForContact);
          setText('statEngaged', data.metrics.highlyEngaged);
          setText('statNew', data.metrics.newInquiries);
          setText('statTotal', data.metrics.totalFamilies);
          el('lastUpdated').textContent = 'Updated: ' + fmtDate(data.lastUpdated);

          // Priority families
          (function(){
            const tb = document.querySelector('#tblPriority tbody');
            if (!data.priorityFamilies || !data.priorityFamilies.length) {
              return renderTable(tb);
            }
            const rows = data.priorityFamilies.map(function(p){
              return '<tr>' +
                '<td>'+escapeHtml(p.name || "—")+'</td>' +
                '<td>'+escapeHtml(p.ageGroup || "—")+'</td>' +
                '<td>'+escapeHtml(p.entryYear || "—")+'</td>' +
                '<td class="right"><span class="pill">'+(p.engagementScore||0)+'/100</span></td>' +
              '</tr>';
            }).join('');
            renderTable(tb, rows);
          })();

          // Recently active
          (function(){
            const tb = document.querySelector('#tblRecent tbody');
            if (!data.recentlyActive || !data.recentlyActive.length) {
              return renderTable(tb);
            }
            const rows = data.recentlyActive.map(function(r){
              return '<tr>' +
                '<td>'+escapeHtml(r.name || "—")+'</td>' +
                '<td>'+escapeHtml(r.activity || "—")+'</td>' +
                '<td>'+fmtDate(r.timestamp)+'</td>' +
                '<td class="right"><span class="pill">'+(r.engagementScore||0)+'/100</span></td>' +
              '</tr>';
            }).join('');
            renderTable(tb, rows);
          })();

          // Interests
          (function(){
            const tb = document.querySelector('#tblInterests tbody');
            if (!data.analytics || !data.analytics.topInterests || !data.analytics.topInterests.length) {
              return renderTable(tb);
            }
            const rows = data.analytics.topInterests.map(function(t){
              return '<tr><td>'+escapeHtml(t.subject)+'</td><td class="right">'+Number(t.count||0)+'</td></tr>';
            }).join('');
            renderTable(tb, rows);
          })();

        } catch (e) {
          console.error('Dashboard load failed:', e);
          el('lastUpdated').textContent = 'Failed to load';
        }

        // Also load raw inquiries list (separate endpoint in case we want different caching)
        try {
          const inquiries = await fetchJSON('/api/analytics/inquiries');
          const tb = document.querySelector('#tblInquiries tbody');
          if (!inquiries || !inquiries.length) { return renderTable(tb); }
          const rows = inquiries.map(function(i){
            const fam = [i.first_name, i.family_surname].filter(Boolean).join(' ');
            return '<tr>' +
              '<td>'+escapeHtml(fam || "—")+'</td>' +
              '<td>'+escapeHtml(i.parent_email || "—")+'</td>' +
              '<td>'+escapeHtml(i.age_group || "—")+'</td>' +
              '<td>'+escapeHtml(i.entry_year || "—")+'</td>' +
              '<td>'+escapeHtml(i.status || "—")+'</td>' +
              '<td>'+fmtDate(i.received_at)+'</td>' +
            '</tr>';
          }).join('');
          renderTable(tb, rows);
        } catch (e) {
          console.error('Inquiries load failed:', e);
        }
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, function (m) {
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
        });
      }

      // Auto-refresh every 30s
      loadDashboard();
      setInterval(loadDashboard, 30000);
    })();
  </script>
</body>
</html>
