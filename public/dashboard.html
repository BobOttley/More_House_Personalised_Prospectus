<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>More House Analytics - Admissions Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Brand palette */
      --blazer-navy:#091825; --award-gold:#FF9F1C; --sport-blue:#034674;
      --text-primary:#2C3E50; --white:#FFFFFF; --light-grey:#F8FAFC; --border-grey:#E5E7EB;
      --success:#10B981; --warning:#F59E0B; --error:#EF4444;

      /* Team rating colours */
      --rate-high:#0F766E;   /* teal */
      --rate-medium:#B45309; /* amber-brown */
      --rate-low:#374151;    /* slate */
      --rate-unrated:#6B7280;

      --font-heading:'Playfair Display',serif;
      --font-body:'Inter',sans-serif
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:var(--font-body);
      background:linear-gradient(135deg,var(--light-grey) 0%,#f1f5f9 100%);
      min-height:100vh;color:var(--text-primary);font-size:14px
    }

    /* Header */
    .header{
      background:linear-gradient(135deg,#091825 0%,#034674 100%);
      color:#fff;padding:2rem;box-shadow:0 4px 20px rgba(9,24,37,.3);
      text-align:center;position:relative
    }
    .refresh-btn{
      position:absolute;top:2rem;right:2rem;background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2);color:#fff;padding:.5rem 1rem;border-radius:8px;
      cursor:pointer;transition:.3s;font-size:.9rem
    }
    .refresh-btn:hover{background:rgba(255,255,255,.2)}
    .header-brand{display:inline-block;position:relative}
    .brand-glow{position:absolute;inset:0;border-radius:50%;
      background:linear-gradient(135deg,var(--award-gold),#FFB84D);opacity:.3;filter:blur(20px)}
    .header h1{position:relative;font-family:var(--font-heading);font-size:3.25rem;font-weight:700;margin-bottom:.75rem}
    .smart-text{background:linear-gradient(135deg,var(--award-gold),#FFB84D);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .analytics-text{color:#fff}
    .header p{font-size:1.05rem;font-weight:300;color:rgba(255,255,255,.9)}

    .dashboard{max-width:1400px;margin:-2rem auto 2rem;position:relative;z-index:10}

    /* Metrics */
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.25rem;padding:1.5rem}
    .metric-card{background:#fff;border-radius:16px;padding:1.25rem;box-shadow:0 4px 16px rgba(9,24,37,.08);border:1px solid var(--border-grey);position:relative;overflow:hidden}
    .metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--award-gold),var(--sport-blue))}
    .metric-header{display:flex;align-items:center;gap:1rem;margin-bottom:.75rem}
    .metric-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.25rem;background:var(--sport-blue)}
    .metric-title{font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#64748b;margin-bottom:.25rem}
    .metric-value{font-size:2rem;font-weight:700;color:var(--blazer-navy);font-family:var(--font-heading)}
    .metric-subtitle{font-size:.8rem;color:#64748b}

    /* Panels */
    .main-content{display:grid;grid-template-columns:2fr 1fr;gap:1.75rem;padding:0 1rem}
    .panel{background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.08);overflow:hidden;border:1px solid #e5e7f0}
    .panel-header{background:#034674;color:#fff;padding:1rem 1.25rem;font-weight:600;display:flex;align-items:center;justify-content:space-between}
    .panel-content{padding:1.25rem}
    .filters{background:#fff;padding:.75rem 1.25rem;border-bottom:1px solid #e2e8f0;display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .filter-select,.search-box{padding:.5rem;border:1px solid #d1d5db;border-radius:6px;font-size:.9rem}
    .search-box{flex:1;min-width:220px}

    /* Family cards */
    .family-card{border:1px solid #e2e8f0;border-radius:8px;margin-bottom:1rem;overflow:hidden;background:#fff}
    .family-header{padding:1rem;display:flex;justify-content:space-between;align-items:center;background:#f8fafc}
    .family-header:hover{background:#f1f5f9}
    .family-info h3{font-size:1rem;font-weight:700;margin-bottom:.25rem}
    .family-meta{font-size:.9rem;color:#64748b}
    .family-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
    .btn{padding:.45rem .65rem;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer;font-size:.85rem}
    .btn.primary{background:#034674;border-color:#034674;color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .expand-icon{transition:transform .2s}
    .family-card.expanded .expand-icon{transform:rotate(180deg)}
    .family-details{padding:1rem;border-top:1px solid #e2e8f0;display:none;background:#fff}
    .family-card.expanded .family-details{display:block}

    /* Team rating */
    .rating-wrap{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .rating-label{font-size:.8rem;color:#64748b}
    .rate-pill{
      border:1px solid #d1d5db;border-radius:999px;padding:.25rem .6rem;font-size:.8rem;cursor:pointer;background:#fff
    }
    .rate-pill.active{color:#fff;border-color:transparent}
    .rate-high.active{background:var(--rate-high)}
    .rate-medium.active{background:var(--rate-medium)}
    .rate-low.active{background:var(--rate-low)}
    .rate-unrated.active{background:var(--rate-unrated)}

    /* Notes */
    .notes-wrap{margin-top:.75rem}
    .notes-wrap textarea{
      width:100%;min-height:70px;border:1px solid #d1d5db;border-radius:6px;padding:.5rem;font-size:.9rem
    }

    /* Timeline & sessions (kept, but tidied) */
    .timeline{margin-top:.75rem;padding:.75rem;background:#F8FAFC;border:1px solid #E5E7EB;border-radius:6px}
    .timeline-meta{font-size:.9rem;color:#334155;margin-bottom:.5rem}
    .timeline-list{margin:0;padding-left:18px}

    .sessions{margin-top:.75rem;padding:.75rem;background:#FFF;border:1px solid #E5E7EB;border-radius:6px}
    .session-item{border:1px solid #E5E7EB;border-radius:6px;margin:.5rem 0}
    .session-header{padding:.5rem .75rem;background:#F8FAFC;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .session-body{padding:.5rem .75rem;display:none}
    .session-item.open .session-body{display:block}

    /* Latest Visit quick viewer */
    #latest-visit{max-width:1400px;margin:16px auto 0;padding:12px;border:1px solid #E5E7EB;border-radius:8px;background:#F8FAFC}

    /* Misc */
    .loading{display:flex;align-items:center;justify-content:center;padding:2rem;color:#64748b}
    .spinner{width:16px;height:16px;border:2px solid #e2e8f0;border-top:2px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin-right:.5rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:1rem;border-radius:6px;margin:1rem 0}
    .no-data{text-align:center;color:#64748b;padding:2rem}

    /* Small, accessible badges for counts */
    .count-dot{display:inline-block;min-width:22px;padding:.05rem .4rem;border-radius:999px;background:#e5e7eb;text-align:center;font-size:.75rem;margin-left:.4rem}

    @media (max-width:900px){.main-content{grid-template-columns:1fr}}
    @media (max-width:768px){.metrics{grid-template-columns:repeat(auto-fit,minmax(170px,1fr))}}
  </style>
</head>
<body>
  <header class="header">
    <button class="refresh-btn" onclick="loadData(true)">â†» Refresh</button>
    <div class="header-brand">
      <div class="brand-glow"></div>
      <h1><span class="smart-text">SMART</span> <span class="analytics-text">Analytics</span></h1>
    </div>
    <p>More House School</p>
    <div style="font-size:.9rem;color:rgba(255,255,255,.7);margin-top:.35rem;">Real-time family engagement tracking, team-rated pipeline</div>
  </header>

  <!-- Latest Visit Timeline (paste an Inquiry ID) -->
  <div id="latest-visit">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <strong>Latest Visit Timeline</strong>
      <input id="lv-inquiry" type="text" placeholder="Paste Inquiry ID e.g. INQ-1756â€¦" style="flex:1;min-width:260px;padding:8px;border:1px solid #E5E7EB;border-radius:6px;">
      <button id="lv-load" class="btn primary">Load</button>
    </div>
    <div id="lv-meta" class="timeline-meta"></div>
    <ol id="lv-list" class="timeline-list"></ol>
  </div>

  <div class="dashboard">
    <!-- Team-rated metrics (no system 'hot/warm') -->
    <div class="metrics">
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
          <div>
            <div class="metric-title">Total Families</div>
            <div class="metric-value" id="totalFamilies">-</div>
            <div class="metric-subtitle">Active prospects</div>
          </div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-icon" style="background:var(--rate-high)">â–²</div>
          <div>
            <div class="metric-title">Team-Rated High</div>
            <div class="metric-value" id="ratedHigh">-</div>
            <div class="metric-subtitle">Set by admissions</div>
          </div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-icon" style="background:var(--rate-medium)">â—¼</div>
          <div>
            <div class="metric-title">Team-Rated Medium</div>
            <div class="metric-value" id="ratedMedium">-</div>
            <div class="metric-subtitle">Set by admissions</div>
          </div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-icon" style="background:var(--rate-low)">â–¼</div>
          <div>
            <div class="metric-title">Team-Rated Low</div>
            <div class="metric-value" id="ratedLow">-</div>
            <div class="metric-subtitle">Set by admissions</div>
          </div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-icon" style="background:var(--rate-unrated)">â€¢</div>
          <div>
            <div class="metric-title">Unrated</div>
            <div class="metric-value" id="ratedUnrated">-</div>
            <div class="metric-subtitle">Needs review</div>
          </div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-icon" style="background:linear-gradient(135deg,var(--success),#34d399)">ğŸ“Š</div>
          <div>
            <div class="metric-title">Active Today</div>
            <div class="metric-value" id="activeToday">-</div>
            <div class="metric-subtitle">Recent engagement</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <!-- Families -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Family Prospects</h2>
            <div style="font-size:.9rem;opacity:.9;margin-top:.25rem;">Admissions set lead quality; the system never auto-labels it</div>
          </div>
        </div>
        <div class="filters">
          <select class="filter-select" id="sortFilter">
            <option value="recent">Sort by Recent Activity</option>
            <option value="time">Sort by Time Spent</option>
            <option value="visits">Sort by Return Visits</option>
          </select>
          <select class="filter-select" id="ratingFilter">
            <option value="all">All Ratings</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
            <option value="unrated">Unrated</option>
          </select>
          <input type="text" class="search-box" placeholder="Search familiesâ€¦" id="searchBox">
        </div>
        <div class="panel-content">
          <div id="familyList">
            <div class="loading"><div class="spinner"></div> Loading familiesâ€¦</div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="panel">
        <div class="panel-header"><h2>Recent Activity</h2></div>
        <div class="panel-content">
          <div id="activityFeed">
            <div class="loading"><div class="spinner"></div> Loading activityâ€¦</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Core Logic -->
  <script>
    'use strict';

    let allFamilies = [];      // shaped records
    let rawFamilies = [];      // raw payload for reference
    let isLoading = false;

    // Helpers
    const byId = id => document.getElementById(id);
    const setText = (id, v) => { const el = byId(id); if (el) el.textContent = String(v); };
    const fetchJson = async (url, opts) => {
      const u = opts ? url : url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const res = await fetch(u, opts || { cache:'no-store' });
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
      return res.json();
    };
    const formatTimeAgo = (date) => {
      const now = new Date(), diff = now - date;
      const m = Math.floor(diff/60000), h = Math.floor(diff/3600000), d = Math.floor(diff/86400000);
      if (m < 1) return 'Just now';
      if (m < 60) return `${m}m ago`;
      if (h < 24) return `${h}h ago`;
      if (d < 7) return `${d}d ago`;
      return date.toLocaleDateString();
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Data load & shaping
    // Expect /api/analytics/inquiries to include team_rating & notes if available
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadData(){
      if (isLoading) return; isLoading = true;
      try {
        const data = await fetchJson('/api/analytics/inquiries');
        rawFamilies = Array.isArray(data) ? data : [];
        allFamilies = shapeFamilies(rawFamilies);
        updateMetrics();
        renderFamilies();
        loadRecentActivity();
      } catch (e) {
        showError('Failed to load data: ' + e.message);
        console.error('loadData:', e);
      } finally {
        isLoading = false;
      }
    }

    function shapeFamilies(raw){
      return raw.map(f => {
        const dwellMs = Number(f.dwell_ms) || 0;
        const minutes = Math.max(0, Math.round(dwellMs/60000));
        const visits  = Math.max(0, Number(f.return_visits) || 0);
        const last    = f.updated_at || f.received_at || null;

        // Admissions-owned rating & notes (never inferred by system)
        const teamRating = (f.team_rating || '').toLowerCase(); // 'high'|'medium'|'low'|'' (unrated)
        const notes = f.team_notes || '';

        const isActiveToday = !!(last && (Date.now() - new Date(last).getTime()) <= 86400000);

        return {
          id: f.id,
          name: `${f.first_name || ''} ${f.family_surname || ''}`.trim(),
          firstName: f.first_name || '',
          familySurname: f.family_surname || '',
          parentEmail: f.parent_email || '',
          entryYear: f.entry_year,
          ageGroup: f.age_group,
          receivedAt: f.received_at,
          lastActivity: last,
          timeOnPageMs: dwellMs,
          timeOnPageMinutes: minutes,
          visits,
          isActiveToday,
          hasProspectus: !!f.prospectus_generated,
          prospectusUrl: f.prospectus_pretty_url || null,
          city: f.city || 'Unknown',
          country: f.country || 'Unknown',
          teamRating: ['high','medium','low'].includes(teamRating) ? teamRating : 'unrated',
          teamNotes: notes
        };
      }).filter(x => x.name.length);
    }

    function updateMetrics(){
      setText('totalFamilies', allFamilies.length);
      setText('ratedHigh',     allFamilies.filter(f=>f.teamRating==='high').length);
      setText('ratedMedium',   allFamilies.filter(f=>f.teamRating==='medium').length);
      setText('ratedLow',      allFamilies.filter(f=>f.teamRating==='low').length);
      setText('ratedUnrated',  allFamilies.filter(f=>f.teamRating==='unrated').length);
      setText('activeToday',   allFamilies.filter(f=>f.isActiveToday).length);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Rendering
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFamilies(){
      const container = byId('familyList');
      let list = filterAndSortFamilies();

      if (!allFamilies.length) { container.innerHTML = '<div class="no-data">No data yet</div>'; return; }
      if (!list.length) { container.innerHTML = '<div class="no-data">No families found for current filters</div>'; return; }

      container.innerHTML = list.map(f => {
        const openBtn = f.prospectusUrl
          ? `<button class="btn primary" onclick="openProspectus('${encodeURI(f.prospectusUrl)}')">Open Prospectus</button>`
          : `<button class="btn" disabled title="No prospectus URL">Open Prospectus</button>`;

        const ratingPills = renderRatingPills(f.id, f.teamRating);

        return `
          <div class="family-card" data-id="${f.id}">
            <div class="family-header">
              <div class="family-info" onclick="toggleFamily('${f.id}')" style="cursor:pointer;">
                <h3>${f.name} Family</h3>
                <div class="family-meta">
                  Entry ${f.entryYear || 'TBC'} â€¢ ${f.timeOnPageMinutes} min â€¢ ${f.visits} visit${f.visits===1?'':'s'} â€¢ ${f.city}
                  <span class="count-dot" title="Team rating">${f.teamRating}</span>
                </div>
              </div>
              <div class="expand-icon">â–¼</div>
            </div>

            <div class="family-details">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:.75rem;">
                <div>
                  <strong>Contact Info</strong><br>
                  Email: ${f.parentEmail || 'Unknown'}<br>
                  Age Group: ${f.ageGroup || 'Unknown'}<br>
                  Entry Year: ${f.entryYear || 'TBC'}<br>
                  ${f.isActiveToday ? 'ğŸŸ¢ Active today' : 'âš« Not active today'}
                </div>
                <div>
                  <strong>Team Rating</strong>
                  <div class="rating-wrap" style="margin-top:.5rem;">
                    ${ratingPills}
                    <span class="rating-label">(Set by admissions)</span>
                  </div>
                </div>
              </div>

              <div class="family-actions">
                ${openBtn}
                <button class="btn" onclick="copyInquiryId('${f.id}')">Copy Inquiry ID</button>
                <button class="btn" onclick="loadCardTimeline('${f.id}')">Load Timeline (latest)</button>
                <button class="btn" onclick="loadSessionHistory('${f.id}')">Load Sessions (history)</button>
                ${f.parentEmail ? `<a class="btn" href="mailto:${encodeURIComponent(f.parentEmail)}" target="_blank">Email Parent</a>` : ''}
              </div>

              <div class="notes-wrap">
                <label for="notes-${f.id}" style="display:block;font-weight:600;margin-bottom:.25rem;">Notes (visible to admissions team)</label>
                <textarea id="notes-${f.id}" placeholder="e.g. Interested in Senior entry; loved Creative Arts." onblur="saveNotes('${f.id}')">${escapeHtml(f.teamNotes||'')}</textarea>
              </div>

              <div id="timeline-${f.id}" class="timeline" style="display:none;">
                <div class="timeline-meta" id="timeline-meta-${f.id}"></div>
                <ol class="timeline-list" id="timeline-list-${f.id}"></ol>
              </div>

              <div id="sessions-${f.id}" class="sessions" style="display:none;">
                <div class="timeline-meta" id="sessions-meta-${f.id}">Loading sessionsâ€¦</div>
                <div id="sessions-list-${f.id}"></div>
              </div>

              ${f.prospectusUrl ? `
                <div style="margin-top:.75rem;">
                  <a href="${f.prospectusUrl}" target="_blank" style="color:#3b82f6;text-decoration:none;">View Prospectus in new tab</a>
                </div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function filterAndSortFamilies(){
      let families = [...allFamilies];

      const rf = (byId('ratingFilter')?.value || 'all');
      if (rf !== 'all') families = families.filter(f => f.teamRating === rf);

      const q = (byId('searchBox')?.value || '').toLowerCase();
      if (q) {
        families = families.filter(f =>
          f.name.toLowerCase().includes(q) ||
          (f.parentEmail||'').toLowerCase().includes(q) ||
          (f.city||'').toLowerCase().includes(q)
        );
      }

      const sortBy = byId('sortFilter')?.value || 'recent';
      if (sortBy==='recent') families.sort((a,b)=>new Date(b.lastActivity||0)-new Date(a.lastActivity||0));
      else if (sortBy==='time') families.sort((a,b)=>b.timeOnPageMs-a.timeOnPageMs);
      else if (sortBy==='visits') families.sort((a,b)=>b.visits-a.visits);

      return families;
    }

    function renderRatingPills(id, current){
      const mk = (key,label,cls) => {
        const active = current===key ? 'active' : '';
        return `<button class="rate-pill rate-${key} ${cls} ${active}" onclick="setTeamRating('${id}','${key}',this)">${label}</button>`;
      };
      return [
        mk('high','High','rate-high'),
        mk('medium','Medium','rate-medium'),
        mk('low','Low','rate-low'),
        mk('unrated','Unrated','rate-unrated')
      ].join('');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Actions
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleFamily(id){
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) card.classList.toggle('expanded');
    }
    function openProspectus(url){ try { window.open(url,'_blank'); } catch(e){ console.error(e); } }
    function copyInquiryId(id){ navigator.clipboard.writeText(id).catch(()=>{}); }

    // Persist rating (team-owned)
    async function setTeamRating(inquiryId, rating, el){
      try{
        // Update UI instantly
        const wrap = el.parentElement;
        [...wrap.querySelectorAll('.rate-pill')].forEach(b=>b.classList.remove('active'));
        el.classList.add('active');

        // Update local state
        const i = allFamilies.findIndex(f=>f.id===inquiryId);
        if (i>=0){ allFamilies[i].teamRating = rating; updateMetrics(); }

        // Send to backend (adjust endpoint if needed)
        await fetchJson(`/api/inquiries/${encodeURIComponent(inquiryId)}/rating`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ rating })
        });

        // Refresh counts without reloading list
        updateMetrics();
      }catch(e){
        console.error('setTeamRating error:', e);
        alert('Could not save rating. Please try again.');
      }
    }

    // Persist notes
    async function saveNotes(inquiryId){
      const ta = byId(`notes-${inquiryId}`); if (!ta) return;
      const notes = ta.value || '';
      try{
        await fetchJson(`/api/inquiries/${encodeURIComponent(inquiryId)}/notes`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ notes })
        });
      }catch(e){
        console.error('saveNotes error:', e);
      }
    }

    // Existing visit loaders (kept from your file, lightly adapted)
    async function fetchLatestVisit(inquiryId){
      if (!inquiryId) return null;
      try { return await fetchJson(`/api/visits/${encodeURIComponent(inquiryId)}/latest`); }
      catch (e) { console.error('fetchLatestVisit:', e); return null; }
    }
    async function fetchVisitHistory(inquiryId){
      const endpoints = [
        `/api/visits/${encodeURIComponent(inquiryId)}/history`,
        `/api/visits/${encodeURIComponent(inquiryId)}/sessions`,
        `/api/visits/${encodeURIComponent(inquiryId)}?limit=20`
      ];
      const attempts = [];
      for (const url of endpoints){
        try{
          const data = await fetchJson(url);
          if (Array.isArray(data) && data.length) return { sessions: data };
          if (data && Array.isArray(data.sessions) && data.sessions.length) return { sessions: data.sessions };
        }catch(e){ attempts.push(url + ' â†’ ' + e.message); }
      }
      return null;
    }
    async function fetchSessionEvents(sessionId, inquiryId){
      const urls = [
        `/api/visits/session/${encodeURIComponent(sessionId)}`,
        `/api/visits/session/${encodeURIComponent(sessionId)}/events`,
        `/api/visits/sessions/${encodeURIComponent(sessionId)}`,
        `/api/sessions/${encodeURIComponent(sessionId)}`,
        `/api/session/${encodeURIComponent(sessionId)}`,
        `/api/visit/${encodeURIComponent(sessionId)}`,
        `/api/visits/${encodeURIComponent(inquiryId)}/sessions/${encodeURIComponent(sessionId)}`,
        `/api/visits/${encodeURIComponent(inquiryId)}/session/${encodeURIComponent(sessionId)}/events`,
        `/api/visits/${encodeURIComponent(inquiryId)}/history?include=events&sessionId=${encodeURIComponent(sessionId)}`,
        `/api/visits/${encodeURIComponent(inquiryId)}?sessionId=${encodeURIComponent(sessionId)}`
      ];
      const attempts = [];
      for (const u of urls){
        try{
          const data = await fetchJson(u);
          if (Array.isArray(data) && data.length && (data[0].type || data[0].name)) return { events: data, hit: u };
          if (data && Array.isArray(data.events)) return { events: data.events, hit: u };
          if (data && data.session && Array.isArray(data.session.events)) return { events: data.session.events, hit: u };
          if (data && Array.isArray(data.sessions)) {
            const s = data.sessions.find(x => (x.id||x.session_id) === sessionId);
            if (s && Array.isArray(s.events)) return { events: s.events, hit: u };
          }
          attempts.push(u + ' â†’ no events');
        }catch(e){ attempts.push(u + ' â†’ ' + e.message); }
      }
      return { events: null, attempts };
    }

    // Render helpers reused from your original
    const renderEvent = (ev) => {
      if (ev.type==='section_enter')  return `â†’ Enter section: ${ev.section}`;
      if (ev.type==='section_exit')   return `â†©ï¸ Exit section: ${ev.section} â€” ${ev.dwellSec ?? 0}s${ev.reason?` [${ev.reason}]`:''}`;
      if (ev.type==='tier_expand')    return `âŸ« Tier opened: ${ev.tier}`;
      if (ev.type==='tier_exit')      return `âŸª Tier closed (inferred): ${ev.tier} â€” ${ev.dwellSec ?? 0}s${ev.reason?` [${ev.reason}]`:''}`;
      if (ev.type==='video_open')     return `â–¶ï¸ Video open: ${ev.youtubeId||''}${ev.title?` â€” ${ev.title}`:''}`;
      if (ev.type==='video_close')    return `â–  Video close: ${ev.youtubeId||''}`;
      if (ev.type==='cta_openmorning_click') return `â˜… Open Morning click: ${ev.href||''}`;
      if (ev.type==='page_load')      return 'âœ“ Visit start';
      if (ev.type==='page_unload')    return 'âœ• Visit end';
      return ev.name || ev.type;
    };
    const inferStartFromSessionId = (sid) => {
      const m = /^S-(\d{13})-/.exec(String(sid||'')); if (!m) return null;
      const t = Number(m[1]); if (!Number.isFinite(t)) return null;
      try { return new Date(t); } catch { return null; }
    };

    // Card timeline (latest)
    async function loadCardTimeline(inquiryId){
      const box  = byId('timeline-'+inquiryId);
      const meta = byId('timeline-meta-'+inquiryId);
      const list = byId('timeline-list-'+inquiryId);
      if (!box || !meta || !list) return;

      box.style.display = 'block';
      meta.textContent = 'Loadingâ€¦';
      list.innerHTML = '';

      const body = await fetchLatestVisit(inquiryId);
      if (!body || !body.ok || !body.session) { meta.textContent = 'No visits found for that inquiry.'; return; }

      const fmt = ts => new Date(ts).toLocaleString();
      meta.textContent = `Session ${body.session.id} â€” ${fmt(body.session.start)} â†’ ${fmt(body.session.end)}`;
      for (const ev of body.events) {
        const li = document.createElement('li');
        li.style.margin = '4px 0';
        li.textContent = renderEvent(ev);
        list.appendChild(li);
      }
    }

    // Full session history list
    async function loadSessionHistory(inquiryId){
      const wrap = byId('sessions-'+inquiryId);
      const meta = byId('sessions-meta-'+inquiryId);
      const list = byId('sessions-list-'+inquiryId);
      if (!wrap || !meta || !list) return;

      wrap.style.display = 'block';
      meta.textContent = 'Loading sessionsâ€¦';
      list.innerHTML = '';

      const hist = await fetchVisitHistory(inquiryId);
      if (!hist || !hist.sessions || !hist.sessions.length){
        meta.textContent = 'No session history found for that inquiry.';
        return;
      }

      const sessions = hist.sessions.slice().sort((a,b)=>new Date(b.start||b.started_at||0)-new Date(a.start||a.started_at||0));
      meta.textContent = `${sessions.length} session${sessions.length===1?'':'s'} found`;

      for (const s of sessions){
        const sId = s.id || s.session_id || '';
        const sStart = s.start || s.started_at || s.session_start || s.created_at || (inferStartFromSessionId(sId)?.toISOString());
        const sEnd   = s.end   || s.ended_at   || s.session_end   || s.updated_at || null;

        const item = document.createElement('div'); item.className = 'session-item';
        const header = document.createElement('div'); header.className = 'session-header';
        const stamp = (d)=> d ? new Date(d).toLocaleString() : '?';
        header.innerHTML = `
          <div><strong>${sId ? ('Session ' + sId) : 'Session'}</strong></div>
          <div style="font-size:.9rem;color:#334155;">${stamp(sStart)}${sEnd ? ' â†’ ' + stamp(sEnd) : ''}</div>
        `;
        const body = document.createElement('div'); body.className = 'session-body';
        const inner = document.createElement('div'); inner.className = 'timeline-meta'; inner.textContent = 'Click to load eventsâ€¦';
        body.appendChild(inner);

        let loaded = false;
        header.addEventListener('click', async () => {
          item.classList.toggle('open');
          if (loaded || !item.classList.contains('open')) return;

          inner.textContent = 'Loading eventsâ€¦';

          let events = (Array.isArray(s.events) && s.events.length) ? s.events : null;
          let hitUrl = null;

          if (!events) {
            const res = await fetchSessionEvents(sId, inquiryId);
            events = res.events || null;
            hitUrl = res.hit || null;

            if (!events && res.attempts) {
              inner.innerHTML = `<div class="timeline-meta">No events found. Tried:<br><small>${res.attempts.slice(0,3).join('<br>')}<br>â€¦</small></div>`;
              loaded = true; return;
            }
          }

          if (!events || !events.length){
            inner.textContent = 'No events returned for this session.';
            loaded = true; return;
          }

          const ol = document.createElement('ol'); ol.className = 'timeline-list';
          for (const ev of events){
            const li = document.createElement('li');
            li.style.margin = '4px 0';
            li.textContent = renderEvent(ev);
            ol.appendChild(li);
          }

          const hint = document.createElement('div');
          hint.className = 'timeline-meta';
          hint.style.marginTop = '.5rem';
          hint.textContent = hitUrl ? `Loaded from: ${hitUrl}` : 'Loaded from history payload';

          body.innerHTML = '';
          body.appendChild(ol);
          body.appendChild(hint);
          loaded = true;
        });

        item.appendChild(header); item.appendChild(body); list.appendChild(item);
      }
    }

    function showError(message){
      ['familyList','activityFeed'].forEach(id=>{
        const el = byId(id);
        if (el) el.innerHTML = '<div class="error">'+message+'</div>';
      });
    }

    // Recent activity (simple & readable)
    function loadRecentActivity(){
      const container = byId('activityFeed');
      if (!container) return;

      if (!allFamilies.length) {
        container.innerHTML = '<div class="no-data">No data yet</div>';
        return;
      }

      try {
        const recent = allFamilies
          .slice()
          .sort((a,b)=>new Date(b.lastActivity||0)-new Date(a.lastActivity||0))
          .slice(0,10);

        const html = recent.map(f=>{
          const timeAgo = f.lastActivity ? formatTimeAgo(new Date(f.lastActivity)) : 'â€”';
          const activity = f.isActiveToday
            ? 'viewed their prospectus today'
            : (f.hasProspectus ? 'received personalised prospectus' : 'submitted enquiry');
          const initial = (f.firstName || f.familySurname || 'F').charAt(0).toUpperCase();
          return `
            <div class="activity-item" style="padding:1rem;border-bottom:1px solid var(--border-grey);display:flex;gap:1rem;align-items:center">
              <div class="activity-avatar" style="width:40px;height:40px;border-radius:50%;background:var(--award-gold);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--blazer-navy);flex-shrink:0">${initial}</div>
              <div class="activity-text" style="flex:1;font-size:.9rem;color:var(--text-primary)"><strong>${f.name}</strong> ${activity}</div>
              <div class="activity-time" style="font-size:.75rem;color:#64748b">${timeAgo}</div>
            </div>`;
        }).join('');

        container.innerHTML = html || '<div class="no-data">No recent activity</div>';
      } catch (e) {
        console.error('loadRecentActivity error:', e);
        container.innerHTML = '<div class="error">Failed to load activity</div>';
      }
    }

    // Escape helper for notes text
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      byId('sortFilter')?.addEventListener('change', renderFamilies);
      byId('ratingFilter')?.addEventListener('change', renderFamilies);
      byId('searchBox')?.addEventListener('input', renderFamilies);

      byId('lv-load')?.addEventListener('click', async () => {
        const id = (byId('lv-inquiry')?.value || '').trim();
        const meta = byId('lv-meta'); const list = byId('lv-list');
        if (!id) { meta.textContent = 'Please paste an Inquiry ID.'; list.innerHTML=''; return; }
        meta.textContent = 'Loadingâ€¦'; list.innerHTML = '';
        const body = await fetchLatestVisit(id);
        if (!body || !body.ok || !body.session) { meta.textContent = 'No visits found for that inquiry.'; return; }
        const fmt = ts => new Date(ts).toLocaleString();
        meta.textContent = `Session ${body.session.id} â€” ${fmt(body.session.start)} â†’ ${fmt(body.session.end)}`;
        for (const ev of body.events) {
          const li = document.createElement('li');
          li.style.margin = '4px 0';
          li.textContent = renderEvent(ev);
          list.appendChild(li);
        }
      });

      loadData();
    });
  </script>
</body>
</html>
