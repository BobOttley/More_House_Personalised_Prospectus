<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>More House Analytics - Real Data Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --blazer-navy:#091825;--award-gold:#FF9F1C;--sport-blue:#034674;
      --text-primary:#2C3E50;--white:#FFFFFF;--light-grey:#F8FAFC;--border-grey:#E5E7EB;
      --success:#10B981;--warning:#F59E0B;--error:#EF4444;
      --hot-lead:#FF4444;--warm-lead:#FF9F1C;--cold-lead:#034674;
      --font-heading:'Playfair Display',serif;--font-body:'Inter',sans-serif
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:var(--font-body);background:linear-gradient(135deg,var(--light-grey) 0%,#f1f5f9 100%);min-height:100vh;color:var(--text-primary);font-size:14px}

    .header{background:linear-gradient(135deg,#091825 0%,#034674 100%);color:#fff;padding:2rem;box-shadow:0 4px 20px rgba(9,24,37,.3);text-align:center;position:relative}
    .refresh-btn{position:absolute;top:2rem;right:2rem;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:.5rem 1rem;border-radius:8px;cursor:pointer;transition:.3s;font-size:.9rem}
    .refresh-btn:hover{background:rgba(255,255,255,.2)}
    .header-brand{display:inline-block;position:relative}
    .brand-glow{position:absolute;inset:0;border-radius:50%;background:linear-gradient(135deg,var(--award-gold),#FFB84D);opacity:.3;filter:blur(20px)}
    .header h1{position:relative;font-family:var(--font-heading);font-size:4rem;font-weight:700;margin-bottom:1rem}
    .smart-text{background:linear-gradient(135deg,var(--award-gold),#FFB84D);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .analytics-text{color:#fff}
    .header p{font-size:1.2rem;font-weight:300;color:rgba(255,255,255,.9);margin-bottom:.5rem}

    .dashboard{max-width:1400px;margin:-2rem auto 2rem;position:relative;z-index:10}
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.5rem;padding:2rem}
    .metric-card{background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 4px 16px rgba(9,24,37,.08);border:1px solid var(--border-grey);transition:.3s;position:relative;overflow:hidden}
    .metric-card:hover{box-shadow:0 8px 25px rgba(9,24,37,.12);transform:translateY(-2px)}
    .metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--award-gold),var(--sport-blue))}
    .metric-card.hot::before{background:var(--hot-lead)}.metric-card.warm::before{background:var(--warm-lead)}.metric-card.engagement::before{background:var(--success)}.metric-card.total::before{background:var(--sport-blue)}
    .metric-header{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
    .metric-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;background:var(--award-gold);font-size:1.5rem}
    .metric-icon.hot{background:linear-gradient(135deg,var(--hot-lead),#ff6666)}
    .metric-icon.warm{background:linear-gradient(135deg,var(--warm-lead),#ffb347)}
    .metric-icon.engagement{background:linear-gradient(135deg,var(--success),#34d399)}
    .metric-icon.total{background:linear-gradient(135deg,var(--sport-blue),#0ea5e9)}
    .metric-title{font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#64748b;margin-bottom:.5rem}
    .metric-value{font-size:2.25rem;font-weight:700;color:var(--blazer-navy);margin-bottom:.25rem;font-family:var(--font-heading)}
    .metric-subtitle{font-size:.8rem;font-weight:500;color:var(--success);display:flex;align-items:center;gap:.25rem}

    .main-content{display:grid;grid-template-columns:2fr 1fr;gap:2rem;padding:0 1rem}
    .panel{background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden}
    .panel-header{background:#034674;color:#fff;padding:1rem 1.5rem;font-weight:600}
    .panel-content{padding:1.5rem}
    .filters{background:#fff;padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;gap:1rem;align-items:center}
    .filter-select,.search-box{padding:.5rem;border:1px solid #d1d5db;border-radius:4px;font-size:.875rem}
    .search-box{flex:1;max-width:300px}

    .family-card{border:1px solid #e2e8f0;border-radius:6px;margin-bottom:1rem;overflow:hidden}
    .family-header{padding:1rem;display:flex;justify-content:space-between;align-items:center;background:#f8fafc}
    .family-header:hover{background:#f1f5f9}
    .family-info h3{font-size:1rem;font-weight:600;margin-bottom:.25rem}
    .family-meta{font-size:.875rem;color:#64748b}
    .family-actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{padding:.4rem .6rem;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer;font-size:.8rem}
    .btn.primary{background:#034674;border-color:#034674;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .family-details{padding:1rem;border-top:1px solid #e2e8f0;display:none;background:#fff}
    .family-card.expanded .family-details{display:block}
    .expand-icon{transition:transform .2s}
    .family-card.expanded .expand-icon{transform:rotate(180deg)}

    .timeline{margin-top:.75rem;padding:.75rem;background:#F8FAFC;border:1px solid #E5E7EB;border-radius:6px}
    .timeline-meta{font-size:.9rem;color:#334155;margin-bottom:.5rem}
    .timeline-list{margin:0;padding-left:18px}

    .activity-feed{max-height:500px;overflow-y:auto}
    .activity-item{padding:1rem;border-bottom:1px solid var(--border-grey);display:flex;gap:1rem;align-items:center}
    .activity-item:last-child{border-bottom:none}
    .activity-avatar{width:40px;height:40px;border-radius:50%;background:var(--award-gold);display:flex;align-items:center;justify-content:center;font-weight:600;color:var(--blazer-navy);flex-shrink:0}
    .activity-text{flex:1;font-size:.9rem;color:var(--text-primary)}
    .activity-time{font-size:.75rem;color:#64748b}

    .loading{display:flex;align-items:center;justify-content:center;padding:2rem;color:#64748b}
    .spinner{width:16px;height:16px;border:2px solid #e2e8f0;border-top:2px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin-right:.5rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:1rem;border-radius:6px;margin:1rem 0}
    .no-data{text-align:center;color:#64748b;padding:2rem}

    #latest-visit{max-width:1400px;margin:16px auto 0;padding:12px;border:1px solid #E5E7EB;border-radius:8px;background:#F8FAFC}
    @media (max-width:768px){.main-content{grid-template-columns:1fr}.metrics{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}}
  </style>
</head>
<body>
  <header class="header">
    <button class="refresh-btn" onclick="loadData(true)">‚Üª Refresh</button>
    <div class="header-brand">
      <div class="brand-glow"></div>
      <h1><span class="smart-text">SMART</span> <span class="analytics-text">Analytics</span></h1>
    </div>
    <p>More House School</p>
    <div style="font-size:.9rem;color:rgba(255,255,255,.7);margin-top:.5rem;">Real-time family engagement tracking</div>
  </header>

  <!-- Top Latest Visit Timeline (paste an Inquiry ID) -->
  <div id="latest-visit">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <strong>Latest Visit Timeline</strong>
      <input id="lv-inquiry" type="text" placeholder="Paste Inquiry ID e.g. INQ-1756‚Ä¶" style="flex:1;min-width:260px;padding:8px;border:1px solid #E5E7EB;border-radius:6px;">
      <button id="lv-load" class="btn primary">Load</button>
    </div>
    <div id="lv-meta" class="timeline-meta"></div>
    <ol id="lv-list" class="timeline-list"></ol>
  </div>

  <div class="dashboard">
    <!-- Metrics -->
    <div class="metrics">
      <div class="metric-card total">
        <div class="metric-header">
          <div class="metric-icon total">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <div class="metric-content">
            <div class="metric-title">Total Families</div>
            <div class="metric-value" id="totalFamilies">-</div>
            <div class="metric-subtitle">Active prospects</div>
          </div>
        </div>
      </div>
      <div class="metric-card hot">
        <div class="metric-header">
          <div class="metric-icon hot">üî•</div>
          <div class="metric-content">
            <div class="metric-title">Hot Leads</div>
            <div class="metric-value" id="hotLeads">-</div>
            <div class="metric-subtitle">Score 80+ ‚Ä¢ Ready for contact</div>
          </div>
        </div>
      </div>
      <div class="metric-card warm">
        <div class="metric-header">
          <div class="metric-icon warm">‚ö°</div>
          <div class="metric-content">
            <div class="metric-title">Warm Leads</div>
            <div class="metric-value" id="warmLeads">-</div>
            <div class="metric-subtitle">Score 50‚Äì79 ‚Ä¢ Contact soon</div>
          </div>
        </div>
      </div>
      <div class="metric-card engagement">
        <div class="metric-header">
          <div class="metric-icon engagement">üìä</div>
          <div class="metric-content">
            <div class="metric-title">Active Today</div>
            <div class="metric-value" id="activeToday">-</div>
            <div class="metric-subtitle">Recent engagement</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Families -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Family Prospects</h2>
            <div style="font-size:.9rem;opacity:.9;margin-top:.25rem;">Real-time engagement tracking</div>
          </div>
        </div>
        <div class="filters">
          <select class="filter-select" id="sortFilter">
            <option value="engagement">Sort by Engagement</option>
            <option value="recent">Sort by Recent</option>
            <option value="time">Sort by Time Spent</option>
          </select>
          <select class="filter-select" id="statusFilter">
            <option value="all">All Families</option>
            <option value="hot">Hot Leads</option>
            <option value="warm">Warm Leads</option>
            <option value="active">Active Today</option>
          </select>
          <input type="text" class="search-box" placeholder="Search families..." id="searchBox">
        </div>
        <div class="panel-content">
          <div id="familyList">
            <div class="loading"><div class="spinner"></div> Loading families...</div>
          </div>
        </div>
      </div>

      <!-- Activity -->
      <div class="panel">
        <div class="panel-header"><h2>Recent Activity</h2></div>
        <div class="panel-content">
          <div id="activityFeed">
            <div class="loading"><div class="spinner"></div> Loading activity...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Core Logic -->
  <script>
    'use strict';

    let allFamilies = [];
    let isLoading = false;

    // ----- Helpers -----
    const byId = id => document.getElementById(id);
    const setText = (id, v) => { const el = byId(id); if (el) el.textContent = String(v); };
    const fetchJson = async (url) => {
      const u = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const res = await fetch(u, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    };
    const formatTimeAgo = (date) => {
      const now = new Date(), diff = now - date;
      const m = Math.floor(diff/60000), h = Math.floor(diff/3600000), d = Math.floor(diff/86400000);
      if (m < 1) return 'Just now';
      if (m < 60) return `${m}m ago`;
      if (h < 24) return `${h}h ago`;
      if (d < 7) return `${d}d ago`;
      return date.toLocaleDateString();
    };
    const renderEvent = (ev) => {
      if (ev.type==='section_enter')  return `‚Üí Enter section: ${ev.section}`;
      if (ev.type==='section_exit')   return `‚Ü©Ô∏é Exit section: ${ev.section} ‚Äî ${ev.dwellSec ?? 0}s${ev.reason?` [${ev.reason}]`:''}`;
      if (ev.type==='tier_expand')    return `‚ü´ Tier opened: ${ev.tier}`;
      if (ev.type==='tier_exit')      return `‚ü™ Tier closed (inferred): ${ev.tier} ‚Äî ${ev.dwellSec ?? 0}s${ev.reason?` [${ev.reason}]`:''}`;
      if (ev.type==='video_open')     return `‚ñ∂Ô∏é Video open: ${ev.youtubeId||''}${ev.title?` ‚Äî ${ev.title}`:''}`;
      if (ev.type==='video_close')    return `‚ñ† Video close: ${ev.youtubeId||''}`;
      if (ev.type==='cta_openmorning_click') return `‚òÖ Open Morning click: ${ev.href||''}`;
      if (ev.type==='page_load')      return '‚úì Visit start';
      if (ev.type==='page_unload')    return '‚úï Visit end';
      return ev.name || ev.type;
    };

    // ----- Data load -----
    async function loadData(force=false){
      if (isLoading) return; isLoading = true;
      try {
        const data = await fetchJson('/api/analytics/inquiries');
        allFamilies = processRealData(Array.isArray(data) ? data : []);
        updateMetrics();
        renderFamilies();
        loadRecentActivity();
      } catch (e) {
        showError('Failed to load data: ' + e.message);
        console.error('loadData:', e);
      } finally {
        isLoading = false;
      }
    }

    // Deterministic scoring (no randomness)
    function processRealData(raw){
      return raw.map(f => {
        const dwellMs = Number(f.dwell_ms) || 0;
        const minutes = dwellMs / 60000;
        const visits  = Number(f.return_visits) || 0;
        const last    = f.updated_at || f.received_at || null;

        const timeScore  = Math.min(Math.max(minutes, 0), 25) * 2; // 0..50
        const visitScore = Math.min(Math.max(visits, 0), 6) * 5;   // 0..30
        let recency = 0;                                           // 0..20
        if (last) {
          const age = Date.now() - new Date(last).getTime();
          if (age <= 86400000) recency = 20;
          else if (age <= 3*86400000) recency = 10;
        }
        const engagement = Math.round(Math.min(timeScore + visitScore + recency, 100));
        const temperature = engagement >= 80 ? 'hot' : (engagement >= 50 ? 'warm' : 'cold');
        const isActiveToday = !!(last && (Date.now() - new Date(last).getTime()) <= 86400000);

        return {
          id: f.id,
          name: `${f.first_name || ''} ${f.family_surname || ''}`.trim(),
          firstName: f.first_name,
          familySurname: f.family_surname,
          parentEmail: f.parent_email,
          entryYear: f.entry_year,
          ageGroup: f.age_group,
          receivedAt: f.received_at,
          lastActivity: last,
          timeOnPageMs: dwellMs,
          timeOnPageMinutes: Math.max(0, Math.round(minutes)),
          visits: Math.max(0, visits),
          engagementScore: engagement,
          temperature,
          isActiveToday,
          status: f.status || 'received',
          hasProspectus: !!f.prospectus_generated,
          prospectusUrl: f.prospectus_pretty_url || null,
          city: f.city || 'Unknown',
          country: f.country || 'Unknown'
        };
      }).filter(x => x.name.length);
    }

    function updateMetrics(){
      setText('totalFamilies', allFamilies.length);
      setText('hotLeads',     allFamilies.filter(f=>f.temperature==='hot').length);
      setText('warmLeads',    allFamilies.filter(f=>f.temperature==='warm').length);
      setText('activeToday',  allFamilies.filter(f=>f.isActiveToday).length);
    }

    function renderFamilies(){
      const container = byId('familyList');
      const list = getFilteredFamilies();

      if (!allFamilies.length) { container.innerHTML = '<div class="no-data">No data yet</div>'; return; }
      if (!list.length) { container.innerHTML = '<div class="no-data">No families found matching current filters</div>'; return; }

      container.innerHTML = list.map(f => {
        const openBtn = f.prospectusUrl
          ? `<button class="btn primary" onclick="openProspectus('${encodeURI(f.prospectusUrl)}')">Open Prospectus</button>`
          : `<button class="btn" disabled title="No prospectus URL">Open Prospectus</button>`;
        return `
          <div class="family-card" data-id="${f.id}">
            <div class="family-header">
              <div class="family-info" onclick="toggleFamily('${f.id}')" style="cursor:pointer;">
                <h3>${f.name} Family</h3>
                <div class="family-meta">
                  Entry ${f.entryYear || 'TBC'} ‚Ä¢ ${f.timeOnPageMinutes}min ‚Ä¢ ${f.visits} visit${f.visits===1?'':'s'} ‚Ä¢ ${f.city}
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:.5rem;">
                <div class="score-badge ${f.temperature}">${f.engagementScore}</div>
                <div class="expand-icon">‚ñº</div>
              </div>
            </div>
            <div class="family-details">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:.75rem;">
                <div>
                  <strong>Contact Info</strong><br>
                  Email: ${f.parentEmail || 'Unknown'}<br>
                  Age Group: ${f.ageGroup || 'Unknown'}<br>
                  Entry Year: ${f.entryYear || 'TBC'}
                </div>
                <div>
                  <strong>Engagement</strong><br>
                  Time: ${f.timeOnPageMinutes} minutes<br>
                  Visits: ${f.visits}<br>
                  Score: ${f.engagementScore}/100<br>
                  ${f.isActiveToday ? 'üü¢ Active today' : '‚ö´ Not active today'}
                </div>
              </div>

              <div class="family-actions">
                ${openBtn}
                <button class="btn" onclick="copyInquiryId('${f.id}')">Copy Inquiry ID</button>
                <button class="btn" onclick="loadCardTimeline('${f.id}')">Load Timeline</button>
                ${f.parentEmail ? `<a class="btn" href="mailto:${encodeURIComponent(f.parentEmail)}" target="_blank">Email Parent</a>` : ''}
              </div>

              <div id="timeline-${f.id}" class="timeline" style="display:none;">
                <div class="timeline-meta" id="timeline-meta-${f.id}"></div>
                <ol class="timeline-list" id="timeline-list-${f.id}"></ol>
              </div>

              ${f.prospectusUrl ? `
                <div style="margin-top:.75rem;">
                  <a href="${f.prospectusUrl}" target="_blank" style="color:#3b82f6;text-decoration:none;">üìÑ View Prospectus in new tab</a>
                </div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function getFilteredFamilies(){
      let families = [...allFamilies];

      const status = byId('statusFilter')?.value || 'all';
      if (status==='hot') families = families.filter(f=>f.temperature==='hot');
      else if (status==='warm') families = families.filter(f=>f.temperature==='warm');
      else if (status==='active') families = families.filter(f=>f.isActiveToday);

      const q = (byId('searchBox')?.value || '').toLowerCase();
      if (q) {
        families = families.filter(f =>
          f.name.toLowerCase().includes(q) ||
          (f.parentEmail||'').toLowerCase().includes(q) ||
          (f.city||'').toLowerCase().includes(q)
        );
      }

      const sortBy = byId('sortFilter')?.value || 'engagement';
      if (sortBy==='engagement') families.sort((a,b)=>b.engagementScore-a.engagementScore);
      else if (sortBy==='recent') families.sort((a,b)=>new Date(b.lastActivity)-new Date(a.lastActivity));
      else if (sortBy==='time') families.sort((a,b)=>b.timeOnPageMs-a.timeOnPageMs);

      return families;
    }

    // ----- Actions -----
    function toggleFamily(id){
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) card.classList.toggle('expanded');
    }
    function openProspectus(url){ try { window.open(url,'_blank'); } catch(e){ console.error(e); } }
    function copyInquiryId(id){ navigator.clipboard.writeText(id).catch(()=>{}); }

    async function fetchLatestVisit(inquiryId){
      if (!inquiryId) return null;
      try { return await fetchJson(`/api/visits/${encodeURIComponent(inquiryId)}/latest`); }
      catch (e) { console.error('fetchLatestVisit:', e); return null; }
    }

    async function loadCardTimeline(inquiryId){
      const box  = byId('timeline-'+inquiryId);
      const meta = byId('timeline-meta-'+inquiryId);
      const list = byId('timeline-list-'+inquiryId);
      if (!box || !meta || !list) return;

      box.style.display = 'block';
      meta.textContent = 'Loading‚Ä¶';
      list.innerHTML = '';

      const body = await fetchLatestVisit(inquiryId);
      if (!body || !body.ok || !body.session) { meta.textContent = 'No visits found for that inquiry.'; return; }

      const fmt = ts => new Date(ts).toLocaleString();
      meta.textContent = `Session ${body.session.id} ‚Äî ${fmt(body.session.start)} ‚Üí ${fmt(body.session.end)}`;
      for (const ev of body.events) {
        const li = document.createElement('li');
        li.style.margin = '4px 0';
        li.textContent = renderEvent(ev);
        list.appendChild(li);
      }
    }

    function showError(message){
      ['familyList','activityFeed'].forEach(id=>{
        const el = byId(id);
        if (el) el.innerHTML = '<div class="error">'+message+'</div>';
      });
    }

    // ----- Init -----
    document.addEventListener('DOMContentLoaded', () => {
      byId('sortFilter')?.addEventListener('change', renderFamilies);
      byId('statusFilter')?.addEventListener('change', renderFamilies);
      byId('searchBox')?.addEventListener('input', renderFamilies);

      byId('lv-load')?.addEventListener('click', async () => {
        const id = (byId('lv-inquiry')?.value || '').trim();
        const meta = byId('lv-meta'); const list = byId('lv-list');
        if (!id) { meta.textContent = 'Please paste an Inquiry ID.'; list.innerHTML=''; return; }
        meta.textContent = 'Loading‚Ä¶'; list.innerHTML = '';
        const body = await fetchLatestVisit(id);
        if (!body || !body.ok || !body.session) { meta.textContent = 'No visits found for that inquiry.'; return; }
        const fmt = ts => new Date(ts).toLocaleString();
        meta.textContent = `Session ${body.session.id} ‚Äî ${fmt(body.session.start)} ‚Üí ${fmt(body.session.end)}`;
        for (const ev of body.events) {
          const li = document.createElement('li');
          li.style.margin = '4px 0';
          li.textContent = renderEvent(ev);
          list.appendChild(li);
        }
      });

      loadData(true);
    });
  </script>
</body>
</html>
