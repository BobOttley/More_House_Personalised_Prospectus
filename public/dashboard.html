<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SMART Analytics (v2)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--navy:#0a2540;--gold:#ff9f1c;--grey:#e5e7eb}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
  header{background:linear-gradient(135deg,#0a2540,#034674);color:#fff;padding:16px 20px}
  h1{margin:0;font-size:20px}
  .bar{display:flex;gap:8px;align-items:center;margin-top:8px}
  button{border:1px solid #cbd5e1;background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.primary{background:var(--gold);border-color:#e07f00;color:#141b2a;font-weight:700}
  main{padding:16px 20px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--grey);border-radius:12px}
  .card h2{font-size:16px;margin:0;padding:12px 14px;border-bottom:1px solid var(--grey);background:#fff}
  .card .body{padding:12px 14px}
  .metrics{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:12px 0}
  .metric{border:1px solid var(--grey);border-radius:10px;padding:10px;background:#fff}
  .metric .k{font-size:22px;font-weight:700;color:var(--navy)}
  .list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
  .row{border:1px solid #e5e7eb;border-radius:8px;padding:10px;display:flex;justify-content:space-between;gap:10px}
  .muted{opacity:.7}
  .ok{color:#059669}.warn{color:#b45309}.err{color:#dc2626}
  pre{white-space:pre-wrap;background:#0b1220;color:#e2e8f0;padding:10px;border-radius:8px;max-height:30vh;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>SMART Analytics (v2)</h1>
  <div class="bar">
    <button id="refreshBtn">↻ Refresh</button>
    <button id="analyzeAllBtn" class="primary">Run SMART AI for all</button>
    <span id="status" class="muted">Ready</span>
  </div>
</header>

<main>
  <section class="card">
    <h2>Families</h2>
    <div class="body">
      <div class="metrics">
        <div class="metric"><div class="muted">Hot Leads</div><div id="mHot" class="k">-</div></div>
        <div class="metric"><div class="muted">Warm Leads</div><div id="mWarm" class="k">-</div></div>
        <div class="metric"><div class="muted">AI Analysed</div><div id="mAI" class="k">-</div></div>
        <div class="metric"><div class="muted">Total</div><div id="mTotal" class="k">-</div></div>
      </div>
      <div id="families" class="list"><div class="muted">Loading…</div></div>
    </div>
  </section>

  <aside class="card">
    <h2>Live Activity</h2>
    <div class="body">
      <div id="activity" class="list"><div class="muted">Loading…</div></div>
      <h2 style="margin-top:12px">Last response</h2>
      <div class="body"><pre id="lastResp">(none)</pre></div>
    </div>
  </aside>
</main>

<script>
const S = (id)=>document.getElementById(id);
const statusTxt = S('status'), familiesEl = S('families'), activityEl = S('activity'), lastResp = S('lastResp');

S('refreshBtn').onclick = init;
S('analyzeAllBtn').onclick = analyzeAll;

async function init(){
  status('Loading…');
  try{
    const fam = await fetchJson('/api/analytics/inquiries');   // families + AI summaries
    const dash = await fetchJson('/api/dashboard-data');       // recentlyActive, counts
    renderFamilies(Array.isArray(fam)?fam:[]);
    renderActivity(dash?.recentlyActive||[]);
    renderMetrics(Array.isArray(fam)?fam:[], dash);
    status('Loaded');
  }catch(e){
    status('Load failed', 'err', e);
  }
}

async function analyzeAll(){
  status('Running SMART AI for all…');
  try{
    const r = await fetch('/api/ai/analyze-all-families',{method:'POST'});
    const data = await safeJson(r);
    lastResp.textContent = JSON.stringify(data ?? {http:r.status}, null, 2);
    if(!r.ok || !data?.success) throw new Error((data&&(data.message||data.error))||('HTTP '+r.status));
    status('AI analysis complete','ok');
    await init();
  }catch(e){
    status('AI analysis failed','err', e);
    alert('SMART AI Analysis failed: ' + e.message);
  }
}

function renderFamilies(rows){
  if(!rows.length){ familiesEl.innerHTML = '<div class="muted">No enquiries.</div>'; return; }
  familiesEl.innerHTML = '';
  rows.forEach(enq=>{
    const engagement = enq.engagement || {};
    const score = calcScore(engagement, enq);
    const temp = score>=80?'hot':score>=60?'warm':'cool';
    const pretty = enq.prospectus_pretty_url || (enq.prospectus_pretty_path? (location.origin+enq.prospectus_pretty_path) : (enq.slug? (location.origin+'/'+enq.slug): null));
    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <div>
        <div><strong>${enq.first_name||''} ${enq.family_surname||''}</strong> <span class="muted">(${enq.entry_year||''})</span></div>
        <div class="muted">${enq.parent_email||''}</div>
        ${pretty? `<div><a href="${pretty}" target="_blank">Open prospectus</a></div>`:''}
        ${enq.aiEngagement?.narrative? `<div style="margin-top:6px">${enq.aiEngagement.narrative}</div>`:''}
      </div>
      <div style="text-align:right;min-width:180px">
        <div class="${temp==='hot'?'ok':temp==='warm'?'warn':'muted'}" style="font-weight:700">Score ${score}</div>
        <button data-id="${enq.id}" class="gen">Generate SMART AI</button>
      </div>`;
    familiesEl.appendChild(row);
  });
  familiesEl.querySelectorAll('.gen').forEach(b=>{
    b.onclick = ()=> generateOne(b.getAttribute('data-id'), b);
  });
}

function renderActivity(items){
  if(!items.length){ activityEl.innerHTML = '<div class="muted">No recent activity.</div>'; return; }
  activityEl.innerHTML = '';
  items.slice(0,20).forEach(a=>{
    const div = document.createElement('div'); div.className='row';
    div.innerHTML = `<div><strong>${a.name||'Unknown'}</strong> — ${a.activity||'activity'}</div><div class="muted">${timeAgo(a.when||a.timestamp)}</div>`;
    activityEl.appendChild(div);
  });
}

function renderMetrics(fam, dash){
  const hot = fam.filter(f=>calcScore(f.engagement||{},f)>=80).length;
  const warm= fam.filter(f=>{const s=calcScore(f.engagement||{},f);return s>=60&&s<80}).length;
  const ai  = fam.filter(f=>f.aiEngagement?.narrative).length;
  S('mHot').textContent = hot;
  S('mWarm').textContent = warm;
  S('mAI').textContent = ai;
  S('mTotal').textContent = fam.length || (dash?.totalFamilies ?? 0);
}

async function generateOne(id, btn){
  try{
    btn.disabled=true; btn.textContent='Analysing…';
    const r = await fetch('/api/ai/engagement-summary/'+id,{method:'POST'});
    const data = await safeJson(r);
    lastResp.textContent = JSON.stringify(data ?? {http:r.status}, null, 2);
    if(!r.ok) throw new Error((data&& (data.message||data.error))||('HTTP '+r.status));
    await init();
  }catch(e){
    alert('Could not generate engagement summary: '+e.message);
  }finally{
    btn.disabled=false; btn.textContent='Generate SMART AI';
  }
}

/* helpers */
async function fetchJson(url){
  const r = await fetch(url);
  const d = await safeJson(r);
  if(!r.ok) throw new Error((d&& (d.message||d.error))||('HTTP '+r.status));
  lastResp.textContent = JSON.stringify({url, ok:r.ok, sample:Array.isArray(d)?d.slice(0,1):d}, null, 2);
  return d;
}
async function safeJson(r){ try{return await r.json();}catch{return null;} }
function status(t,cls,e){ statusTxt.className='muted'; if(cls) statusTxt.className=cls; statusTxt.textContent=t; if(e) console.error(t,e); }
function timeAgo(ts){ const d=new Date(ts),n=new Date(),m=Math.floor((n-d)/60000),h=Math.floor(m/60),D=Math.floor(h/24); if(m<1)return'Just now'; if(m<60)return m+' min ago'; if(h<24)return h+'h ago'; if(D<7)return D+'d ago'; return d.toLocaleDateString('en-GB'); }
function calcScore(eng,e){ let s=0; const mins=(eng.timeOnPage||eng.time_on_page||0)/60; s+= mins>=30?40: mins>=15?30: mins>=5?20: Math.min(mins*4,15);
  const depth=eng.scrollDepth||eng.scroll_depth||0; s+=Math.min(depth*0.3,30);
  const v=eng.totalVisits||eng.total_visits||1; s+= v>=5?20: v>=3?15: v>=2?10:5;
  const c=eng.clickCount||eng.clicks_on_links||0; s+=Math.min(c*2,10);
  return Math.min(Math.round(s),100);
}

init();
</script>
</body>
</html>
