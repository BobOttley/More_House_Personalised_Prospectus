<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART Analytics - More House School</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blazer-navy: #091825;
            --award-gold: #FF9F1C;
            --sport-blue: #034674;
            --text-primary: #2C3E50;
            --white: #FFFFFF;
            --light-grey: #F8FAFC;
            --border-grey: #E5E7EB;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --hot-lead: #FF4444;
            --warm-lead: #FF9F1C;
            --cold-lead: #034674;
            
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--light-grey) 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: var(--text-primary);
            font-size: 14px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--blazer-navy) 0%, var(--sport-blue) 100%);
            color: var(--white);
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(9, 24, 37, 0.3);
            text-align: center;
            position: relative;
        }

        .header-brand {
            display: inline-block;
            position: relative;
        }

        .brand-glow {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--award-gold), #FFB84D);
            opacity: 0.3;
            filter: blur(20px);
        }

        .header-brand h1 {
            position: relative;
            font-family: var(--font-heading);
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .header-brand h1 .smart-text {
            background: linear-gradient(135deg, var(--award-gold), #FFB84D);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-brand h1 .analytics-text {
            color: white;
        }

        .header-subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
        }

        .header-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .header-controls {
            position: absolute;
            top: 2rem;
            right: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .metrics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metric-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 16px rgba(9, 24, 37, 0.08);
            border: 1px solid var(--border-grey);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            box-shadow: 0 8px 25px rgba(9, 24, 37, 0.12);
            transform: translateY(-2px);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--award-gold), var(--sport-blue));
        }

        .metric-card.hot::before { background: var(--hot-lead); }
        .metric-card.warm::before { background: var(--warm-lead); }
        .metric-card.engagement::before { background: var(--success); }
        .metric-card.total::before { background: var(--sport-blue); }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            background: var(--award-gold);
            position: relative;
            font-size: 1.5rem;
        }

        .metric-icon.hot { 
            background: linear-gradient(135deg, var(--hot-lead), #ff6666); 
        }
        .metric-icon.warm { 
            background: linear-gradient(135deg, var(--warm-lead), #ffb347); 
        }
        .metric-icon.engagement { 
            background: linear-gradient(135deg, var(--success), #34d399); 
        }
        .metric-icon.total { 
            background: linear-gradient(135deg, var(--sport-blue), #0ea5e9); 
        }

        .metric-content {
            flex: 1;
        }

        .metric-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--blazer-navy);
            margin-bottom: 0.25rem;
            font-family: var(--font-heading);
        }

        .metric-trend {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin: 0 2rem 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .panel {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(9, 24, 37, 0.08);
            border: 1px solid var(--border-grey);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .panel:hover {
            box-shadow: 0 8px 25px rgba(9, 24, 37, 0.12);
        }

        .panel-header {
            background: linear-gradient(135deg, var(--blazer-navy) 0%, var(--sport-blue) 100%);
            color: var(--white);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 1.5rem;
        }

        .controls-bar {
            padding: 1rem 2rem;
            background: var(--white);
            border-bottom: 1px solid var(--border-grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-grey);
            border-radius: 8px;
            background: var(--white);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .search-box {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-grey);
            border-radius: 8px;
            width: 250px;
            font-size: 0.9rem;
        }

        .family-cards-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .family-card {
            border: 1px solid var(--border-grey);
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .family-card:hover {
            box-shadow: 0 4px 15px rgba(9, 24, 37, 0.1);
            transform: translateY(-1px);
        }

        .family-card-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-grey);
        }

        .family-info {
            flex: 1;
        }

        .family-name {
            font-weight: 600;
            color: var(--blazer-navy);
            font-size: 1rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .family-meta {
            font-size: 0.85rem;
            color: #64748b;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .family-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .score-badge.hot {
            background: var(--hot-lead);
            color: white;
        }

        .score-badge.warm {
            background: var(--warm-lead);
            color: white;
        }

        .score-badge.cold {
            background: var(--cold-lead);
            color: white;
        }

        .score-badge.low {
            background: #E5E7EB;
            color: #6B7280;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-indicator.online {
            background: var(--success);
            box-shadow: 0 0 4px var(--success);
        }

        .status-indicator.recent {
            background: var(--warning);
        }

        .status-indicator.offline {
            background: #D1D5DB;
        }

        .expand-btn {
            color: var(--sport-blue);
            transition: transform 0.3s;
        }

        .family-card.expanded .expand-btn {
            transform: rotate(180deg);
        }

        .family-card-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .family-card.expanded .family-card-details {
            max-height: none;
            overflow: visible;
        }

        .family-details-content {
            padding: 1.5rem;
            border-top: 1px solid var(--border-grey);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .detail-item h4 {
            color: var(--blazer-navy);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .detail-item p {
            color: #64748b;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .interests-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .interest-tag {
            background: var(--light-grey);
            color: var(--blazer-navy);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .ai-insights-section {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #bfdbfe;
        }

        .ai-insights-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .ai-badge {
            background: linear-gradient(135deg, var(--award-gold), #FFB84D);
            color: var(--blazer-navy);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .ai-narrative {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border-grey);
            margin-bottom: 1rem;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #475569;
        }

        .activity-feed {
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-grey);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--award-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--blazer-navy);
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.75rem;
            color: #64748b;
        }

        .activity-type {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .activity-type.high { background: var(--hot-lead); }
        .activity-type.medium { background: var(--warm-lead); }
        .activity-type.low { background: var(--cold-lead); }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: #64748b;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-grey);
            border-top: 2px solid var(--award-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .error-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .ai-analyzing {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--award-gold);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: var(--award-gold);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 600;
            margin: 0.25rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--award-gold);
            color: var(--blazer-navy);
        }

        .btn-secondary {
            background: var(--sport-blue);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                margin: 0 1rem 2rem;
            }
            
            .metrics-bar {
                padding: 1rem;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-brand h1 {
                font-size: 2.5rem;
            }
            
            .metric-value {
                font-size: 1.8rem;
            }
            
            .family-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="dashboard-header">
        <div class="header-controls">
            <div class="auto-refresh-toggle">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto-refresh</label>
            </div>
            <button class="refresh-btn" onclick="refreshDashboard()">
                <span id="refreshIcon">↻</span> Refresh
            </button>
        </div>
        
        <div class="header-brand">
            <div class="brand-glow"></div>
            <h1><span class="smart-text">SMART</span> <span class="analytics-text">Analytics</span></h1>
        </div>
        <div class="header-subtitle">More House School</div>
        <div class="header-meta">Admissions Intelligence Dashboard</div>
    </header>

    <section class="metrics-bar">
        <div class="metric-card hot">
            <div class="metric-header">
                <div class="metric-icon hot">🔥</div>
                <div class="metric-content">
                    <div class="metric-title">Hot Leads</div>
                    <div class="metric-value" id="hotLeads">-</div>
                    <div class="metric-trend">High Priority</div>
                </div>
            </div>
        </div>

        <div class="metric-card warm">
            <div class="metric-header">
                <div class="metric-icon warm">⚡</div>
                <div class="metric-content">
                    <div class="metric-title">Warm Leads</div>
                    <div class="metric-value" id="warmLeads">-</div>
                    <div class="metric-trend">Good Interest</div>
                </div>
            </div>
        </div>

        <div class="metric-card engagement">
            <div class="metric-header">
                <div class="metric-icon engagement">📊</div>
                <div class="metric-content">
                    <div class="metric-title">AI Analyzed</div>
                    <div class="metric-value" id="aiAnalyzed">-</div>
                    <div class="metric-trend">Families with insights</div>
                </div>
            </div>
        </div>

        <div class="metric-card total">
            <div class="metric-header">
                <div class="metric-icon total">👨‍👩‍👧‍👦</div>
                <div class="metric-content">
                    <div class="metric-title">Total Families</div>
                    <div class="metric-value" id="totalFamilies">-</div>
                    <div class="metric-trend">Active prospects</div>
                </div>
            </div>
        </div>
    </section>

    <section class="controls-bar">
        <div class="filter-group">
            <select class="filter-select" id="sortFilter">
                <option value="recent">Sort by Recent Activity</option>
                <option value="engagement">Sort by Engagement</option>
                <option value="inquiryDate">Sort by Inquiry Date</option>
                <option value="entryYear">Sort by Entry Year</option>
            </select>
            
            <select class="filter-select" id="statusFilter">
                <option value="all">All Families</option>
                <option value="prospectus_generated">Has Prospectus</option>
                <option value="ai_analyzed">AI Analyzed</option>
                <option value="recent">Recent Activity</option>
            </select>
            
            <select class="filter-select" id="entryYearFilter">
                <option value="all">All Entry Years</option>
                <option value="2025">Entry 2025</option>
                <option value="2026">Entry 2026</option>
                <option value="2027">Entry 2027+</option>
            </select>
        </div>
        
        <input type="text" class="search-box" placeholder="Search families..." id="searchBox">
    </section>

    <main class="dashboard-grid">
        <div class="panel">
            <div class="panel-header">
                <div>
                    <h2>Family Prospects</h2>
                    <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem;">
                        Real engagement tracking with AI analysis
                    </div>
                </div>
                <div class="ai-analyzing" id="aiStatus" style="display: none;">
                    <div class="pulse"></div>
                    AI Analyzing...
                </div>
                <button class="refresh-btn" onclick="triggerAIAnalysis()" style="background: white; border: 1px solid rgba(255,255,255,0.3); margin-left: 1rem;">
                    <span style="color: var(--award-gold); font-weight: 600;">AI</span> <span style="color: var(--blazer-navy);">Analysis</span>
                </button>
            </div>
            <div class="panel-content">
                <div class="family-cards-container" id="familyCards">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading family data...
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>Recent Activity</h2>
                <div style="font-size: 0.9rem; opacity: 0.9;">
                    Latest family activity
                </div>
            </div>
            <div class="panel-content">
                <div class="activity-feed" id="activityFeed">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading activity...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let dashboardData = {
            families: [],
            activities: [],
            metrics: {}
        };

        let autoRefreshInterval;
        let isRefreshing = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            loadDashboardData();
            setupEventListeners();
            startAutoRefresh();
        });

        function setupEventListeners() {
            document.getElementById('searchBox').addEventListener('input', filterFamilies);
            document.getElementById('sortFilter').addEventListener('change', filterFamilies);
            document.getElementById('statusFilter').addEventListener('change', filterFamilies);
            document.getElementById('entryYearFilter').addEventListener('change', filterFamilies);
            
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        }

        async function loadDashboardData() {
            if (isRefreshing) return;
            isRefreshing = true;
            
            try {
                console.log('Fetching real data from server.js endpoints...');
                
                document.getElementById('refreshIcon').style.animation = 'spin 1s linear infinite';
                
                const [dashboardResponse, inquiriesResponse] = await Promise.all([
                    fetch('/api/dashboard-data'),
                    fetch('/api/analytics/inquiries')
                ]);
                
                if (!dashboardResponse.ok) {
                    throw new Error(`Dashboard API failed: ${dashboardResponse.status}`);
                }
                
                if (!inquiriesResponse.ok) {
                    throw new Error(`Inquiries API failed: ${inquiriesResponse.status}`);
                }
                
                const dashboardApiData = await dashboardResponse.json();
                const inquiriesApiData = await inquiriesResponse.json();
                
                console.log('Dashboard API data:', dashboardApiData);
                console.log('Inquiries API data:', Array.isArray(inquiriesApiData) ? inquiriesApiData.length : 'object', 'families');
                
                dashboardData.families = processServerInquiries(inquiriesApiData);
                dashboardData.activities = processServerActivity(dashboardApiData.recentlyActive || []);
                dashboardData.metrics = processServerMetrics(dashboardApiData.summary || {}, dashboardData.families);
                
                console.log('Processed data:', {
                    families: dashboardData.families.length,
                    activities: dashboardData.activities.length,
                    metrics: dashboardData.metrics
                });
                
                updateMetrics();
                renderFamilyCards();
                renderActivityFeed();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showError('Failed to load real data', error.message);
            } finally {
                isRefreshing = false;
                document.getElementById('refreshIcon').style.animation = '';
            }
        }

        function processServerInquiries(inquiriesData) {
            console.log('Processing server inquiries data...');
            
            if (!Array.isArray(inquiriesData)) {
                console.warn('Expected array, got:', typeof inquiriesData);
                return [];
            }
            
            return inquiriesData.map(family => {
                const interests = [];
                const interestFields = [
                    'sciences', 'mathematics', 'english', 'languages', 'humanities', 'business',
                    'drama', 'music', 'art', 'creative_writing', 'sport', 'leadership',
                    'community_service', 'outdoor_education', 'academic_excellence',
                    'pastoral_care', 'university_preparation', 'personal_development',
                    'career_guidance', 'extracurricular_opportunities'
                ];
                
                interestFields.forEach(field => {
                    if (family[field] === true) {
                        interests.push(field.charAt(0).toUpperCase() + field.slice(1).replace('_', ' '));
                    }
                });
                
                const dwellMs = family.dwell_ms || 0;
                const returnVisits = family.return_visits || 1;
                
                const engagementScore = family.engagement ? family.engagement.engagementScore : 
                    calculateEngagementScoreFromServer({
                        timeOnPage: dwellMs,
                        totalVisits: returnVisits,
                        scrollDepth: 50,
                        clickCount: Math.floor(dwellMs / 10000)
                    });
                
                let temperature = 'low';
                if (engagementScore >= 70) temperature = 'hot';
                else if (engagementScore >= 50) temperature = 'warm';
                else if (engagementScore >= 30) temperature = 'cold';
                
                return {
                    id: family.id,
                    firstName: family.first_name,
                    familySurname: family.family_surname,
                    parentEmail: family.parent_email,
                    entryYear: family.entry_year,
                    ageGroup: family.age_group,
                    receivedAt: family.received_at,
                    status: family.status,
                    
                    dwellMs: dwellMs,
                    returnVisits: returnVisits,
                    engagementScore: engagementScore,
                    temperature: temperature,
                    
                    aiEngagement: family.ai_engagement || family.aiEngagement || null,
                    hasAIAnalysis: !!(family.ai_engagement || family.aiEngagement),
                    
                    slug: family.slug,
                    prospectusUrl: family.prospectus_pretty_url || family.prospectus_direct_url || null,
                    prospectusFilename: family.prospectus_filename,
                    prospectusGeneratedAt: family.prospectus_generated_at,
                    
                    interests: interests,
                    contactReady: family.status === 'prospectus_generated',
                    isOnline: isRecentActivity(family.updated_at || family.received_at),
                    
                    country: family.country || 'Unknown',
                    region: family.region || 'Unknown',
                    city: family.city || 'Unknown'
                };
            });
        }

        function processServerActivity(recentActivityData) {
            if (!Array.isArray(recentActivityData) || recentActivityData.length === 0) {
                return dashboardData.families ? dashboardData.families.slice(0, 10).map(family => ({
                    family: `${family.firstName} ${family.familySurname}`,
                    action: getServerActivityDescription(family.activity || 'Recently inquired'),
                    time: formatTimeAgo(new Date(family.receivedAt)),
                    type: getServerActivityPriority(family.activity || 'inquiry'),
                    timestamp: family.receivedAt
                })) : [];
            }
            
            return recentActivityData.slice(0, 20).map(activity => ({
                family: activity.name || 'Unknown Family',
                action: getServerActivityDescription(activity.activity || 'inquiry'),
                time: formatTimeAgo(new Date(activity.when || activity.timestamp)),
                type: getServerActivityPriority(activity.activity || 'inquiry'),
                timestamp: activity.when || activity.timestamp
            }));
        }

        function processServerMetrics(summary, families) {
            const aiAnalyzedCount = families.filter(f => f.hasAIAnalysis).length;
            
            return {
                hotLeads: summary.hotLeads || families.filter(f => f.temperature === 'hot').length,
                warmLeads: summary.warmLeads || families.filter(f => f.temperature === 'warm').length,
                aiAnalyzed: aiAnalyzedCount,
                totalFamilies: summary.totalFamilies || families.length
            };
        }

        function calculateEngagementScoreFromServer(engagement) {
            if (!engagement) return 0;
            let score = 0;
            
            const timeMinutes = (engagement.timeOnPage || 0) / 60000;
            if (timeMinutes >= 30) score += 40;
            else if (timeMinutes >= 15) score += 30;
            else if (timeMinutes >= 5) score += 20;
            else score += Math.min(timeMinutes * 4, 15);
            
            const scrollDepth = engagement.scrollDepth || 0;
            score += Math.min(scrollDepth * 0.3, 30);
            
            const visits = engagement.totalVisits || 1;
            if (visits >= 7) score += 20;
            else if (visits >= 4) score += 15;
            else if (visits >= 2) score += 10;
            else score += 5;
            
            const clicks = engagement.clickCount || 0;
            score += Math.min(clicks * 2, 10);
            
            return Math.min(Math.round(score), 100);
        }

        function getServerActivityDescription(activityType) {
            const descriptions = {
                'inquiry': 'Submitted inquiry',
                'Recently inquired': 'Recently inquired',
                'prospectus_generated': 'Prospectus generated',
                'page_load': 'Opened prospectus',
                'engagement': 'Engaged with content'
            };
            
            return descriptions[activityType] || `${activityType.replace(/_/g, ' ')} activity`;
        }

        function getServerActivityPriority(activityType) {
            const highPriority = ['prospectus_generated', 'high_engagement'];
            const mediumPriority = ['inquiry', 'Recently inquired', 'engagement'];
            
            if (highPriority.includes(activityType)) return 'high';
            if (mediumPriority.includes(activityType)) return 'medium';
            return 'low';
        }

        function isRecentActivity(timestamp) {
            if (!timestamp) return false;
            const now = new Date();
            const diffMinutes = (now - new Date(timestamp)) / (1000 * 60);
            return diffMinutes < 30;
        }

        function formatLocation(family) {
            console.log('Location data for', family.firstName, ':', {
                city: family.city,
                country: family.country,
                region: family.region
            });

            const city = family.city && family.city !== 'Unknown' && family.city !== 'Location pending' ? family.city : null;
            const country = family.country && family.country !== 'Unknown' ? family.country : null;

            if (city && country) {
                return `${city}, ${country}`;
            } else if (country && country !== 'Unknown') {
                return country;
            } else if (city && city !== 'Unknown') {
                return city;
            } 

            const rawLocation = [family.city, family.region, family.country]
                .filter(loc => loc && loc !== 'Unknown' && loc !== 'null')
                .join(', ');
        
            return rawLocation || 'Location data not captured';
        }

        function formatDwellTime(milliseconds) {
            if (!milliseconds || milliseconds === 0) return '0 sec';
            
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function updateMetrics() {
            const metrics = dashboardData.metrics;
            
            document.getElementById('hotLeads').textContent = metrics.hotLeads || 0;
            document.getElementById('warmLeads').textContent = metrics.warmLeads || 0;
            document.getElementById('aiAnalyzed').textContent = metrics.aiAnalyzed || 0;
            document.getElementById('totalFamilies').textContent = metrics.totalFamilies || 0;
            
            console.log('Updated metrics:', metrics);
        }

        function renderFamilyCards() {
            const container = document.getElementById('familyCards');
            const families = getFilteredFamilies();
            
            console.log('Rendering', families.length, 'family cards');
            
            if (families.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <div class="error-title">No Family Data Found</div>
                        <p>No inquiries match your current filters or no data available from server.js endpoints.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = families.map(family => {
                let aiInsightsHTML = '';
                if (family.hasAIAnalysis && family.aiEngagement) {
                    const ai = family.aiEngagement;
                    aiInsightsHTML = `
                        <div class="ai-insights-section">
                            <div class="ai-insights-header">
                                <span class="ai-badge">AI ANALYZED</span>
                            </div>
                            <div class="ai-narrative">
                                ${ai.narrative || 'AI analysis completed'}
                            </div>
                            ${ai.highlights && ai.highlights.length > 0 ? `
                                <div style="font-size: 0.8rem;">
                                    ${ai.highlights.map(highlight => `<div>${highlight}</div>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="family-card" data-id="${family.id}">
                        <div class="family-card-header" onclick="toggleFamilyCard('${family.id}')">
                            <div class="family-info">
                                <div class="family-name">
                                    <div class="status-indicator ${family.isOnline ? 'online' : 'offline'}"></div>
                                    ${family.firstName} ${family.familySurname} Family
                                </div>
                                <div class="family-meta">
                                    <span>Entry ${family.entryYear || 'TBC'}</span>
                                    <span>${formatDwellTime(family.dwellMs)}</span>
                                    <span>${family.returnVisits} visits</span>
                                    ${family.hasAIAnalysis ? '<span style="color: var(--award-gold); font-weight: 600;">AI</span>' : ''}
                                    <span>${formatTimeAgo(new Date(family.receivedAt))}</span>
                                </div>
                            </div>
                            <div class="family-score">
                                <div class="score-badge ${family.temperature}">
                                    ${family.engagementScore}
                                </div>
                                <div class="expand-btn">▼</div>
                            </div>
                        </div>
                        <div class="family-card-details">
                            <div class="family-details-content">
                                ${aiInsightsHTML}
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <h4>Real Engagement Data</h4>
                                        <p>Total dwell time: ${formatDwellTime(family.dwellMs)}</p>
                                        <p>Return visits: ${family.returnVisits}</p>
                                        <p>Engagement Score: ${family.engagementScore}/100</p>
                                        <p>Status: ${family.status}</p>
                                        <button class="action-btn btn-primary" onclick="loadSectionDetails('${family.id}')">
                                            View Section Details
                                        </button>
                                    </div>
                                    <div class="detail-item">
                                        <h4>Contact Info</h4>
                                        <p>Email: ${family.parentEmail || 'Not provided'}</p>
                                        <p>Age Group: ${family.ageGroup || 'Unknown'}</p>
                                        <p>Location: ${formatLocation(family)}</p>
                                        <p>${family.contactReady ? 'Ready for contact' : 'Continue nurturing'}</p>
                                        <button class="action-btn btn-secondary" onclick="checkGeoLocation('${family.id}')">
                                            Debug Location
                                        </button>
                                    </div>
                                    <div class="detail-item">
                                        <h4>Prospectus Links</h4>
                                        ${family.slug ? `<p>Slug: <code>${family.slug}</code></p>` : '<p>Slug: Not generated</p>'}
                                        ${family.prospectusUrl ? `
                                            <p>Pretty URL: <a href="${family.prospectusUrl}" target="_blank" style="color: var(--sport-blue); text-decoration: none; font-weight: 600;">${family.prospectusUrl.split('/').pop()}</a></p>
                                            <button class="action-btn btn-success" onclick="copyToClipboard('${family.prospectusUrl}')">
                                                Copy Link
                                            </button>
                                        ` : `
                                            <p>Prospectus: Not generated</p>
                                            <button class="action-btn btn-primary" onclick="generateProspectusFor('${family.id}')">
                                                Generate Now
                                            </button>
                                        `}
                                    </div>
                                    <div class="detail-item">
                                        <h4>Interests</h4>
                                        <div class="interests-tags">
                                            ${family.interests && family.interests.length > 0 ? 
                                                family.interests.map(interest => `<span class="interest-tag">${interest}</span>`).join('') :
                                                '<span class="interest-tag">No interests selected</span>'
                                            }
                                        </div>
                                        <h4 style="margin-top: 1rem;">AI Analysis</h4>
                                        ${family.hasAIAnalysis ? 
                                            '<p style="color: var(--success);">AI insights available</p>' :
                                            '<p style="color: var(--warning);">Not yet analyzed</p>'
                                        }
                                        <button class="action-btn btn-secondary" onclick="analyzeIndividualFamily('${family.id}')">
                                            ${family.hasAIAnalysis ? 'Re-analyze' : 'Analyze Family'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActivityFeed() {
            const container = document.getElementById('activityFeed');
            const activities = dashboardData.activities;
            
            console.log('Rendering', activities.length, 'activity items');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <div class="error-title">No Activity Data</div>
                        <p>No recent activity from server.js endpoint.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-avatar">${activity.family.charAt(0)}</div>
                    <div class="activity-content">
                        <div class="activity-text">
                            <strong>${activity.family}</strong> ${activity.action}
                        </div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                    <div class="activity-type ${activity.type}"></div>
                </div>
            `).join('');
        }

        function getFilteredFamilies() {
            let families = [...dashboardData.families];
            
            const statusFilter = document.getElementById('statusFilter').value;
            const entryYearFilter = document.getElementById('entryYearFilter').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const sortBy = document.getElementById('sortFilter').value;
            
            if (statusFilter !== 'all') {
                if (statusFilter === 'prospectus_generated') {
                    families = families.filter(f => f.contactReady);
                } else if (statusFilter === 'ai_analyzed') {
                    families = families.filter(f => f.hasAIAnalysis);
                } else if (statusFilter === 'recent') {
                    families = families.filter(f => f.isOnline);
                }
            }
            
            if (entryYearFilter !== 'all') {
                if (entryYearFilter === '2027') {
                    families = families.filter(f => f.entryYear >= 2027);
                } else {
                    families = families.filter(f => f.entryYear == entryYearFilter);
                }
            }
            
            if (searchTerm) {
                families = families.filter(f => 
                    `${f.firstName} ${f.familySurname}`.toLowerCase().includes(searchTerm) ||
                    (f.parentEmail || '').toLowerCase().includes(searchTerm)
                );
            }
            
            switch (sortBy) {
                case 'engagement':
                    families.sort((a, b) => b.engagementScore - a.engagementScore);
                    break;
                case 'recent':
                    families.sort((a, b) => new Date(b.receivedAt) - new Date(a.receivedAt));
                    break;
                case 'inquiryDate':
                    families.sort((a, b) => new Date(b.receivedAt) - new Date(a.receivedAt));
                    break;
                case 'entryYear':
                    families.sort((a, b) => (a.entryYear || 0) - (b.entryYear || 0));
                    break;
            }
            
            return families;
        }

        function filterFamilies() {
            renderFamilyCards();
        }

        function toggleFamilyCard(familyId) {
            const card = document.querySelector(`[data-id="${familyId}"]`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        function refreshDashboard() {
            console.log('Manual refresh triggered');
            loadDashboardData();
        }

        function startAutoRefresh() {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(() => {
                if (document.getElementById('autoRefresh').checked) {
                    console.log('Auto refresh triggered');
                    loadDashboardData();
                }
            }, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        async function triggerAIAnalysis() {
            const aiStatusElement = document.getElementById('aiStatus');
            const buttonElement = document.querySelector('.refresh-btn[onclick="triggerAIAnalysis()"]');
            
            if (aiStatusElement) aiStatusElement.style.display = 'flex';
            if (buttonElement) buttonElement.disabled = true;
            
            try {
                console.log('Starting AI analysis via server.js /api/ai/analyze-all-families...');
                
                const response = await fetch('/api/ai/analyze-all-families', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('AI Analysis completed:', result);
                    
                    await loadDashboardData();
                    
                    if (result.success) {
                        alert(`AI Analysis completed!\n\nProcessed: ${result.count} families\nResults: ${result.results?.length || 0} analyzed`);
                    } else {
                        alert('AI Analysis completed with errors. Check console.');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(`AI Analysis failed: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('AI Analysis error:', error);
                alert(`AI Analysis failed: ${error.message}`);
            } finally {
                if (aiStatusElement) aiStatusElement.style.display = 'none';
                if (buttonElement) buttonElement.disabled = false;
            }
        }

        async function loadSectionDetails(inquiryId) {
            try {
                console.log(`Loading section details for inquiry: ${inquiryId}`);
                
                const response = await fetch(`/api/section-data/${inquiryId}`);
                if (!response.ok) {
                    throw new Error(`Section data API failed: ${response.status}`);
                }
                
                const sectionData = await response.json();
                console.log('Section data received:', sectionData);
                
                showSectionDetailsModal(sectionData);
                
            } catch (error) {
                console.error('Failed to load section details:', error);
                alert(`Failed to load section details: ${error.message}`);
            }
        }

        function showSectionDetailsModal(sectionData) {
            const modalHtml = `
                <div id="sectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto; margin: 1rem;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; color: var(--blazer-navy);">Detailed Section Breakdown</h3>
                            <button onclick="closeSectionModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; margin-left: auto;">&times;</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--light-grey); padding: 1rem; border-radius: 8px;">
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--sport-blue);">Total Engagement</h4>
                                <p style="margin: 0; font-size: 1.2rem; font-weight: 600;">${formatDwellTime(sectionData.totalDwellMs)}</p>
                                <p style="margin: 0; font-size: 0.9rem; color: #64748b;">${sectionData.visitCount} visits • Score: ${sectionData.engagementScore}/100</p>
                            </div>
                            <div style="background: var(--light-grey); padding: 1rem; border-radius: 8px;">
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--sport-blue);">Section Coverage</h4>
                                <p style="margin: 0; font-size: 1.2rem; font-weight: 600;">${sectionData.sections.length} sections explored</p>
                                <p style="margin: 0; font-size: 0.9rem; color: #64748b;">${sectionData.hasData ? 'Detailed tracking active' : 'Basic tracking only'}</p>
                            </div>
                        </div>

                        <h4 style="margin: 1rem 0 0.5rem 0; color: var(--blazer-navy);">Section-by-Section Breakdown</h4>
                        ${sectionData.sections.length > 0 ? `
                            <div style="display: grid; gap: 0.5rem;">
                                ${sectionData.sections.map(section => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 6px; border-left: 4px solid var(--award-gold);">
                                        <div>
                                            <strong style="color: var(--blazer-navy);">${section.section_name}</strong>
                                            <div style="font-size: 0.85rem; color: #64748b;">
                                                ${formatDwellTime(section.dwell_seconds * 1000)} • ${section.max_scroll_pct}% scrolled • ${section.clicks} clicks
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="background: var(--award-gold); color: var(--blazer-navy); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                                ${section.dwell_minutes}min
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 2rem; color: #64748b;">
                                <p>No detailed section data available yet.</p>
                                <p style="font-size: 0.9rem;">Section tracking will appear once the family engages with their prospectus.</p>
                            </div>
                        `}

                        <div style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 8px; border: 1px solid #bfdbfe;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--sport-blue);">Key Insights</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #475569;">
                                <li>Total engagement: ${formatDwellTime(sectionData.totalDwellMs)}</li>
                                <li>${sectionData.sections.length} sections explored with meaningful time spent</li>
                                <li>${sectionData.visitCount > 1 ? sectionData.visitCount + ' visits showing sustained interest' : 'Single comprehensive visit'}</li>
                                <li>Ready for targeted follow-up conversation</li>
                                <li>Strong engagement indicates serious interest</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeSectionModal() {
            const modal = document.getElementById('sectionModal');
            if (modal) {
                modal.remove();
            }
        }

        async function analyzeIndividualFamily(inquiryId) {
            try {
                console.log(`Analyzing individual family: ${inquiryId}`);
                
                const response = await fetch(`/api/ai/analyze-family/${inquiryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Individual analysis completed:', result);
                    
                    await loadDashboardData();
                    
                    if (result.success) {
                        alert(`Analysis completed for ${result.message.split(' for ')[1]}`);
                    } else {
                        alert('Analysis failed. Check console for details.');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(`Individual analysis failed: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('Individual analysis error:', error);
                alert(`Individual analysis failed: ${error.message}`);
            }
        }

        async function generateProspectusFor(inquiryId) {
            try {
                console.log(`Generating prospectus for inquiry ${inquiryId}...`);
                
                const response = await fetch(`/api/generate-prospectus/${inquiryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Prospectus generated:', result);
                    
                    await loadDashboardData();
                    
                    alert(`Prospectus generated successfully!\n\nYou can now access it from the family card.`);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(`Generation failed: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('Prospectus generation error:', error);
                alert(`Failed to generate prospectus: ${error.message}`);
            }
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                alert('URL copied to clipboard!');
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('URL copied to clipboard!');
            }
        }

        async function checkGeoLocation(inquiryId) {
            try {
                const ipResponse = await fetch('/api/debug/ip');
                const ipData = await ipResponse.json();
                
                console.log('Current IP detection:', ipData);
                
                alert(`IP Detection Debug:
                
Detected IP: ${ipData.ip || 'None detected'}
Country: ${ipData.geo?.country || 'Unknown'}
City: ${ipData.geo?.city || 'Unknown'}

Headers:
- X-Forwarded-For: ${ipData.headers['x-forwarded-for'] || 'Not set'}
- CF-Connecting-IP: ${ipData.headers['cf-connecting-ip'] || 'Not set'}
- X-Real-IP: ${ipData.headers['x-real-ip'] || 'Not set'}

Note: Local IPs (127.0.0.1, 192.168.x.x) are filtered out.
Deploy to production for real IP detection.`);
                
            } catch (error) {
                console.error('Failed to check geo location:', error);
                alert(`Geo location debug failed: ${error.message}`);
            }
        }

        function showError(title, message) {
            console.error('Dashboard Error:', title, message);
            
            const familyContainer = document.getElementById('familyCards');
            const activityContainer = document.getElementById('activityFeed');
            
            const errorHtml = `
                <div class="error">
                    <div class="error-title">${title}</div>
                    <p>${message}</p>
                    <p>Check server.js endpoints and console for details.</p>
                </div>
            `;
            
            familyContainer.innerHTML = errorHtml;
            activityContainer.innerHTML = errorHtml;
        }
    </script>
</body>
</html>