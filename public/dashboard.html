<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>More House SMART Analytics Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0a2540;
  --gold: #ff9f1c;
  --green: #10b981;
  --red: #ef4444;
  --amber: #f59e0b;
  --slate: #64748b;
  --grey-50: #f8fafc;
  --grey-100: #f1f5f9;
  --grey-200: #e2e8f0;
  --grey-300: #cbd5e1;
  --grey-600: #475569;
}

* { box-sizing: border-box; }
body {
  margin: 0; background: var(--grey-50); color: var(--navy);
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.header {
  background: white; border-bottom: 1px solid var(--grey-200);
  position: sticky; top: 0; z-index: 10;
}
.header-content {
  max-width: 1200px; margin: 0 auto; padding: 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.header h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: 0.2px; }
.header-controls { display: flex; gap: 12px; align-items: center; }

.btn { padding: 8px 16px; border: 1px solid transparent; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: var(--gold); color: var(--navy); }
.btn-secondary { background: white; color: var(--grey-600); border: 1px solid var(--grey-200); }
.btn:hover { filter: brightness(0.98); }

.status { padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid var(--grey-200); background: #fff; color: var(--slate); }
.status-loading { background: #fff7ed; border-color: #fed7aa; color: #9a3412; }
.status-ready { background: #ecfeff; border-color: #a5f3fc; color: #155e75; }

.main-content { max-width: 1200px; margin: 20px auto; padding: 0 16px; display: grid; gap: 16px; }

.card { background: white; border: 1px solid var(--grey-200); border-radius: 10px; overflow: hidden; }
.card-header { padding: 14px 16px; border-bottom: 1px solid var(--grey-200); display: flex; align-items: center; justify-content: space-between; }
.card-title { margin: 0; font-size: 16px; font-weight: 700; }
.card-body { padding: 20px; }

.metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
.metric { background: white; border: 1px solid var(--grey-200); border-radius: 10px; padding: 16px; text-align: center; }
.metric-value { font-size: 28px; font-weight: 700; color: var(--navy); }
.metric-label { font-size: 13px; color: var(--slate); margin-top: 4px; }

.families { display: grid; gap: 12px; }
.family-row { border: 1px solid var(--grey-200); border-radius: 10px; padding: 14px; background: #fff; }
.family-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.family-name { font-size: 16px; font-weight: 700; }
.family-meta { font-size: 13px; color: var(--slate); }
.family-stats { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.stat-badge { background: var(--grey-100); border: 1px solid var(--grey-200); border-radius: 999px; padding: 4px 8px; font-size: 12px; }
.score-badge { background: #ecfeff; border: 1px solid #a5f3fc; color: #155e75; border-radius: 999px; padding: 4px 10px; font-weight: 700; font-size: 12px; }

.ai-summary { background: #fffaf0; border: 1px solid #fde68a; color: #713f12; border-radius: 8px; padding: 10px 12px; margin-top: 10px; font-size: 14px; }

.section-grid { margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 900px) { .section-grid { grid-template-columns: 1fr; } }

.section-card { border: 1px solid var(--grey-200); border-radius: 8px; overflow: hidden; background: #fff; }
.section-card h3 { margin: 0; padding: 10px 12px; font-size: 13px; font-weight: 700; background: var(--grey-100); border-bottom: 1px solid var(--grey-200); }
.section-card .pad { padding: 10px 12px; }

.section-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.section-table th, .section-table td { border-bottom: 1px solid var(--grey-200); padding: 6px 8px; text-align: left; }
.section-table th { color: var(--slate); font-weight: 600; }

.kv { display: grid; grid-template-columns: 160px 1fr; gap: 6px 10px; font-size: 13px; }
.kv .k { color: var(--slate); }
.kv .v { color: var(--navy); }

pre.raw { background: #0b1020; color: #e5e7eb; border-radius: 8px; padding: 10px; font-size: 12px; max-height: 260px; overflow: auto; }

.debug { white-space: pre-wrap; font-size: 12px; color: var(--slate); background: #fff; border: 1px dashed var(--grey-200); border-radius: 8px; padding: 10px; max-height: 160px; overflow: auto; }

.loading { color: var(--slate); font-size: 14px; }
.link { color: var(--gold); text-decoration: none; border-bottom: 1px dashed var(--gold); }
</style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1>More House <span style="color: var(--gold);">SMART</span> Analytics</h1>
      <div class="header-controls">
        <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
        <button id="analyzeBtn" class="btn btn-primary">Run SMART AI Analysis</button>
        <div id="status" class="status status-ready">Ready</div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <section class="card">
      <div class="card-header">
        <h2 class="card-title">Family Enquiries</h2>
      </div>
      <div class="card-body">
        <div class="metrics">
          <div class="metric">
            <div id="hotCount" class="metric-value">0</div>
            <div class="metric-label">Hot Leads</div>
          </div>
          <div class="metric">
            <div id="warmCount" class="metric-value">0</div>
            <div class="metric-label">Warm Leads</div>
          </div>
          <div class="metric">
            <div id="aiCount" class="metric-value">0</div>
            <div class="metric-label">AI Analysed</div>
          </div>
          <div class="metric">
            <div id="totalCount" class="metric-value">0</div>
            <div class="metric-label">Total Families</div>
          </div>
        </div>

        <div id="familiesList" class="families">
          <div class="loading">Loading families…</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2 class="card-title">Debug / Endpoint Status</h2>
      </div>
      <div class="card-body">
        <div id="debugLog" class="debug"></div>
      </div>
    </section>
  </main>

<script>
class Dashboard {
  constructor() {
    this.elements = {
      status: document.getElementById('status'),
      debugLog: document.getElementById('debugLog'),
      familiesList: document.getElementById('familiesList'),
      refreshBtn: document.getElementById('refreshBtn'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      hotCount: document.getElementById('hotCount'),
      warmCount: document.getElementById('warmCount'),
      aiCount: document.getElementById('aiCount'),
      totalCount: document.getElementById('totalCount'),
    };

    this.bind();
    this.boot();
  }

  bind() {
    this.elements.refreshBtn.addEventListener('click', () => this.boot());
    this.elements.analyzeBtn.addEventListener('click', () => this.runAI());
  }

  log(message) {
    const ts = new Date().toLocaleTimeString();
    this.elements.debugLog.textContent += `\n[${ts}] ${message}`;
    this.elements.debugLog.scrollTop = this.elements.debugLog.scrollHeight;
    console.log(message);
  }

  setStatus(text, type = 'ready') {
    this.elements.status.textContent = text;
    this.elements.status.className = `status status-${type}`;
  }

  async checkEndpoints() {
    this.log('Checking API endpoints…');
    const endpoints = ['/health','/api/analytics/inquiries','/api/dashboard-data'];
    const results = [];
    for (const ep of endpoints) {
      try {
        const res = await fetch(ep);
        const isJson = res.headers.get('content-type')?.includes('application/json');
        results.push(`${ep}: ${res.status} ${isJson ? '(JSON)' : '(HTML)'}`);
        if (!isJson && res.ok) this.log(`WARNING: ${ep} returned HTML instead of JSON`);
      } catch (e) {
        results.push(`${ep}: ERROR ${e.message}`);
      }
    }
    this.log(results.join(' | '));
  }

  async boot() {
    this.setStatus('Loading…', 'loading');
    await this.checkEndpoints();

    try {
      // Preferred list endpoint
      const listRes = await fetch('/api/analytics/inquiries');
      const isJson = listRes.headers.get('content-type')?.includes('application/json');
      if (!isJson) throw new Error('/api/analytics/inquiries responded with HTML');

      const families = await listRes.json();
      this.renderFamilies(Array.isArray(families) ? families : (families?.items || []));
      await this.loadDashboardMetrics();
      this.setStatus('Ready', 'ready');
    } catch (err) {
      this.log(`Primary list failed: ${err.message}. Falling back to /api/dashboard-data`);
      try {
        const fallback = await fetch('/api/dashboard-data');
        const fbJson = await fallback.json();
        this.renderFromDashboard(fbJson || {});
        this.setStatus('Ready (fallback)', 'ready');
      } catch (e2) {
        this.elements.familiesList.innerHTML = '<div class="loading">No families found</div>';
        this.setStatus('Error', 'loading');
        this.log('Fallback failed: ' + e2.message);
      }
    }
  }

  async loadDashboardMetrics() {
    try {
      const res = await fetch('/api/dashboard-data');
      if (!res.ok) return;
      const data = await res.json();
      if (!data || !data.summary) return;

      this.elements.hotCount.textContent = data.summary.hotLeads ?? 0;
      this.elements.warmCount.textContent = data.summary.warmLeads ?? 0;
      this.elements.aiCount.textContent = data.summary.aiAnalyzed ?? 0;
      this.elements.totalCount.textContent = data.summary.totalFamilies ?? 0;
    } catch {}
  }

  renderFamilies(families) {
    this.log(`Rendering ${families.length} families`);
    if (!families.length) {
      this.elements.familiesList.innerHTML = '<div class="loading">No families found</div>';
      return;
    }
    this.elements.familiesList.innerHTML = '';
    families.forEach(fam => {
      const row = this.createFamilyRow(fam);
      this.elements.familiesList.appendChild(row);
      this.loadFamilyData(fam.id || fam.inquiry_id, row);
    });

    // Top counters (simple client-side estimation if dashboard-data lacks)
    const hot = families.filter(f => this.calculateScore(f) >= 75).length;
    const warm = families.filter(f => this.calculateScore(f) >= 50 && this.calculateScore(f) < 75).length;
    const ai = families.length; // treated as “analysable” list
    this.elements.hotCount.textContent = hot;
    this.elements.warmCount.textContent = warm;
    this.elements.aiCount.textContent = ai;
    this.elements.totalCount.textContent = families.length;
  }

  createFamilyRow(family) {
    const name = `${family.first_name || ''} ${family.family_surname || ''}`.trim() || 'Unknown';
    const email = family.parent_email || '';
    const entryYear = family.entry_year || '';
    const dwellMs = parseInt(family.dwell_ms || 0);
    const score = this.calculateScore(family);
    const prospectusUrl =
      family.prospectus_pretty_url || family.pretty_path || family.slug || family.prospectus_url || '';

    const row = document.createElement('div');
    row.className = 'family-row';

    row.innerHTML = `
      <div class="family-header">
        <div>
          <div class="family-name">${this.escapeHtml(name)} ${entryYear ? `<span style="color: var(--slate);">(${entryYear})</span>` : ''}</div>
          <div class="family-meta">${this.escapeHtml(email)}</div>
        </div>
        <div class="family-stats">
          <div class="stat-badge">Time: ${this.formatTime(dwellMs)}</div>
          <div class="stat-badge">Visits: <span data-visits>1</span></div>
          <div class="score-badge">${score}</div>
          ${prospectusUrl ? `<a class="btn btn-secondary" href="${prospectusUrl}" target="_blank" rel="noopener">Open prospectus</a>` : ''}
        </div>
      </div>

      <div class="ai-summary" data-summary>Loading engagement data…</div>

      <div class="section-grid">
        <div class="section-card">
          <h3>Top sections</h3>
          <div class="pad">
            <table class="section-table" data-sections style="display:none">
              <thead><tr><th>Section</th><th>Time</th><th>Scroll</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="loading" data-sections-empty style="display:none">No section data yet</div>
            <button class="btn btn-secondary" onclick="app.regenerateAI('${family.id || family.inquiry_id}')">Regenerate AI</button>
          </div>
        </div>

        <div class="section-card">
          <h3>Geolocation</h3>
          <div class="pad">
            <div class="kv" data-geo>
              <div class="k">IP address</div><div class="v">—</div>
              <div class="k">Country</div><div class="v">—</div>
              <div class="k">City</div><div class="v">—</div>
              <div class="k">Coordinates</div><div class="v">—</div>
            </div>
          </div>
        </div>

        <div class="section-card" style="grid-column: 1 / -1;">
          <h3>Raw data</h3>
          <div class="pad">
            <pre class="raw" data-raw>{"loading": true}</pre>
          </div>
        </div>
      </div>
    `;
    return row;
  }

  async loadFamilyData(inquiryId, row) {
    try {
      // Engagement / sections
      const engRes = await fetch(`/api/family/${inquiryId}/engagement`);
      if (engRes.ok) {
        const eng = await engRes.json();
        const visits = row.querySelector('[data-visits]');
        if (visits && eng.visits != null) visits.textContent = eng.visits;

        if (eng.sections && eng.sections.length) {
          this.renderSectionData(row, eng);
        } else {
          row.querySelector('[data-sections]').style.display = 'none';
          row.querySelector('[data-sections-empty]').style.display = 'block';
        }
      }

      // AI summary
      const aiRes = await fetch(`/api/ai/engagement-summary/${inquiryId}`);
      if (aiRes.ok) {
        const ai = await aiRes.json();
        const summary = row.querySelector('[data-summary]');
        if (summary) summary.textContent = ai.summaryText || ai.summary || ai.narrative || 'No AI summary yet';
      }

      // NEW: detail (for Geo + Raw) — non-breaking if route missing
      await this.loadDetailGeoAndRaw(inquiryId, row);

    } catch (e) {
      this.log(`Failed to load data for ${inquiryId}: ${e.message}`);
      const summary = row.querySelector('[data-summary]');
      if (summary) { summary.textContent = 'Additional data unavailable'; summary.style.color = 'var(--slate)'; }
    }
  }

  async loadDetailGeoAndRaw(inquiryId, row) {
    try {
      const res = await fetch(`/api/family/${inquiryId}`);
      if (!res.ok) throw new Error(`/api/family/${inquiryId} -> ${res.status}`);
      const detail = await res.json();

      // Render Raw (pretty)
      const rawEl = row.querySelector('[data-raw]');
      if (rawEl) rawEl.textContent = JSON.stringify(detail, null, 2);

      // Render Geo
      const geoEl = row.querySelector('[data-geo]');
      if (geoEl) {
        const v = (k) => (detail[k] ?? detail?.geo?.[k] ?? detail?.location?.[k] ?? null);
        const ip = v('ip_address') || v('ip') || '—';
        const country = v('country') || '—';
        const city = v('city') || '—';
        const lat = v('geo_lat') ?? v('lat') ?? null;
        const lon = v('geo_lon') ?? v('lon') ?? null;
        const coords = (lat != null && lon != null) ? `${lat}, ${lon}` : '—';

        const slots = geoEl.querySelectorAll('.v');
        if (slots[0]) slots[0].textContent = ip;
        if (slots[1]) slots[1].textContent = country;
        if (slots[2]) slots[2].textContent = city;
        if (slots[3]) slots[3].textContent = coords;
      }
    } catch (e) {
      this.log(`Geo/Raw load failed for ${inquiryId}: ${e.message}`);
      // Leave placeholders; panel stays visible so you can see it's missing
    }
  }

  renderSectionData(row, data) {
    const table = row.querySelector('[data-sections]');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = (data.sections || []).slice(0, 5).map(s => `
      <tr>
        <td>${this.escapeHtml(s.label || s.section || s.current_section || 'Unnamed')}</td>
        <td>${this.formatTime(s.dwell_ms || s.dwell || 0)}</td>
        <td>${(s.max_scroll ?? s.scroll_depth ?? 0)}%</td>
      </tr>
    `).join('');
    table.style.display = 'table';
    row.querySelector('[data-sections-empty]').style.display = 'none';
  }

  async runAI() {
    this.setStatus('Running AI…', 'loading');
    this.log('Starting AI analysis…');
    try {
      const res = await fetch('/api/ai/analyze-all-families', { method: 'POST' });
      const data = await res.json();
      if (res.ok && data.success) {
        this.log('AI analysis completed successfully');
        this.setStatus('AI complete', 'ready');
        this.boot();
      } else {
        throw new Error(data?.message || 'Unknown AI error');
      }
    } catch (e) {
      this.setStatus('AI error', 'loading');
      this.log('AI run failed: ' + e.message);
    }
  }

  async regenerateAI(inquiryId) {
    try {
      this.setStatus('Regenerating…', 'loading');
      const res = await fetch(`/api/ai/engagement-summary/${inquiryId}`, { method: 'POST' });
      const data = await res.json();
      if (res.ok) {
        const summary = document.querySelector(`[onclick="app.regenerateAI('${inquiryId}')"]`)?.closest('.family-row')?.querySelector('[data-summary]');
        if (summary) summary.textContent = data.summaryText || data.summary || data.narrative || 'No AI summary yet';
        this.setStatus('Ready', 'ready');
      } else {
        throw new Error(data?.message || 'Failed to regenerate');
      }
    } catch (e) {
      this.setStatus('Error', 'loading');
      this.log('Regenerate failed: ' + e.message);
    }
  }

  calculateScore(f) {
    const dwell = +f.dwell_ms || 0;
    const scroll = +f.max_scroll || +f.scroll_depth || 0;
    let score = 0;
    if (dwell > 180000) score += 50; else if (dwell > 60000) score += 35; else if (dwell > 20000) score += 20;
    score += Math.min(40, Math.round(scroll / 2));
    return Math.max(10, Math.min(100, score));
  }

  formatTime(ms) {
    const s = Math.round((+ms||0) / 1000);
    const m = Math.floor(s / 60);
    const r = s % 60;
    return m > 0 ? `${m}m ${r}s` : `${r}s`;
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  renderFromDashboard(data) {
    this.elements.familiesList.innerHTML = '<div class="loading">Using fallback data – some APIs returning HTML</div>';
    if (data.summary) {
      this.elements.hotCount.textContent = data.summary.hotLeads || 0;
      this.elements.warmCount.textContent = data.summary.warmLeads || 0;
      this.elements.aiCount.textContent = data.summary.aiAnalyzed || 0;
      this.elements.totalCount.textContent = data.summary.totalFamilies || 0;
    }
  }
}

const app = new Dashboard();
window.app = app;
</script>
</body>
</html>
