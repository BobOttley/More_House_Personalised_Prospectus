<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>More House SMART Analytics Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--navy:#0a2540;--gold:#ff9f1c;--green:#10b981;--red:#ef4444;--amber:#f59e0b;--slate:#64748b;--grey-50:#f8fafc;--grey-100:#f1f5f9;--grey-200:#e2e8f0;--grey-600:#475569;--grey-900:#0f172a}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--grey-50);color:var(--grey-900);line-height:1.5}
.header{background:linear-gradient(135deg,var(--navy) 0%,#1e40af 100%);color:#fff;padding:20px}
.header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
.header h1{font-size:24px;font-weight:600}
.header-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 14px;border:1px solid transparent;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--gold);color:var(--navy)}
.btn-secondary{background:#fff;color:var(--grey-600);border:1px solid var(--grey-200)}
.status{padding:6px 12px;border-radius:6px;font-size:13px;font-weight:500}
.status-ready{background:rgba(16,185,129,.1);color:var(--green)}
.status-loading{background:rgba(245,158,11,.1);color:var(--amber)}
.status-error{background:rgba(239,68,68,.1);color:var(--red)}
.main-content{max-width:1400px;margin:0 auto;padding:24px 20px;display:grid;grid-template-columns:2fr 1fr;gap:24px}
.card{background:#fff;border:1px solid var(--grey-200);border-radius:12px;overflow:hidden}
.card-header{padding:16px 20px;border-bottom:1px solid var(--grey-200);background:var(--grey-50);display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.card-title{font-size:18px;font-weight:600}
.card-body{padding:20px}
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px}
.metric{background:#fff;border:1px solid var(--grey-200);border-radius:10px;padding:14px;text-align:center}
.metric-value{font-size:26px;font-weight:700;color:var(--navy)}
.metric-label{font-size:13px;color:var(--slate);margin-top:4px}
.families-list{display:flex;flex-direction:column;gap:16px;max-height:70vh;overflow-y:auto}
.family-row{background:#fff;border:1px solid var(--grey-200);border-radius:10px;padding:16px}
.family-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:12px;flex-wrap:wrap}
.family-name{font-size:16px;font-weight:600;margin-bottom:4px}
.family-meta{font-size:13px;color:var(--slate)}
.family-stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.stat-badge{background:var(--grey-100);color:var(--grey-600);padding:4px 8px;border-radius:12px;font-size:12px}
.score-badge{background:var(--navy);color:#fff;padding:6px 10px;border-radius:6px;font-weight:600}
.ai-summary{background:var(--grey-50);padding:12px;border-radius:8px;font-size:14px;color:var(--grey-600);margin:12px 0}
.geo{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.geo span{background:var(--grey-100);border:1px solid var(--grey-200);padding:4px 8px;border-radius:8px;font-size:12px;color:var(--grey-600)}
.section-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.section-table th{background:var(--grey-100);padding:8px;text-align:left;font-weight:600;border-bottom:1px solid var(--grey-200)}
.section-table td{padding:6px 8px;border-bottom:1px solid var(--grey-200)}
.table-actions{margin-top:8px}
.loading{text-align:center;padding:40px;color:var(--slate)}
.error{text-align:center;padding:40px;color:var(--red)}
.debug-log{background:#1a1a1a;color:#e0e0e0;font-family:monospace;font-size:12px;padding:16px;border-radius:8px;max-height:300px;overflow-y:auto;white-space:pre-wrap;margin-top:16px}
.tooltip{border-bottom:1px dashed var(--slate);cursor:help}
.select{border:1px solid var(--grey-200);border-radius:8px;padding:7px 10px;background:#fff;color:var(--grey-900)}
@media (max-width:1200px){.main-content{grid-template-columns:1fr}.metrics{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<header class="header">
  <div class="header-content">
    <h1>More House <span style="color:var(--gold)">SMART</span> Analytics</h1>
    <div class="header-controls">
      <select id="timeframe" class="select" title="Choose timeframe for all metrics">
        <option value="all">All time</option>
        <option value="7d">Last 7 days</option>
        <option value="24h">Last 24 hours</option>
      </select>
      <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
      <button id="analyzeBtn" class="btn btn-primary">Run SMART AI Analysis</button>
      <div id="status" class="status status-ready">Ready</div>
    </div>
  </div>
</header>

<main class="main-content">
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Family Enquiries</h2>
      <div style="font-size:12px;color:var(--slate)">
        Totals use <span class="tooltip" title="Distinct sessions with dwell ≥ 10s within the selected timeframe">clean sessions</span>;
        time shows <span class="tooltip" title="Consistent rounding: mm:ss view; totals use the same base seconds">mm:ss</span>.
      </div>
    </div>
    <div class="card-body">
      <div class="metrics">
        <div class="metric">
          <div id="hotCount" class="metric-value">0</div>
          <div class="metric-label">Hot Leads</div>
        </div>
        <div class="metric">
          <div id="warmCount" class="metric-value">0</div>
          <div class="metric-label">Warm Leads</div>
        </div>
        <div class="metric">
          <div id="aiCount" class="metric-value">0</div>
          <div class="metric-label">AI Analysed</div>
        </div>
        <div class="metric">
          <div id="totalCount" class="metric-value">0</div>
          <div class="metric-label">Total Families</div>
        </div>
      </div>
      <div id="familiesList" class="families-list">
        <div class="loading">Loading families…</div>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="card-header">
      <h2 class="card-title">System Status</h2>
    </div>
    <div class="card-body">
      <div id="systemStatus">
        <div style="margin-bottom:12px"><strong>API Status:</strong> <span id="apiStatus">Checking…</span></div>
        <div style="margin-bottom:12px"><strong>Available Endpoints:</strong><div id="endpointStatus" style="margin-top:6px;font-size:13px">Checking…</div></div>
      </div>
      <div class="debug-log" id="debugLog">Dashboard initialised…</div>
    </div>
  </aside>
</main>

<script>
class Dashboard{
  constructor(){
    this.elements={
      status:document.getElementById('status'),
      familiesList:document.getElementById('familiesList'),
      debugLog:document.getElementById('debugLog'),
      apiStatus:document.getElementById('apiStatus'),
      endpointStatus:document.getElementById('endpointStatus'),
      hotCount:document.getElementById('hotCount'),
      warmCount:document.getElementById('warmCount'),
      aiCount:document.getElementById('aiCount'),
      totalCount:document.getElementById('totalCount'),
      timeframe:document.getElementById('timeframe')
    };
    this.state={timeframe:'all'};
    this.init();
  }

  init(){
    this.log('Dashboard starting…');
    this.elements.timeframe.onchange=()=>{this.state.timeframe=this.elements.timeframe.value;this.refresh();};
    document.getElementById('refreshBtn').onclick=()=>this.refresh();
    document.getElementById('analyzeBtn').onclick=()=>this.runAI();
    this.checkEndpoints();
  }

  log(m){const t=new Date().toLocaleTimeString();this.elements.debugLog.textContent+=`\\n[${t}] ${m}`;this.elements.debugLog.scrollTop=this.elements.debugLog.scrollHeight;try{console.log(m)}catch(_){}}
  setStatus(text,type='ready'){this.elements.status.textContent=text;this.elements.status.className=`status status-${type}`}

  timeframeQS(){
    const tf=this.state.timeframe;
    if(tf==='all') return '';
    const now=Date.now();
    const from=tf==='7d'?now-7*24*3600*1000:now-24*3600*1000;
    return `?from=${from}&to=${now}`;
  }

  async checkEndpoints(){
    this.log('Checking API endpoints…');
    const endpoints=['/health','/api/analytics/inquiries','/api/dashboard-data'];
    const results=[];
    for(const ep of endpoints){
      try{
        const r=await fetch(ep);
        const ct=r.headers.get('content-type')||'';
        results.push(`${ep}: ${r.status} ${ct.includes('json')?'(JSON)':'(HTML)'}`);
        if(!ct.includes('json')&&r.ok){this.log(`WARNING: ${ep} returned HTML instead of JSON`);}
      }catch(e){results.push(`${ep}: ERROR - ${e.message}`);this.log(`ERROR checking ${ep}: ${e.message}`)}
    }
    this.elements.endpointStatus.innerHTML=results.join('<br>');
    this.refresh();
  }

  async refresh(){
    this.setStatus('Loading…','loading');this.log('Refreshing data…');
    const qs=this.timeframeQS();
    let inquiries=null, dashboard=null;

    // Primary: new analytics endpoint
    try{
      const r=await fetch(`/api/analytics/inquiries${qs}`);
      this.log(`Inquiries: ${r.status} ${r.headers.get('content-type')}`);
      if(r.ok&&(r.headers.get('content-type')||'').includes('json')) inquiries=await r.json();
    }catch(e){this.log(`Inquiries fetch failed: ${e.message}`)}

    // Fallback: old dashboard blob
    if(!inquiries){
      try{
        const r=await fetch(`/api/dashboard-data${qs}`);
        this.log(`Dashboard: ${r.status} ${r.headers.get('content-type')}`);
        if(r.ok&&(r.headers.get('content-type')||'').includes('json')) dashboard=await r.json();
      }catch(e){this.log(`Dashboard fetch failed: ${e.message}`)}
    }

    if(Array.isArray(inquiries)){
      this.renderFamilies(inquiries);
      this.updateMetrics(inquiries);
      this.elements.apiStatus.textContent='APIs responding correctly';
      this.elements.apiStatus.style.color='var(--green)';
      this.setStatus('Data loaded','ready');
    }else if(dashboard){
      this.renderFromDashboard(dashboard);
      this.elements.apiStatus.textContent='Partial JSON available';
      this.elements.apiStatus.style.color='var(--amber)';
      this.setStatus('Partial data','loading');
    }else{
      this.showError('No valid JSON received from any endpoint');
      this.elements.apiStatus.textContent='APIs not responding properly';
      this.elements.apiStatus.style.color='var(--red)';
      this.setStatus('Load failed','error');
    }
  }

  renderFamilies(families){
    this.log(`Rendering ${families.length} families`);
    if(families.length===0){this.elements.familiesList.innerHTML='<div class="loading">No families found</div>';return;}
    this.elements.familiesList.innerHTML='';
    families.forEach(f=>{
      const row=this.createFamilyRow(f);
      this.elements.familiesList.appendChild(row);
      const id=f.id||f.inquiry_id;
      this.loadFamilyDetail(id,row,f);
    });
  }

  fields(f){
    return {
      id: f.id||f.inquiry_id||'',
      first: f.first_name||f.firstName||'',
      surname: f.family_surname||f.familySurname||'',
      email: f.parent_email||f.email||'',
      entryYear: f.entry_year||f.entryYear||'',
      dwellMs: Number(f.dwell_ms||f.total_dwell_ms||0)||0,
      visits: Number(f.session_count||f.visits||0)||0,
      aiEngagement: !!f.aiEngagement,
      // prospectus URL hints
      prospectusUrl: f.prospectus_url||f.prospectusUrl||f.prospectus_path||f.prospectusPath||'',
      slug: f.prospectus_slug||f.slug||f.family_slug||''
    };
  }

  createFamilyRow(f){
    const x=this.fields(f);
    const row=document.createElement('div');row.className='family-row';
    const name=`${this.escape(x.first)} ${this.escape(x.surname)}`.trim()||'Unknown';
    const time=this.formatMMSS(x.dwellMs);
    row.innerHTML=`
      <div class="family-header">
        <div>
          <div class="family-name">${name} ${x.entryYear?`<span style="color:var(--slate)">(${x.entryYear})</span>`:''}</div>
          <div class="family-meta">${this.escape(x.email)}</div>
          <div class="geo" data-geo style="display:none"></div>
        </div>
        <div class="family-stats">
          <div class="stat-badge" title="Total dwell in selected timeframe">Time: <span data-time>${time}</span></div>
          <div class="stat-badge" title="Distinct sessions with dwell ≥ 10s">Visits: <span data-visits>${x.visits||'—'}</span></div>
          <div class="score-badge" title="Heuristic from dwell + visits">${this.score(x.dwellMs,x.visits)}</div>
        </div>
      </div>

      <div class="ai-summary" data-summary>Loading engagement narrative…</div>

      <table class="section-table" data-sections style="display:none">
        <thead><tr><th>Section</th><th>Time</th><th>Scroll</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="table-actions" data-more style="display:none">
        <button class="btn btn-secondary" data-expand>Show all sections</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-secondary" data-regenerate>Regenerate AI</button>
        <button class="btn btn-secondary" data-open>Open prospectus</button>
      </div>
    `;
    // button actions bound later (needs original record)
    return row;
  }

  async loadFamilyDetail(inquiryId,row,record){
    const qs=this.timeframeQS();

    // Sections
    try{
      const r=await fetch(`/api/section-data/${inquiryId}${qs}`);
      if(r.ok){
        const data=await r.json();
        this.renderSections(row,data);
      }
    }catch(e){this.log(`Section-data fail for ${inquiryId}: ${e.message}`)}

    // AI Summary (only if metrics exist)
    try{
      const r=await fetch(`/api/ai/engagement-summary/${inquiryId}${qs}`);
      if(r.ok){
        const data=await r.json();
        const el=row.querySelector('[data-summary]');
        const hasMetrics=Array.isArray(data.sections)&&data.sections.length>0 || (data.totals&&data.totals.dwell_ms>0);
        el.textContent = hasMetrics && data.summaryText ? data.summaryText : 'Not enough engagement yet to summarise.';
      }
    }catch(e){this.log(`AI summary fail for ${inquiryId}: ${e.message}`)}

    // Geo/device (tries a dedicated endpoint; falls back to inline)
    try{
      let geo=null;
      try{
        const r=await fetch(`/api/geo/${inquiryId}${qs}`);
        if(r.ok&&(r.headers.get('content-type')||'').includes('json')) geo=await r.json();
      }catch(_){}
      if(!geo){
        const inline=this.fields(record);
        geo={city:record.city,region:record.region,country:record.country,device:record.device_info||record.user_agent};
        if(!(geo.city||geo.region||geo.country||geo.device)) geo=null;
      }
      if(geo) this.renderGeo(row,geo);
    }catch(e){this.log(`Geo fail for ${inquiryId}: ${e.message}`)}

    // Wire the buttons (needs record for URL resolution)
    const openBtn=row.querySelector('[data-open]');
    const regenBtn=row.querySelector('[data-regenerate]');
    regenBtn.onclick=()=>this.regenerateAI(inquiryId);
    openBtn.onclick=()=>this.openProspectus(inquiryId, record);
  }

  // === Robust prospectus opener ===
  async openProspectus(inquiryId, record){
    const f=this.fields(record);
    // 1) If backend already gave us a full URL/path, use it.
    if(f.prospectusUrl){
      const url=this.ensureAbsolute(f.prospectusUrl);
      this.log(`Opening prospectus via prospectus_url: ${url}`);
      return window.open(url,'_blank');
    }
    // 2) If we have a slug, try common routes
    if(f.slug){
      const candidates=[
        `/prospectuses/${encodeURIComponent(f.slug)}`,
      // common alternates you’ve used historically:
        `/prospectus/${encodeURIComponent(f.slug)}`,
        `/${encodeURIComponent(f.slug)}`
      ];
      for(const url of candidates){
        const ok=await this.headOk(url);
        if(ok){ this.log(`Opening prospectus via slug: ${url}`); return window.open(url,'_blank'); }
      }
    }
    // 3) Try a helper endpoint that returns the URL for an inquiry id (if your server exposes it)
    try{
      const r=await fetch(`/api/prospectus-url/${encodeURIComponent(inquiryId)}`);
      if(r.ok){
        const j=await r.json();
        if(j && (j.url||j.prospectus_url)){ 
          const url=this.ensureAbsolute(j.url||j.prospectus_url);
          this.log(`Opening prospectus via resolver: ${url}`);
          return window.open(url,'_blank');
        }
      }
    }catch(_){}

    // 4) As a last resort, try a canonical path that existed in your data previously
    const guess=`/prospectus/${encodeURIComponent(inquiryId)}`;
    const ok=await this.headOk(guess);
    if(ok){ this.log(`Opening prospectus via id fallback: ${guess}`); return window.open(guess,'_blank'); }

    // If nothing worked, explain exactly what we tried
    alert(
`Can't open prospectus for ${inquiryId}.
Tried:
• prospectus_url from API (${f.prospectusUrl||'none'})
• slug routes (${f.slug||'none'})
• /api/prospectus-url/:id
• fallback /prospectus/:id

Server needs to return either 'prospectus_url' or 'slug' with each inquiry.`
    );
  }

  ensureAbsolute(pathOrUrl){
    try{ const u=new URL(pathOrUrl, window.location.origin); return u.toString(); }catch{ return pathOrUrl; }
  }

  async headOk(url){
    try{
      const r=await fetch(url,{method:'HEAD'});
      return r.ok;
    }catch{return false}
  }

  renderSections(row,data){
    const sections=(data.sections||[]).map(s=>({
      name: s.section_name||s.section||'—',
      dwellMs: Number(s.dwell_ms||s.dwellMs||0),
      scroll: Number(s.max_scroll_pct||s.scroll_pct||0)
    }));
    if(sections.length===0) return;

    const table=row.querySelector('[data-sections]'); const tbody=table.querySelector('tbody');
    const limit=8;
    const renderSlice=(arr)=>arr.map(sec=>`
      <tr>
        <td>${this.escape(sec.name)}</td>
        <td>${this.formatMMSS(sec.dwellMs)}</td>
        <td>${Math.round(sec.scroll)}%</td>
      </tr>`).join('');

    tbody.innerHTML=renderSlice(sections.slice(0,limit));
    table.style.display='table';

    if(sections.length>limit){
      const more=row.querySelector('[data-more]');
      more.style.display='block';
      more.querySelector('[data-expand]').onclick=()=>{tbody.innerHTML=renderSlice(sections);more.style.display='none';};
    }
  }

  renderGeo(row,geo){
    const container=row.querySelector('[data-geo]');
    if(!container) return;
    const city=geo.city||geo.last_city||geo.location_city;
    const region=geo.region||geo.region_name||geo.location_region;
    const country=geo.country||geo.country_name||geo.location_country;
    const device=geo.device||geo.device_info||geo.user_agent;
    const parts=[];
    if(city||region||country) parts.push([city,region,country].filter(Boolean).join(', '));
    if(device) parts.push(String(device).slice(0,80));
    if(parts.length){container.style.display='flex';container.innerHTML=parts.map(p=>`<span>${this.escape(p)}</span>`).join('');}
  }

  updateMetrics(families){
    const norm=families.map(f=>this.fields(f));
    const hot=norm.filter(n=>this.score(n.dwellMs,n.visits)>=80).length;
    const warm=norm.filter(n=>{const s=this.score(n.dwellMs,n.visits);return s>=60&&s<80}).length;
    const ai=families.filter(f=>f.aiEngagement).length;
    this.elements.hotCount.textContent=hot;
    this.elements.warmCount.textContent=warm;
    this.elements.aiCount.textContent=ai;
    this.elements.totalCount.textContent=families.length;
  }

  renderFromDashboard(data){
    this.elements.familiesList.innerHTML='<div class="loading">Using fallback data — some APIs are returning HTML</div>';
    if(data.summary){
      this.elements.hotCount.textContent=data.summary.hotLeads||0;
      this.elements.warmCount.textContent=data.summary.warmLeads||0;
      this.elements.aiCount.textContent=data.summary.aiAnalyzed||0;
      this.elements.totalCount.textContent=data.summary.totalFamilies||0;
    }
  }

  async runAI(){
    this.setStatus('Running AI…','loading');this.log('Starting AI analysis…');
    try{
      const r=await fetch('/api/ai/analyze-all-families',{method:'POST'});
      const d=await r.json();
      if(r.ok&&d.success){this.log('AI analysis completed');this.setStatus('AI complete','ready');this.refresh();}
      else throw new Error(d.message||d.error||'AI analysis failed');
    }catch(e){this.log(`AI analysis failed: ${e.message}`);this.setStatus('AI failed','error');}
  }

  async regenerateAI(inquiryId){
    this.log(`Regenerating AI for ${inquiryId}`);
    try{
      const r=await fetch(`/api/ai/engagement-summary/${inquiryId}`,{method:'POST'});
      const d=await r.json();
      if(r.ok){this.log(`AI regenerated for ${inquiryId}`);this.refresh();}
      else throw new Error(d.message||'Regeneration failed');
    }catch(e){this.log(`AI regeneration failed: ${e.message}`);alert('Regeneration failed: '+e.message);}
  }

  score(dwellMs,visits){const mins=dwellMs/60000;const v=Math.max(0,Number(visits)||0);return Math.min(Math.round(mins*8+v*5+20),100);}
  formatMMSS(ms){const s=Math.max(0,Math.floor(ms/1000));const m=Math.floor(s/60);const rs=String(s%60).padStart(2,'0');return `${m}:${rs}`;}
  escape(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML;}
}
const app=new Dashboard();
</script>
</body>
</html>
