<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>More House School - SMART Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --blazer-navy:#091825;--award-gold:#FF9F1C;--sport-blue:#034674;
      --text-primary:#2C3E50;--white:#FFFFFF;--light-grey:#F8FAFC;--border-grey:#E5E7EB;
      --success:#10B981;--warning:#F59E0B;--error:#EF4444;
      --hot-lead:#FF4444;--warm-lead:#FF9F1C;--cold-lead:#034674;
      --font-heading:'Playfair Display',serif;--font-body:'Inter',sans-serif
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:var(--font-body);background:linear-gradient(135deg,var(--light-grey) 0%,#f1f5f9 100%);min-height:100vh;color:var(--text-primary);font-size:14px}

    .header{background:linear-gradient(135deg,#091825 0%,#034674 100%);color:#fff;padding:2rem;box-shadow:0 4px 20px rgba(9,24,37,.3);position:relative}
    .header-controls{position:absolute;top:2rem;right:2rem;display:flex;gap:0.75rem}
    .refresh-btn,.ai-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:.5rem 1rem;border-radius:8px;cursor:pointer;transition:.3s;font-size:.9rem}
    .refresh-btn:hover,.ai-btn:hover{background:rgba(255,255,255,.2)}
    .ai-btn{background:var(--award-gold);color:var(--blazer-navy);border-color:var(--award-gold);font-weight:600}
    .header-brand{text-align:center}
    .brand-glow{position:absolute;inset:0;border-radius:50%;background:linear-gradient(135deg,var(--award-gold),#FFB84D);opacity:.3;filter:blur(20px)}
    .header h1{position:relative;font-family:var(--font-heading);font-size:3.5rem;font-weight:700;margin-bottom:0.5rem}
    .smart-text{background:linear-gradient(135deg,var(--award-gold),#FFB84D);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .analytics-text{color:#fff}
    .header p{font-size:1.1rem;font-weight:300;color:rgba(255,255,255,.9)}

    .dashboard{max-width:1500px;margin:-2rem auto 2rem;position:relative;z-index:10}
    
    /* Enhanced Metrics */
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.5rem;padding:2rem}
    .metric-card{background:#fff;border-radius:16px;padding:1.75rem;box-shadow:0 4px 16px rgba(9,24,37,.08);border:1px solid var(--border-grey);transition:.3s;position:relative;overflow:hidden}
    .metric-card:hover{box-shadow:0 8px 25px rgba(9,24,37,.12);transform:translateY(-2px)}
    .metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
    .metric-card.hot::before{background:linear-gradient(90deg,var(--hot-lead),#ff6666)}
    .metric-card.warm::before{background:linear-gradient(90deg,var(--warm-lead),#ffb347)}
    .metric-card.engagement::before{background:linear-gradient(90deg,var(--success),#34d399)}
    .metric-card.total::before{background:linear-gradient(90deg,var(--sport-blue),#0ea5e9)}
    .metric-card.ai::before{background:linear-gradient(90deg,var(--award-gold),#FFB84D)}
    .metric-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.75rem;margin-bottom:1rem}
    .metric-icon.hot{background:linear-gradient(135deg,var(--hot-lead),#ff6666)}
    .metric-icon.warm{background:linear-gradient(135deg,var(--warm-lead),#ffb347)}
    .metric-icon.engagement{background:linear-gradient(135deg,var(--success),#34d399)}
    .metric-icon.total{background:linear-gradient(135deg,var(--sport-blue),#0ea5e9)}
    .metric-icon.ai{background:linear-gradient(135deg,var(--award-gold),#FFB84D)}
    .metric-title{font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#64748b;margin-bottom:.5rem}
    .metric-value{font-size:2.5rem;font-weight:700;color:var(--blazer-navy);margin-bottom:.25rem;font-family:var(--font-heading)}
    .metric-subtitle{font-size:.875rem;font-weight:500;color:#64748b}

    /* Main Layout */
    .main-content{padding:0 2rem 2rem}
    .filters{background:#fff;padding:1.25rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:1.5rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    .filter-select,.search-box{padding:.625rem 1rem;border:1px solid #d1d5db;border-radius:8px;font-size:.875rem;transition:border-color .2s}
    .filter-select:focus,.search-box:focus{outline:none;border-color:var(--sport-blue);box-shadow:0 0 0 3px rgba(3,70,116,.1)}
    .search-box{flex:1;min-width:250px}

    /* Enhanced Family Cards */
    .family-card{background:#fff;border:1px solid var(--border-grey);border-radius:12px;margin-bottom:1rem;overflow:hidden;transition:box-shadow .3s}
    .family-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .family-header{padding:1.25rem;display:flex;justify-content:space-between;align-items:flex-start;background:#fff;cursor:pointer;transition:background .2s}
    .family-header:hover{background:#f8fafc}
    .family-info{flex:1}
    .family-info h3{font-size:1.25rem;font-weight:600;margin-bottom:.5rem;color:var(--blazer-navy)}
    .family-meta{font-size:.875rem;color:#64748b;display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:.75rem}
    .family-meta span{display:inline-flex;align-items:center;gap:.25rem}
    
    /* Interest Pills */
    .interests-container{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
    .interest-pill{font-size:.75rem;padding:.25rem .75rem;background:var(--light-grey);border:1px solid var(--border-grey);border-radius:999px;color:var(--text-primary)}
    .interest-pill.academic{background:#E0F2FE;border-color:#0EA5E9;color:#0C4A6E}
    .interest-pill.creative{background:#FCE7F3;border-color:#EC4899;color:#831843}
    .interest-pill.sport{background:#DBEAFE;border-color:#3B82F6;color:#1E3A8A}
    .interest-pill.priority{background:#FEF3C7;border-color:#F59E0B;color:#78350F}

    /* Engagement Badge */
    .family-stats{display:flex;align-items:center;gap:1.5rem}
    .score-badge{padding:.5rem 1rem;border-radius:8px;font-weight:600;font-size:1.125rem;text-align:center;min-width:60px}
    .score-badge.hot{background:rgba(255,68,68,.1);color:var(--hot-lead);border:1px solid rgba(255,68,68,.2)}
    .score-badge.warm{background:rgba(255,159,28,.1);color:var(--warm-lead);border:1px solid rgba(255,159,28,.2)}
    .score-badge.cold{background:rgba(3,70,116,.1);color:var(--sport-blue);border:1px solid rgba(3,70,116,.2)}
    .expand-icon{transition:transform .2s;color:#64748b}
    .family-card.expanded .expand-icon{transform:rotate(180deg)}

    /* Enhanced Details Section */
    .family-details{display:none;background:#f8fafc;border-top:1px solid var(--border-grey)}
    .family-card.expanded .family-details{display:block}
    .details-grid{display:grid;grid-template-columns:1fr 2fr;gap:1.5rem;padding:1.25rem}
    .detail-section{background:#fff;padding:1rem;border-radius:8px;border:1px solid var(--border-grey)}
    .detail-section h4{font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#64748b;margin-bottom:.75rem}
    
    /* Actions */
    .family-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:1rem}
    .btn{padding:.5rem .875rem;border:1px solid var(--border-grey);border-radius:8px;background:#fff;cursor:pointer;font-size:.875rem;transition:all .2s;font-weight:500}
    .btn:hover{background:#f8fafc;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .btn.primary{background:var(--sport-blue);border-color:var(--sport-blue);color:#fff}
    .btn.primary:hover{background:#025090}
    .btn.ai{background:var(--award-gold);border-color:var(--award-gold);color:var(--blazer-navy)}
    .btn.ai:hover{background:#e88f1a}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

    /* AI Summary Section */
    .ai-summary{background:linear-gradient(135deg,#FEF3C7,#FDE68A);border:1px solid #F59E0B;border-radius:8px;padding:1rem;margin:1rem 0}
    .ai-summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .ai-summary-title{font-weight:600;color:var(--blazer-navy);display:flex;align-items:center;gap:.5rem}
    .ai-badge{font-size:.75rem;padding:.125rem .5rem;background:var(--award-gold);color:#fff;border-radius:4px;font-weight:600}
    .ai-summary-content{color:var(--text-primary);line-height:1.6}
    .ai-recommendations{margin-top:.75rem;padding-top:.75rem;border-top:1px solid rgba(245,158,11,.3)}
    .ai-recommendations h5{font-size:.875rem;font-weight:600;color:var(--blazer-navy);margin-bottom:.5rem}
    .ai-recommendations ul{margin:0;padding-left:1.25rem}
    .ai-recommendations li{font-size:.875rem;margin-bottom:.25rem}

    /* Enhanced Sessions */
    .sessions-container{padding:1rem}
    .session-card{background:#fff;border:1px solid var(--border-grey);border-radius:8px;margin-bottom:.75rem;overflow:hidden}
    .session-header{padding:.875rem;background:#f8fafc;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .2s}
    .session-header:hover{background:#f1f5f9}
    .session-info{flex:1}
    .session-title{font-weight:600;color:var(--blazer-navy);margin-bottom:.25rem}
    .session-meta{font-size:.875rem;color:#64748b}
    .session-stats{display:flex;gap:1rem;align-items:center}
    .session-stat{text-align:center}
    .session-stat-value{font-weight:600;color:var(--blazer-navy)}
    .session-stat-label{font-size:.75rem;color:#64748b}
    .session-body{display:none;padding:1rem;background:#fff}
    .session-card.open .session-body{display:block}

    /* Journey Visualisation */
    .journey-timeline{margin-top:1rem}
    .journey-item{display:flex;gap:1rem;padding:.75rem;background:#f8fafc;border-radius:6px;margin-bottom:.5rem;align-items:center}
    .journey-icon{width:32px;height:32px;border-radius:50%;background:var(--sport-blue);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.875rem;flex-shrink:0}
    .journey-icon.section{background:var(--sport-blue)}
    .journey-icon.video{background:var(--error)}
    .journey-icon.tier{background:var(--warning)}
    .journey-icon.cta{background:var(--success)}
    .journey-content{flex:1}
    .journey-title{font-weight:500;color:var(--blazer-navy);margin-bottom:.25rem}
    .journey-meta{font-size:.875rem;color:#64748b}
    .journey-progress{height:4px;background:var(--border-grey);border-radius:2px;margin-top:.5rem;overflow:hidden}
    .journey-progress-fill{height:100%;background:var(--award-gold);transition:width .3s}

    /* Loading & Error States */
    .loading{display:flex;align-items:center;justify-content:center;padding:2rem;color:#64748b}
    .spinner{width:20px;height:20px;border:2px solid var(--border-grey);border-top:2px solid var(--sport-blue);border-radius:50%;animation:spin 1s linear infinite;margin-right:.75rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:1rem;border-radius:8px;margin:1rem 0}
    .no-data{text-align:center;color:#64748b;padding:3rem;font-size:1rem}

    /* Responsive */
    @media (max-width:768px){
      .header h1{font-size:2.5rem}
      .metrics{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));padding:1rem}
      .details-grid{grid-template-columns:1fr}
      .header-controls{position:static;margin-top:1rem;justify-content:center}
      .filters{flex-direction:column}
      .search-box{width:100%}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-controls">
      <button class="refresh-btn" onclick="loadData(true)">‚Üª Refresh</button>
      <button class="ai-btn" onclick="generateAllSummaries()">Generate All AI Summaries</button>
    </div>
    <div class="header-brand">
      <h1><span class="smart-text">SMART</span> <span class="analytics-text">Analytics</span></h1>
      <p>More House School ‚Ä¢ Real-time Engagement Tracking</p>
    </div>
  </header>

  <div class="dashboard">
    <!-- Metrics -->
    <div class="metrics">
      <div class="metric-card total">
        <div class="metric-icon total">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
        <div class="metric-title">Total Enquiries</div>
        <div class="metric-value" id="totalFamilies">-</div>
        <div class="metric-subtitle">Active prospects</div>
      </div>
      <div class="metric-card hot">
        <div class="metric-icon hot">üî•</div>
        <div class="metric-title">High Interest</div>
        <div class="metric-value" id="hotLeads">-</div>
        <div class="metric-subtitle">Score 80+ ‚Ä¢ Priority contact</div>
      </div>
      <div class="metric-card warm">
        <div class="metric-icon warm">‚ö°</div>
        <div class="metric-title">Moderate Interest</div>
        <div class="metric-value" id="warmLeads">-</div>
        <div class="metric-subtitle">Score 50-79 ‚Ä¢ Nurture</div>
      </div>
      <div class="metric-card engagement">
        <div class="metric-icon engagement">üìä</div>
        <div class="metric-title">Return Visitors</div>
        <div class="metric-value" id="returnVisitors">-</div>
        <div class="metric-subtitle">Multiple sessions</div>
      </div>
      <div class="metric-card ai">
        <div class="metric-icon ai">ü§ñ</div>
        <div class="metric-title">AI Analysed</div>
        <div class="metric-value" id="aiAnalysed">-</div>
        <div class="metric-subtitle">With summaries</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="filters">
        <select class="filter-select" id="sortFilter">
          <option value="engagement">Sort by Engagement Score</option>
          <option value="recent">Sort by Most Recent</option>
          <option value="time">Sort by Time Spent</option>
          <option value="visits">Sort by Visit Count</option>
        </select>
        <select class="filter-select" id="statusFilter">
          <option value="all">All Families</option>
          <option value="hot">High Interest Only</option>
          <option value="warm">Moderate Interest Only</option>
          <option value="active">Active Today</option>
          <option value="return">Return Visitors</option>
        </select>
        <input type="text" class="search-box" placeholder="Search by family name..." id="searchBox">
      </div>

      <div id="familyList">
        <div class="loading"><div class="spinner"></div> Loading families...</div>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    let allFamilies = [];
    let aiSummaries = {};
    let isLoading = false;

    // Helpers
    const byId = id => document.getElementById(id);
    const setText = (id, v) => { const el = byId(id); if (el) el.textContent = String(v); };
    const fetchJson = async (url) => {
      const u = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const res = await fetch(u, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    };

    // Format helpers
    const formatTimeAgo = (date) => {
      const now = new Date(), diff = now - date;
      const m = Math.floor(diff/60000), h = Math.floor(diff/3600000), d = Math.floor(diff/86400000);
      if (m < 1) return 'Just now';
      if (m < 60) return `${m}m ago`;
      if (h < 24) return `${h}h ago`;
      if (d < 7) return `${d}d ago`;
      return date.toLocaleDateString('en-GB');
    };

    const formatDuration = (ms) => {
      const mins = Math.floor(ms / 60000);
      if (mins < 1) return '< 1 min';
      if (mins < 60) return `${mins} min`;
      const hours = Math.floor(mins / 60);
      return `${hours}h ${mins % 60}m`;
    };

    // Extract interests from enquiry data
    const extractInterests = (family) => {
      const interests = [];
      const interestMap = {
        // Academic
        sciences: { label: 'Sciences', type: 'academic' },
        mathematics: { label: 'Maths', type: 'academic' },
        english: { label: 'English', type: 'academic' },
        languages: { label: 'Languages', type: 'academic' },
        humanities: { label: 'Humanities', type: 'academic' },
        business: { label: 'Business', type: 'academic' },
        // Creative
        drama: { label: 'Drama', type: 'creative' },
        music: { label: 'Music', type: 'creative' },
        art: { label: 'Art', type: 'creative' },
        creative_writing: { label: 'Creative Writing', type: 'creative' },
        // Sport & Activities
        sport: { label: 'Sport', type: 'sport' },
        leadership: { label: 'Leadership', type: 'sport' },
        community_service: { label: 'Community Service', type: 'sport' },
        outdoor_education: { label: 'Outdoor Education', type: 'sport' },
        // Priorities
        academic_excellence: { label: 'Academic Excellence', type: 'priority' },
        pastoral_care: { label: 'Pastoral Care', type: 'priority' },
        university_preparation: { label: 'University Prep', type: 'priority' },
        personal_development: { label: 'Personal Development', type: 'priority' },
        career_guidance: { label: 'Career Guidance', type: 'priority' },
        extracurricular_opportunities: { label: 'Extracurriculars', type: 'priority' }
      };

      Object.keys(interestMap).forEach(key => {
        if (family[key] === true || family[key] === 'true' || family[key] === 1) {
          interests.push(interestMap[key]);
        }
      });

      return interests;
    };

    // Process and enrich family data
    function processRealData(raw) {
      return raw.map(f => {
        const dwellMs = Number(f.dwell_ms) || 0;
        const minutes = dwellMs / 60000;
        const visits = Number(f.return_visits) || 0;
        const last = f.updated_at || f.received_at || null;

        // Calculate engagement score
        const timeScore = Math.min(Math.max(minutes, 0), 25) * 2;
        const visitScore = Math.min(Math.max(visits, 0), 6) * 5;
        let recency = 0;
        if (last) {
          const age = Date.now() - new Date(last).getTime();
          if (age <= 86400000) recency = 20;
          else if (age <= 3*86400000) recency = 10;
        }
        const engagement = Math.round(Math.min(timeScore + visitScore + recency, 100));
        const temperature = engagement >= 80 ? 'hot' : (engagement >= 50 ? 'warm' : 'cold');
        const isActiveToday = !!(last && (Date.now() - new Date(last).getTime()) <= 86400000);

        return {
          id: f.id || f.inquiry_id,
          name: `${f.first_name || ''} ${f.family_surname || ''}`.trim(),
          firstName: f.first_name,
          familySurname: f.family_surname,
          parentEmail: f.parent_email,
          entryYear: f.entry_year,
          ageGroup: f.age_group,
          receivedAt: f.received_at,
          lastActivity: last,
          timeOnPageMs: dwellMs,
          timeOnPageMinutes: Math.max(0, Math.round(minutes)),
          visits: Math.max(0, visits),
          engagementScore: engagement,
          temperature,
          isActiveToday,
          hasProspectus: !!f.prospectus_generated,
          prospectusUrl: f.prospectus_pretty_url || null,
          city: f.city || 'Unknown',
          country: f.country || 'Unknown',
          interests: extractInterests(f),
          rawData: f // Keep original data for other fields
        };
      }).filter(x => x.name.length);
    }

    // Load main data
    async function loadData() {
      if (isLoading) return;
      isLoading = true;
      
      try {
        const data = await fetchJson('/api/analytics/inquiries');
        allFamilies = processRealData(Array.isArray(data) ? data : []);
        updateMetrics();
        renderFamilies();
      } catch (e) {
        showError('Failed to load data: ' + e.message);
        console.error('loadData:', e);
      } finally {
        isLoading = false;
      }
    }

    // Update metrics
    function updateMetrics() {
      setText('totalFamilies', allFamilies.length);
      setText('hotLeads', allFamilies.filter(f => f.temperature === 'hot').length);
      setText('warmLeads', allFamilies.filter(f => f.temperature === 'warm').length);
      setText('returnVisitors', allFamilies.filter(f => f.visits >= 2).length);
      setText('aiAnalysed', Object.keys(aiSummaries).length);
    }

    // Get filtered families
    function getFilteredFamilies() {
      let families = [...allFamilies];

      const status = byId('statusFilter')?.value || 'all';
      if (status === 'hot') families = families.filter(f => f.temperature === 'hot');
      else if (status === 'warm') families = families.filter(f => f.temperature === 'warm');
      else if (status === 'active') families = families.filter(f => f.isActiveToday);
      else if (status === 'return') families = families.filter(f => f.visits >= 2);

      const q = (byId('searchBox')?.value || '').toLowerCase();
      if (q) {
        families = families.filter(f =>
          f.name.toLowerCase().includes(q) ||
          (f.parentEmail || '').toLowerCase().includes(q)
        );
      }

      const sortBy = byId('sortFilter')?.value || 'engagement';
      if (sortBy === 'engagement') families.sort((a, b) => b.engagementScore - a.engagementScore);
      else if (sortBy === 'recent') families.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
      else if (sortBy === 'time') families.sort((a, b) => b.timeOnPageMs - a.timeOnPageMs);
      else if (sortBy === 'visits') families.sort((a, b) => b.visits - a.visits);

      return families;
    }

    // Render families
    function renderFamilies() {
      const container = byId('familyList');
      const list = getFilteredFamilies();

      if (!allFamilies.length) {
        container.innerHTML = '<div class="no-data">No enquiries yet</div>';
        return;
      }
      if (!list.length) {
        container.innerHTML = '<div class="no-data">No families found matching filters</div>';
        return;
      }

      container.innerHTML = list.map(f => {
        const aiSummary = aiSummaries[f.id];
        const interestPills = f.interests.map(i => 
          `<span class="interest-pill ${i.type}">${i.label}</span>`
        ).join('');

        return `
          <div class="family-card" data-id="${f.id}">
            <div class="family-header" onclick="toggleFamily('${f.id}')">
              <div class="family-info">
                <h3>${f.name}</h3>
                <div class="family-meta">
                  <span>üìß ${f.parentEmail || 'No email'}</span>
                  <span>üìÖ Entry ${f.entryYear || 'TBC'}</span>
                  <span>üéÇ ${f.ageGroup || 'Unknown'}</span>
                  <span>üìç ${f.city}</span>
                  <span>‚è± ${f.timeOnPageMinutes} min total</span>
                  <span>üëÅ ${f.visits} visit${f.visits !== 1 ? 's' : ''}</span>
                </div>
                ${interestPills ? `<div class="interests-container">${interestPills}</div>` : ''}
              </div>
              <div class="family-stats">
                <div class="score-badge ${f.temperature}">${f.engagementScore}</div>
                <div class="expand-icon">‚ñº</div>
              </div>
            </div>
            <div class="family-details">
              <div class="details-grid">
                <div class="detail-section">
                  <h4>Contact & Profile</h4>
                  <div style="font-size:.875rem;line-height:1.6">
                    <strong>Email:</strong> ${f.parentEmail || 'Not provided'}<br>
                    <strong>Location:</strong> ${f.city}, ${f.country}<br>
                    <strong>Age Group:</strong> ${f.ageGroup || 'Not specified'}<br>
                    <strong>Entry Year:</strong> ${f.entryYear || 'TBC'}<br>
                    <strong>First Contact:</strong> ${f.receivedAt ? new Date(f.receivedAt).toLocaleDateString('en-GB') : 'Unknown'}<br>
                    <strong>Last Activity:</strong> ${f.lastActivity ? formatTimeAgo(new Date(f.lastActivity)) : 'No activity'}
                  </div>
                  <div class="family-actions">
                    ${f.prospectusUrl ? 
                      `<button class="btn primary" onclick="window.open('${f.prospectusUrl}','_blank')">View Prospectus</button>` : 
                      `<button class="btn" disabled>No Prospectus</button>`}
                    ${f.parentEmail ? 
                      `<a class="btn" href="mailto:${f.parentEmail}">Email Family</a>` : ''}
                    <button class="btn" onclick="copyInquiryId('${f.id}')">Copy ID</button>
                  </div>
                </div>
                <div>
                  ${aiSummary ? `
                    <div class="ai-summary">
                      <div class="ai-summary-header">
                        <div class="ai-summary-title">
                          <span class="ai-badge">AI</span>
                          Engagement Analysis
                        </div>
                        <button class="btn ai" onclick="generateSummary('${f.id}')">Regenerate</button>
                      </div>
                      <div class="ai-summary-content">${aiSummary.summary}</div>
                      ${aiSummary.recommendations ? `
                        <div class="ai-recommendations">
                          <h5>Recommended Actions</h5>
                          <ul>
                            ${aiSummary.recommendations.map(r => `<li>${r}</li>`).join('')}
                          </ul>
                        </div>
                      ` : ''}
                    </div>
                  ` : `
                    <div class="detail-section">
                      <h4>AI Analysis</h4>
                      <p style="color:#64748b;margin-bottom:1rem">No AI summary generated yet</p>
                      <button class="btn ai" onclick="generateSummary('${f.id}')">Generate AI Summary</button>
                    </div>
                  `}
                  <div class="sessions-container">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
                      <h4 style="font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#64748b">Session History</h4>
                      <button class="btn" onclick="loadSessionHistory('${f.id}')">Load All Sessions</button>
                    </div>
                    <div id="sessions-${f.id}"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle family card
    function toggleFamily(id) {
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) card.classList.toggle('expanded');
    }

    // Copy inquiry ID
    function copyInquiryId(id) {
      navigator.clipboard.writeText(id).then(() => {
        // Could add a toast notification here
      }).catch(console.error);
    }

    // Generate AI summary for single family
    async function generateSummary(inquiryId) {
      const family = allFamilies.find(f => f.id === inquiryId);
      if (!family) return;

      // Simulate AI generation
      const engagement = family.engagementScore;
      let summary, recommendations;

      if (engagement >= 80) {
        summary = `Highly engaged prospect showing exceptional interest. ${family.visits} visits totalling ${family.timeOnPageMinutes} minutes of engagement. Strong interest in ${family.interests.slice(0, 3).map(i => i.label).join(', ')}. Ready for immediate follow-up.`;
        recommendations = [
          'Priority: Schedule personal tour within 48 hours',
          'Send personalised video message from Head',
          'Invite to exclusive prospective parent event'
        ];
      } else if (engagement >= 50) {
        summary = `Moderate engagement with focused interest areas. ${family.visits} visit${family.visits !== 1 ? 's' : ''} showing particular attention to ${family.interests.slice(0, 2).map(i => i.label).join(' and ')}. Nurture with targeted content.`;
        recommendations = [
          'Send tailored programme information',
          'Schedule follow-up call next week',
          'Add to nurture email sequence'
        ];
      } else {
        summary = `Early-stage prospect beginning research. Initial exploration with ${family.visits} visit${family.visits !== 1 ? 's' : ''}. Building familiarity with school offerings.`;
        recommendations = [
          'Add to general information campaign',
          'Monitor for increased engagement',
          'Send welcome packet'
        ];
      }

      aiSummaries[inquiryId] = { summary, recommendations };
      updateMetrics();
      renderFamilies();
    }

    // Generate all AI summaries
    async function generateAllSummaries() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Generating...';

      for (const family of allFamilies) {
        if (!aiSummaries[family.id]) {
          await generateSummary(family.id);
          await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
        }
      }

      btn.disabled = false;
      btn.textContent = 'Generate All AI Summaries';
      updateMetrics();
    }

    // Load session history - matching original dashboard functionality
    async function loadSessionHistory(inquiryId) {
      const container = byId(`sessions-${inquiryId}`);
      if (!container) return;

      container.innerHTML = '<div class="loading"><div class="spinner"></div> Loading sessions...</div>';

      // Try multiple endpoints as the original does
      const endpoints = [
        `/api/visits/${encodeURIComponent(inquiryId)}/history`,
        `/api/visits/${encodeURIComponent(inquiryId)}/sessions`,
        `/api/visits/${encodeURIComponent(inquiryId)}?limit=20`
      ];

      let sessions = null;
      for (const url of endpoints) {
        try {
          const data = await fetchJson(url);
          if (Array.isArray(data) && data.length) {
            sessions = data;
            break;
          }
          if (data && Array.isArray(data.sessions) && data.sessions.length) {
            sessions = data.sessions;
            break;
          }
        } catch(e) {
          console.log(`Tried ${url}:`, e.message);
        }
      }

      if (!sessions) {
        container.innerHTML = '<div class="no-data">No session history found</div>';
        return;
      }

      // Sort sessions by date (newest first)
      sessions = sessions.slice().sort((a, b) => {
        const aDate = new Date(a.start || a.started_at || a.created_at || 0);
        const bDate = new Date(b.start || b.started_at || b.created_at || 0);
        return bDate - aDate;
      });

      container.innerHTML = `
        <div class="session-meta" style="margin-bottom:1rem;color:#64748b">
          ${sessions.length} session${sessions.length === 1 ? '' : 's'} found
        </div>
        ${sessions.map((s, index) => renderSessionCard(s, index, inquiryId)).join('')}
      `;
    }

    // Render individual session card
    function renderSessionCard(session, index, inquiryId) {
      const sessionId = session.id || session.session_id || `session-${index}`;
      const sessionStart = session.start || session.started_at || session.created_at;
      const sessionEnd = session.end || session.ended_at || session.updated_at;
      
      // Try to infer start time from session ID if needed
      if (!sessionStart && sessionId.startsWith('S-')) {
        const match = /^S-(\d{13})-/.exec(sessionId);
        if (match) {
          const timestamp = new Date(Number(match[1]));
          if (!isNaN(timestamp)) {
            session.start = timestamp.toISOString();
          }
        }
      }

      const formatDate = (d) => d ? new Date(d).toLocaleString('en-GB') : '?';

      return `
        <div class="session-card" data-session="${sessionId}">
          <div class="session-header" onclick="toggleSession('${sessionId}', '${inquiryId}')">
            <div class="session-info">
              <div class="session-title">Session ${sessionId}</div>
              <div class="session-meta">
                ${formatDate(sessionStart)}
                ${sessionEnd ? ` ‚Üí ${formatDate(sessionEnd)}` : ''}
              </div>
            </div>
            <div class="expand-icon">‚ñº</div>
          </div>
          <div class="session-body">
            <div class="journey-timeline" id="journey-${sessionId}">
              <div class="loading"><div class="spinner"></div> Click header to load events...</div>
            </div>
          </div>
        </div>
      `;
    }

    // Render mock journey
    function renderMockJourney() {
      const sections = [
        { name: 'Welcome & Introduction', icon: 'üè†', duration: 120, scroll: 85 },
        { name: 'Academic Programme', icon: 'üìö', duration: 300, scroll: 70 },
        { name: 'Pastoral Care', icon: 'üíù', duration: 180, scroll: 60 },
        { name: 'Co-curricular Activities', icon: 'üé®', duration: 150, scroll: 50 }
      ];

      return sections.map(s => `
        <div class="journey-item">
          <div class="journey-icon section">${s.icon}</div>
          <div class="journey-content">
            <div class="journey-title">${s.name}</div>
            <div class="journey-meta">${Math.floor(s.duration / 60)} min ‚Ä¢ ${s.scroll}% scroll depth</div>
            <div class="journey-progress">
              <div class="journey-progress-fill" style="width: ${s.scroll}%"></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Render real sessions
    function renderSessions(sessions) {
      if (!sessions || !sessions.length) {
        return '<div class="no-data">No sessions found</div>';
      }

      return sessions.map((s, index) => {
        const sessionId = s.id || s.session_id || `session-${index}`;
        const visitNumber = sessions.length - index;
        
        return `
          <div class="session-card" data-session="${sessionId}">
            <div class="session-header" onclick="toggleSession('${sessionId}')">
              <div class="session-info">
                <div class="session-title">Visit ${visitNumber}</div>
                <div class="session-meta">
                  ${s.start ? formatTimeAgo(new Date(s.start)) : 'Unknown time'}
                  ${s.duration ? ` ‚Ä¢ ${formatDuration(s.duration * 1000)}` : ''}
                </div>
              </div>
            </div>
            <div class="session-body">
              <div class="journey-timeline" id="journey-${sessionId}">
                <button class="btn" onclick="loadSessionEvents('${sessionId}')">Load Session Details</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle session and load events if needed
    async function toggleSession(sessionId, inquiryId) {
      const card = document.querySelector(`[data-session="${sessionId}"]`);
      if (!card) return;
      
      card.classList.toggle('open');
      
      // Load events on first open
      if (card.classList.contains('open')) {
        const container = byId(`journey-${sessionId}`);
        if (container && container.querySelector('.loading')) {
          await loadSessionEvents(sessionId, inquiryId);
        }
      }
    }

    // Load events for a specific session
    async function loadSessionEvents(sessionId, inquiryId) {
      const container = byId(`journey-${sessionId}`);
      if (!container) return;

      container.innerHTML = '<div class="loading"><div class="spinner"></div> Loading events...</div>';

      // Try multiple endpoints as the original does
      const urls = [
        `/api/visits/session/${encodeURIComponent(sessionId)}`,
        `/api/visits/session/${encodeURIComponent(sessionId)}/events`,
        `/api/sessions/${encodeURIComponent(sessionId)}`,
        `/api/session/${encodeURIComponent(sessionId)}`,
        `/api/visits/${encodeURIComponent(inquiryId)}/sessions/${encodeURIComponent(sessionId)}`,
        `/api/visits/${encodeURIComponent(inquiryId)}/session/${encodeURIComponent(sessionId)}`
      ];

      let events = null;
      let hitUrl = null;

      for (const url of urls) {
        try {
          const data = await fetchJson(url);
          if (Array.isArray(data) && data.length && (data[0].type || data[0].name)) {
            events = data;
            hitUrl = url;
            break;
          }
          if (data && Array.isArray(data.events)) {
            events = data.events;
            hitUrl = url;
            break;
          }
          if (data && data.session && Array.isArray(data.session.events)) {
            events = data.session.events;
            hitUrl = url;
            break;
          }
        } catch(e) {
          console.log(`Tried ${url}:`, e.message);
        }
      }

      if (!events || !events.length) {
        container.innerHTML = '<div class="no-data">No events found for this session</div>';
        return;
      }

      // Render events
      const eventsList = events.map(ev => {
        let rendered = '';
        
        if (ev.type === 'page_load') rendered = '‚úì Visit start';
        else if (ev.type === 'page_unload') rendered = '‚úï Visit end';
        else if (ev.type === 'section_enter') rendered = `‚Üí Enter section: ${ev.section}`;
        else if (ev.type === 'section_exit') rendered = `‚Ü©Ô∏é Exit section: ${ev.section} ‚Äî ${ev.dwellSec || 0}s${ev.reason ? ` [${ev.reason}]` : ''}`;
        else if (ev.type === 'tier_expand') rendered = `‚ü´ Tier opened: ${ev.tier}`;
        else if (ev.type === 'tier_exit') rendered = `‚ü™ Tier closed (inferred): ${ev.tier} ‚Äî ${ev.dwellSec || 0}s${ev.reason ? ` [${ev.reason}]` : ''}`;
        else if (ev.type === 'video_open') rendered = `‚ñ∂Ô∏é Video open: ${ev.youtubeId || ''}${ev.title ? ` ‚Äî ${ev.title}` : ''}`;
        else if (ev.type === 'video_close') rendered = `‚ñ† Video close: ${ev.youtubeId || ''}`;
        else if (ev.type === 'cta_openmorning_click') rendered = `‚òÖ Open Morning click: ${ev.href || ''}`;
        else rendered = ev.name || ev.type || 'Unknown event';

        return `<li style="margin: 4px 0; list-style-type: none; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 0.875rem;">${rendered}</li>`;
      }).join('');

      container.innerHTML = `
        <ol style="margin: 0; padding: 0;">
          ${eventsList}
        </ol>
        ${hitUrl ? `<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #64748b;">Loaded from: ${hitUrl}</div>` : ''}
      `;
    }

    // Render journey events
    function renderJourneyEvents(events) {
      if (!events || !events.length) {
        return '<div class="no-data">No events recorded</div>';
      }

      return events.map(e => {
        let icon = 'üìç';
        let title = e.type || e.name || 'Event';
        let meta = '';

        if (e.type === 'section_enter') {
          icon = 'üìñ';
          title = `Entered: ${e.section}`;
        } else if (e.type === 'section_exit') {
          icon = '‚úì';
          title = `Completed: ${e.section}`;
          meta = e.dwellSec ? `${Math.floor(e.dwellSec / 60)} min` : '';
        } else if (e.type === 'video_open') {
          icon = '‚ñ∂Ô∏è';
          title = 'Watched video';
          meta = e.title || '';
        } else if (e.type === 'tier_expand') {
          icon = 'üìÇ';
          title = `Explored: ${e.tier}`;
        }

        return `
          <div class="journey-item">
            <div class="journey-icon">${icon}</div>
            <div class="journey-content">
              <div class="journey-title">${title}</div>
              ${meta ? `<div class="journey-meta">${meta}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Show error
    function showError(message) {
      byId('familyList').innerHTML = `<div class="error">${message}</div>`;
    }

    // Initialise
    document.addEventListener('DOMContentLoaded', () => {
      byId('sortFilter')?.addEventListener('change', renderFamilies);
      byId('statusFilter')?.addEventListener('change', renderFamilies);
      byId('searchBox')?.addEventListener('input', renderFamilies);
      loadData();
    });
  </script>
</body>
</html>