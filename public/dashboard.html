<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SMART Analytics (v2)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--navy:#0a2540;--gold:#ff9f1c;--grey:#e5e7eb}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
  header{background:linear-gradient(135deg,#0a2540,#034674);color:#fff;padding:16px 20px}
  h1{margin:0;font-size:20px}
  .bar{display:flex;gap:8px;align-items:center;margin-top:8px}
  button{border:1px solid #cbd5e1;background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  button:hover{background:#f3f4f6}
  button.primary{background:var(--gold);border-color:#e07f00;color:#141b2a;font-weight:700}
  button.primary:hover{filter:brightness(.95)}
  main{padding:16px 20px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--grey);border-radius:12px;overflow:hidden}
  .card h2{font-size:16px;margin:0;padding:12px 14px;border-bottom:1px solid var(--grey);background:#fff}
  .card .body{padding:12px 14px}
  .metrics{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:12px 0}
  .metric{border:1px solid var(--grey);border-radius:10px;padding:10px;background:#fff}
  .metric .k{font-size:22px;font-weight:700;color:var(--navy)}
  .list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
  .row{border:1px solid #e5e7eb;border-radius:8px;padding:10px;display:flex;justify-content:space-between;gap:10px;background:#fff}
  .muted{opacity:.75}
  .ok{color:#059669}.warn{color:#b45309}.err{color:#dc2626}
  .pill{font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px}
  .ai-block{margin-top:8px;border-left:3px solid var(--gold);padding-left:10px}
  .ai-block .title{font-weight:600;margin-bottom:4px}
  .ai-block ul{margin:6px 0 0 16px;padding:0}
  .ai-block li{margin:2px 0;list-style:disc}
  .mini{width:100%;border-collapse:collapse;margin-top:6px}
  .mini th, .mini td{border-top:1px solid #e5e7eb;padding:6px 4px;text-align:left;font-size:12px}
  pre{white-space:pre-wrap;background:#0b1220;color:#e2e8f0;padding:10px;border-radius:8px;max-height:30vh;overflow:auto}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }

  /* --- Sessions drawer --- */
  .sessions-drawer{margin-top:10px;border-top:1px dashed #e5e7eb;padding-top:8px}
  .visit-card{border:1px solid #e5e7eb;border-radius:8px;background:#fafafa;padding:8px 10px;margin:8px 0}
  .visit-head{display:flex;justify-content:space-between;gap:10px;font-weight:600}
  .visit-meta{font-size:12px;opacity:.85}
  .visit-list{margin:6px 0 0 16px;padding:0}
  .visit-list li{margin:2px 0}
  .visit-actions{margin-top:6px;font-size:12px}
  .btn-link{color:#0a56c2;cursor:pointer;text-decoration:underline;margin-right:10px}
  .raw{display:none;background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:6px;margin-top:6px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;max-height:180px;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>SMART Analytics (v2)</h1>
  <div class="bar">
    <button id="refreshBtn">↻ Refresh</button>
    <button id="analyzeAllBtn" class="primary">Run SMART AI for all</button>
    <span id="status" class="muted">Ready</span>
  </div>
</header>

<main>
  <section class="card">
    <h2>Enquiries</h2>
    <div class="body">
      <div class="metrics">
        <div class="metric"><div class="muted">Hot Leads</div><div id="mHot" class="k">-</div></div>
        <div class="metric"><div class="muted">Warm Leads</div><div id="mWarm" class="k">-</div></div>
        <div class="metric"><div class="muted">AI Analysed</div><div id="mAI" class="k">-</div></div>
        <div class="metric"><div class="muted">Total</div><div id="mTotal" class="k">-</div></div>
      </div>
      <div id="families" class="list"><div class="muted">Loading...</div></div>
    </div>
  </section>

  <aside class="card">
    <h2>Live Activity</h2>
    <div class="body">
      <div id="activity" class="list"><div class="muted">Loading...</div></div>
      <h2 style="margin-top:12px">Last response</h2>
      <div class="body"><pre id="lastResp">(none)</pre></div>
    </div>
  </aside>
</main>

<script>
/* ---------- Utilities, status ---------- */
const S = (id) => document.getElementById(id);
const statusTxt = S('status'), familiesEl = S('families'), activityEl = S('activity'), lastResp = S('lastResp');

S('refreshBtn').onclick = init;
S('analyzeAllBtn').onclick = analyzeAll;

async function init(){
  status('Loading...');
  try{
    const fam = await fetchJson('/api/analytics/inquiries');   // working endpoint
    const dash = await fetchJson('/api/dashboard-data');       // working endpoint
    renderFamilies(Array.isArray(fam) ? fam : []);
    renderActivity(dash?.recentlyActive || []);
    renderMetrics(Array.isArray(fam) ? fam : [], dash);
    status('Loaded');
  }catch(e){
    status('Load failed - Check API endpoints', 'err', e);
    familiesEl.innerHTML = '<div class="muted">API endpoints not available. Please check your server.</div>';
    activityEl.innerHTML = '<div class="muted">No activity data - server offline.</div>';
  }
}

/* ---------- Actions ---------- */
async function analyzeAll(){
  status('Running SMART AI for all...');
  try{
    const r = await fetch('/api/ai/analyze-all-families', { method:'POST' });
    const data = await safeJson(r);
    lastResp.textContent = JSON.stringify(data ?? {http:r.status}, null, 2);
    if(!r.ok || !data?.success) throw new Error((data && (data.message||data.error)) || ('HTTP '+r.status));
    status('AI analysis complete','ok');
    await init();
  }catch(e){
    status('AI analysis failed','err', e);
    alert('SMART AI Analysis failed: ' + e.message);
  }
}

async function generateOne(inquiryId, btn){
  try{
    btn.disabled = true; 
    btn.textContent = 'Analysing...';
    const r = await fetch('/api/ai/engagement-summary/' + encodeURIComponent(inquiryId), { method:'POST' });
    const data = await safeJson(r);
    lastResp.textContent = JSON.stringify(data ?? {http:r.status}, null, 2);
    if(!r.ok || (data && data.success === false)) throw new Error((data && (data.message||data.error)) || ('HTTP '+r.status));
    await init();
  }catch(e){
    alert('Could not generate engagement summary: ' + e.message);
  }finally{
    btn.disabled = false; 
    btn.textContent = 'Regenerate AI summary';
  }
}

/* ---------- Live GET for AI engagement summary ---------- */
async function fetchEngagementSummary(inquiryId){
  const url = '/api/ai/engagement-summary/' + encodeURIComponent(inquiryId);
  const r = await fetch(url);
  const data = await safeJson(r);
  if(!r.ok) throw new Error((data&&(data.message||data.error))||('HTTP '+r.status+' '+url));
  // Normalise numeric fields
  data.sections = (data.sections||[]).map(s => ({
    ...s,
    dwell_seconds: Number(s.dwell_seconds||0),
    max_scroll_pct: Number(s.max_scroll_pct||0),
    video_plays: Number(s.video_plays||0),
    video_completes: Number(s.video_completes||0),
  }));
  data.visits = Number(data.visits||0);
  data.score  = Number(data.score||0);
  return data;
}

/* ---------- Renderers ---------- */
function renderFamilies(rows){
  if(!rows.length){ 
    familiesEl.innerHTML = '<div class="muted">No enquiries.</div>'; 
    return; 
  }
  familiesEl.innerHTML = '';
  rows.forEach(enq => {
    // Common keys; fall back where needed
    const inquiryId = enq.inquiry_id || enq.id || enq.InquiryID || enq.InquiryId;
    const name = `${escapeHtml(enq.first_name||enq.child_name||'')} ${escapeHtml(enq.family_surname||enq.last_name||'')}`.trim();
    const entryYear = escapeHtml(enq.entry_year||enq.entryYear||'');
    const email = escapeHtml(enq.parent_email||enq.email||'');
    const pretty = enq.prospectus_pretty_url
      || (enq.prospectus_pretty_path ? (location.origin + enq.prospectus_pretty_path)
      : (enq.slug ? (location.origin + '/' + enq.slug) : null));

    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <div style="flex:1">
        <div><strong>${name || '—'}</strong> <span class="muted">${entryYear ? '('+entryYear+')' : ''}</span></div>
        <div class="muted">${email || '—'}</div>
        ${pretty? `<div class="pill" style="margin-top:6px"><a href="${pretty}" target="_blank" rel="noopener">Open prospectus</a></div>`:''}

        <!-- AI block (kept) -->
        <div class="ai-block" data-ai>
          <div class="title">AI summary</div>
          <div class="muted" data-ai-text>Loading...</div>
          <table class="mini" data-ai-table style="display:none">
            <thead><tr><th>Section</th><th>Time spent</th><th>Scroll</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Sessions drawer -->
        <div class="sessions-drawer" data-sessions style="display:none"></div>
      </div>

      <div style="text-align:right;min-width:240px">
        <div class="muted" style="font-weight:700">Score <span data-ai-score>—</span></div>
        <div class="muted" style="margin:6px 0"><span data-ai-visits>—</span> visit(s)</div>
        <div style="margin:6px 0">
          <button data-id="${inquiryId}" class="gen">Regenerate AI summary</button>
        </div>
        <div>
          <button class="load-sessions-btn" data-id="${inquiryId}">Load Sessions (latest)</button>
        </div>
      </div>
    `;
    familiesEl.appendChild(row);

    // Wire buttons
    row.querySelector('.gen').onclick = () => generateOne(inquiryId, row.querySelector('.gen'));
    const btnSess = row.querySelector('.load-sessions-btn');
    const drawer  = row.querySelector('[data-sessions]');
    btnSess.onclick = () => toggleSessions(inquiryId, drawer, btnSess);

    // Live load the engagement summary per enquiry
    if(inquiryId){
      loadRowAI(inquiryId, row);
    }
  });
}

async function loadRowAI(inquiryId, row){
  const textEl = row.querySelector('[data-ai-text]');
  const table  = row.querySelector('[data-ai-table]');
  const tbody  = table?.querySelector('tbody');
  const scoreEl  = row.querySelector('[data-ai-score]');
  const visitsEl = row.querySelector('[data-ai-visits]');

  try{
    const { visits, score, sections, summaryText } = await fetchEngagementSummary(inquiryId);

    // Update right-hand badges
    if(scoreEl)  scoreEl.textContent  = String(score);
    if(visitsEl) visitsEl.textContent = String(visits);

    // Summary text
    if(textEl) { 
      textEl.classList.remove('muted'); 
      textEl.textContent = summaryText || '—'; 
    }

    // Sections table (top 5) — "Time spent", not "Dwell"
    if(tbody){
      const top = (sections||[]).slice(0,5);
      if(top.length){
        tbody.innerHTML = top.map(s => `
          <tr>
            <td>${escapeHtml(s.section)}</td>
            <td>${formatDuration(Math.round((s.dwell_seconds||0)) )}</td>
            <td>${s.max_scroll_pct}%</td>
          </tr>
        `).join('');
        table.style.display = '';
      }else{
        tbody.innerHTML = `<tr><td colspan="3" class="muted">No section data yet</td></tr>`;
        table.style.display = '';
      }
    }
  }catch(e){
    if(textEl){ 
      textEl.textContent = 'Could not load engagement summary.'; 
      textEl.classList.add('muted'); 
    }
    console.error('Engagement summary error for', inquiryId, e);
  }
}

/* ---------- Sessions (history) ---------- */
/* We DO NOT change your API. We try common read-only endpoints so it loads:
   1) /api/sessions?inquiryId=ID
   2) /api/visits/sessions/ID
   3) /api/visits/sessions?inquiryId=ID
   If a session lacks events, we fetch details from /api/sessions/SESSION_ID (read-only).
*/
async function toggleSessions(inquiryId, drawer, btn){
  if(!drawer) return;
  if(drawer.style.display === 'none' || drawer.style.display === ''){
    btn.disabled = true; btn.textContent = 'Loading...';
    try{
      const sessions = await fetchSessionsForInquiry(inquiryId);
      renderSessionsList(drawer, sessions || []);
      drawer.style.display = '';
      btn.textContent = 'Hide Sessions';
    }catch(e){
      drawer.innerHTML = `<div class="muted">Could not load sessions.</div>`;
      drawer.style.display = '';
      btn.textContent = 'Hide Sessions';
      console.error('Sessions load error', e);
    }finally{
      btn.disabled = false;
    }
  }else{
    drawer.style.display = 'none';
    btn.textContent = 'Load Sessions (latest)';
  }
}

async function fetchSessionsForInquiry(inquiryId){
  // try #1: /api/sessions?inquiryId=ID
  let r = await fetch(`/api/sessions?inquiryId=${encodeURIComponent(inquiryId)}`);
  let d = await safeJson(r);
  if(r.ok && Array.isArray(d) && d.length) return d;

  // try #2: /api/visits/sessions/ID
  r = await fetch(`/api/visits/sessions/${encodeURIComponent(inquiryId)}`);
  d = await safeJson(r);
  if(r.ok && Array.isArray(d) && d.length) return d;

  // try #3: /api/visits/sessions?inquiryId=ID
  r = await fetch(`/api/visits/sessions?inquiryId=${encodeURIComponent(inquiryId)}`);
  d = await safeJson(r);
  if(r.ok && Array.isArray(d) && d.length) return d;

  // If none worked, return [] (UI will show a gentle message)
  return [];
}

function renderSessionsList(drawer, sessions){
  if(!sessions.length){
    drawer.innerHTML = `<div class="muted">No visits yet.</div>`;
    return;
  }

  const latest = sessions
    .slice() // copy
    .sort((a,b) => (new Date(b.startTime||b.timestamp||0)) - (new Date(a.startTime||a.timestamp||0)));

  const take = latest.slice(0,3);
  drawer.innerHTML = '';
  take.forEach(sess => drawer.appendChild(renderVisitCard(sess)));

  if(sessions.length > 3){
    const more = document.createElement('div');
    more.className = 'btn-link';
    more.textContent = `Show all ${sessions.length} visits`;
    more.onclick = () => {
      drawer.innerHTML = '';
      latest.forEach(sess => drawer.appendChild(renderVisitCard(sess)));
    };
    drawer.appendChild(more);
  }
}

function renderVisitCard(session){
  const dt = new Date(session.startTime || session.timestamp);
  const dateLabel = dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
  const timeLabel = dt.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });

  // If session already has events, summarise. Otherwise we’ll lazy-fetch on expand.
  const frag = document.createElement('div');
  frag.className = 'visit-card';

  const header = document.createElement('div');
  header.className = 'visit-head';
  header.innerHTML = `
    <span>Visit · ${dateLabel} · ${timeLabel}</span>
    <span class="visit-meta" data-visit-meta>Loading…</span>
  `;
  frag.appendChild(header);

  const list = document.createElement('ul');
  list.className = 'visit-list';
  frag.appendChild(list);

  const actions = document.createElement('div');
  actions.className = 'visit-actions';
  actions.innerHTML = `
    <span class="btn-link" data-toggle-log>Show full event log</span>
    <span class="btn-link" data-copy-id>Copy Session ID</span>
    <div class="raw" data-raw></div>
  `;
  frag.appendChild(actions);

  // Wire actions
  actions.querySelector('[data-copy-id]').onclick = () => {
    const sid = session.sessionId || session.id || session.session_id || '';
    if(sid) navigator.clipboard.writeText(String(sid));
  };
  actions.querySelector('[data-toggle-log]').onclick = () => {
    const raw = actions.querySelector('[data-raw]');
    if(raw.style.display === 'block'){ raw.style.display='none'; actions.querySelector('[data-toggle-log]').textContent='Show full event log'; }
    else { raw.style.display='block'; actions.querySelector('[data-toggle-log]').textContent='Hide event log'; }
  };

  // Populate from events if present; else fetch
  if(Array.isArray(session.events) && session.events.length){
    fillVisitFromEvents(session.events, list, header.querySelector('[data-visit-meta]'), actions.querySelector('[data-raw]'));
  }else{
    // lazy-fetch details if we have a session id
    const sid = session.sessionId || session.id || session.session_id;
    if(sid){
      fetch(`/api/sessions/${encodeURIComponent(sid)}`)
        .then(safeJson)
        .then(d => {
          const ev = Array.isArray(d?.events) ? d.events : (Array.isArray(d) ? d : []);
          fillVisitFromEvents(ev, list, header.querySelector('[data-visit-meta]'), actions.querySelector('[data-raw]'));
        })
        .catch(e=>{
          header.querySelector('[data-visit-meta]').textContent='—';
          list.innerHTML = `<li class="muted">Could not load event details.</li>`;
          console.error('Session detail load error', e);
        });
    }else{
      header.querySelector('[data-visit-meta]').textContent='—';
      list.innerHTML = `<li class="muted">No details available.</li>`;
    }
  }

  return frag;
}

function fillVisitFromEvents(events, listEl, metaEl, rawEl){
  const s = summariseSessionEvents(events||[]);
  // Meta: Time spent · Sections viewed · Videos
  metaEl.textContent = `Time spent on prospectus: ${formatDuration(s.totalSeconds)} · Sections viewed: ${s.sections.length} · Videos: ${s.videosOpened}${s.videosCompleted ? (' completed: '+s.videosCompleted) : ''}`;

  // Summary list
  if(!s.sections.length){
    listEl.innerHTML = `<li class="muted">No section activity recorded.</li>`;
  }else{
    listEl.innerHTML = s.sections.map(row => {
      let extras = [];
      if(row.tiers && row.tiers.length) extras.push(`browsed tiers: ${escapeHtml(row.tiers.join(' → '))}`);
      if(row.videos && row.videos.length) extras.push(`opened video: ${escapeHtml(row.videos.join(', '))}`);
      const tail = extras.length ? ` — <span class="muted">${extras.join(' · ')}</span>` : '';
      return `<li><strong>${escapeHtml(row.name)}</strong> — ${formatDuration(row.seconds)}${tail}</li>`;
    }).join('');
  }

  // Raw log (collapsed)
  if(Array.isArray(events) && events.length){
    rawEl.innerHTML = events.map(ev => escapeHtml(JSON.stringify(ev))).join('<br>');
  }else{
    rawEl.textContent = '(no raw events)';
  }
}

function summariseSessionEvents(events){
  // Flexible schema support: type/event/action; timestamp/ts; section; duration/dwell
  const norm = events.map(e => {
    const type = (e.type || e.event || e.action || '').toLowerCase();
    const ts   = e.ts || e.timestamp || e.time || e.when || null;
    const tnum = ts ? (typeof ts === 'number' ? ts : (Date.parse(ts)||0)) : 0;
    const section = e.section || e.section_id || e.page || null;
    const title   = e.title || e.video_title || e.name || null;
    const videoId = e.video_id || e.videoId || e.youtube_id || null;
    const dur     = e.duration_seconds || e.dwell_seconds || e.duration || 0;
    const tier    = e.tier || e.tier_name || null;
    return { type, tnum, section, title, videoId, dur:Number(dur)||0, raw:e };
  }).sort((a,b)=>a.tnum-b.tnum);

  let current = null;
  const sections = [];
  let total = 0;
  let videosOpened = 0, videosCompleted = 0;

  const ensureRow = (name) => {
    let row = sections.find(r => r.name === name);
    if(!row){ row = { name, seconds:0, tiers:[], videos:[] }; sections.push(row); }
    return row;
  };

  for(const ev of norm){
    if(ev.type.includes('enter_section')){
      current = { name: ev.section || '—', start: ev.tnum||0 };
      continue;
    }
    if(ev.type.includes('exit_section')){
      if(current){
        let sec = ev.dur ? ev.dur : Math.max(0, Math.round((ev.tnum||0) - (current.start||0))/1000);
        if(!isFinite(sec) || sec<0) sec = 0;
        const row = ensureRow(current.name||'—');
        row.seconds += sec;
        total += sec;
        current = null;
      }
      continue;
    }
    if(ev.type.includes('tier') && (ev.type.includes('open') || ev.type.includes('close'))){
      if(current){
        const row = ensureRow(current.name||'—');
        if(ev.raw && ev.raw.next_tier && !row.tiers.includes(ev.raw.next_tier)) row.tiers.push(String(ev.raw.next_tier));
        else if(ev.tier && !row.tiers.includes(ev.tier)) row.tiers.push(String(ev.tier));
      }
      continue;
    }
    if(ev.type.includes('video_open') || ev.type.includes('video start') || ev.type.includes('video-play')){
      videosOpened++;
      if(current){
        const row = ensureRow(current.name||'—');
        if(ev.title) row.videos.push(String(ev.title));
      }
      continue;
    }
    if(ev.type.includes('video_complete') || ev.type.includes('video_end') || ev.type.includes('video-finish')){
      videosCompleted++;
      continue;
    }
    // If provider sends a ready-made duration event (without enter/exit)
    if(ev.type.includes('section_duration') && (ev.section || current)){
      const name = ev.section || (current && current.name) || '—';
      const row = ensureRow(name);
      row.seconds += ev.dur||0;
      total += ev.dur||0;
    }
  }

  // If we ever saw an enter without exit, don't lose it (best-effort)
  if(current && current.start){
    const row = ensureRow(current.name||'—');
    // we can't compute exact seconds without an exit; leave as-is
  }

  return { sections, totalSeconds: Math.round(total), videosOpened, videosCompleted };
}

/* ---------- Live activity ---------- */
function renderActivity(items){
  if(!items.length){ 
    activityEl.innerHTML = '<div class="muted">No recent activity.</div>'; 
    return; 
  }
  activityEl.innerHTML = '';
  items.slice(0,20).forEach(a => {
    const div = document.createElement('div'); 
    div.className='row';
    const when = a.when || a.timestamp;
    div.innerHTML = `<div><strong>${escapeHtml(a.name||'—')}</strong> — ${escapeHtml(a.activity||'activity')}</div><div class="muted">${timeAgo(when)}</div>`;
    activityEl.appendChild(div);
  });
}

/* ---------- Metrics & helpers ---------- */
function renderMetrics(fam, dash){
  const hot  = fam.filter(f => calcScore(f.engagement||{},f) >= 80).length;
  const warm = fam.filter(f => {const s = calcScore(f.engagement||{},f); return s >= 60 && s < 80}).length;
  const ai   = fam.filter(f => f.aiEngagement && f.aiEngagement.narrative).length;
  S('mHot').textContent   = hot;
  S('mWarm').textContent  = warm;
  S('mAI').textContent    = ai;
  S('mTotal').textContent = fam.length || (dash?.totalFamilies ?? 0);
}

async function fetchJson(url){
  const r = await fetch(url);
  const d = await safeJson(r);
  if(!r.ok) throw new Error((d&&(d.message||d.error))||('HTTP '+r.status+' '+url));
  lastResp.textContent = JSON.stringify({url, ok:r.ok, sample:Array.isArray(d)?d.slice(0,1):d}, null, 2);
  return d;
}

async function safeJson(r){
  try{ return await r.json(); }
  catch(e){
    try{ const text = await r.text(); console.error('Expected JSON but got:', text.slice(0,200)); }
    catch(_){}
    return null;
  }
}

function status(t,cls,e){ 
  statusTxt.className='muted'; 
  if(cls) statusTxt.className=cls; 
  statusTxt.textContent=t; 
  if(e) console.error(t,e); 
}

function timeAgo(ts){ 
  if(!ts) return '—'; 
  const d = new Date(ts);
  const n = new Date();
  const m = Math.floor((n-d)/60000);
  const h = Math.floor(m/60);
  const D = Math.floor(h/24); 
  if(m < 1) return 'Just now'; 
  if(m < 60) return m + ' min ago'; 
  if(h < 24) return h + 'h ago'; 
  if(D < 7) return D + 'd ago'; 
  return d.toLocaleDateString('en-GB'); 
}

function calcScore(eng,e){
  let s = 0;
  const mins = (eng.timeOnPage||eng.time_on_page||0)/60; 
  s += mins >= 30 ? 40 : mins >= 15 ? 30 : mins >= 5 ? 20 : Math.min(mins*4,15);
  const depth = eng.scrollDepth||eng.scroll_depth||0;     
  s += Math.min(depth*0.3,30);
  const v = eng.totalVisits||eng.total_visits||1;         
  s += v >= 5 ? 20 : v >= 3 ? 15 : v >= 2 ? 10 : 5;
  const c = eng.clickCount||eng.clicks_on_links||0;       
  s += Math.min(c*2,10);
  return Math.min(Math.round(s),100);
}

function escapeHtml(x){ 
  return String(x ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function formatDuration(sec){
  sec = Number(sec||0);
  if(sec < 60) return `${sec||0}s`;
  const m = Math.floor(sec/60), s = sec%60;
  return s ? `${m}m ${s}s` : `${m}m`;
}

/* ---------- Kick off ---------- */
init();
</script>
</body>
</html>
