<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>More House SMART Analytics Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0a2540;
  --gold: #ff9f1c;
  --green: #10b981;
  --red: #ef4444;
  --amber: #f59e0b;
  --slate: #64748b;
  --grey-50: #f8fafc;
  --grey-100: #f1f5f9;
  --grey-200: #e2e8f0;
  --grey-600: #475569;
  --grey-900: #0f172a;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--grey-50);
  color: var(--grey-900);
  line-height: 1.5;
}

.header {
  background: linear-gradient(135deg, var(--navy) 0%, #1e40af 100%);
  color: white;
  padding: 20px;
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header h1 {
  font-size: 24px;
  font-weight: 600;
}

.header-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.btn {
  padding: 8px 16px;
  border: 1px solid transparent;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--gold);
  color: var(--navy);
}

.btn-secondary {
  background: white;
  color: var(--grey-600);
  border: 1px solid var(--grey-200);
}

.status {
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
}

.status-ready { background: rgba(16, 185, 129, 0.1); color: var(--green); }
.status-loading { background: rgba(245, 158, 11, 0.1); color: var(--amber); }
.status-error { background: rgba(239, 68, 68, 0.1); color: var(--red); }

.main-content {
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px 20px;
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 24px;
}

.card {
  background: white;
  border: 1px solid var(--grey-200);
  border-radius: 12px;
  overflow: hidden;
}

.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--grey-200);
  background: var(--grey-50);
}

.card-title {
  font-size: 18px;
  font-weight: 600;
}

.card-body {
  padding: 20px;
}

.metrics {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.metric {
  background: white;
  border: 1px solid var(--grey-200);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
}

.metric-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--navy);
}

.metric-label {
  font-size: 13px;
  color: var(--slate);
  margin-top: 4px;
}

.families-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-height: 70vh;
  overflow-y: auto;
}

.family-row {
  background: white;
  border: 1px solid var(--grey-200);
  border-radius: 10px;
  padding: 16px;
}

.family-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.family-name {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 4px;
}

.family-meta {
  font-size: 13px;
  color: var(--slate);
}

.family-stats {
  display: flex;
  gap: 8px;
  align-items: center;
}

.stat-badge {
  background: var(--grey-100);
  color: var(--grey-600);
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
}

.score-badge {
  background: var(--navy);
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
}

.ai-summary {
  background: var(--grey-50);
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
  color: var(--grey-600);
  margin: 12px 0;
}

.section-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  font-size: 13px;
}

.section-table th {
  background: var(--grey-100);
  padding: 8px;
  text-align: left;
  font-weight: 600;
  border-bottom: 1px solid var(--grey-200);
}

.section-table td {
  padding: 6px 8px;
  border-bottom: 1px solid var(--grey-200);
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--slate);
}

.error {
  text-align: center;
  padding: 40px;
  color: var(--red);
}

.debug-log {
  background: #1a1a1a;
  color: #e0e0e0;
  font-family: monospace;
  font-size: 12px;
  padding: 16px;
  border-radius: 8px;
  max-height: 300px;
  overflow-y: auto;
  white-space: pre-wrap;
  margin-top: 16px;
}

@media (max-width: 1200px) {
  .main-content {
    grid-template-columns: 1fr;
  }
  .metrics {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1>More House <span style="color: var(--gold);">SMART</span> Analytics</h1>
      <div class="header-controls">
        <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
        <button id="analyzeBtn" class="btn btn-primary">Run SMART AI Analysis</button>
        <div id="status" class="status status-ready">Ready</div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <section class="card">
      <div class="card-header">
        <h2 class="card-title">Family Enquiries</h2>
      </div>
      <div class="card-body">
        <div class="metrics">
          <div class="metric">
            <div id="hotCount" class="metric-value">0</div>
            <div class="metric-label">Hot Leads</div>
          </div>
          <div class="metric">
            <div id="warmCount" class="metric-value">0</div>
            <div class="metric-label">Warm Leads</div>
          </div>
          <div class="metric">
            <div id="aiCount" class="metric-value">0</div>
            <div class="metric-label">AI Analyzed</div>
          </div>
          <div class="metric">
            <div id="totalCount" class="metric-value">0</div>
            <div class="metric-label">Total Families</div>
          </div>
        </div>
        
        <div id="familiesList" class="families-list">
          <div class="loading">Loading families...</div>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="card-header">
        <h2 class="card-title">System Status</h2>
      </div>
      <div class="card-body">
        <div id="systemStatus">
          <div style="margin-bottom: 16px;">
            <strong>API Status:</strong>
            <div id="apiStatus" style="margin-top: 8px;">Checking...</div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <strong>Available Endpoints:</strong>
            <div id="endpointStatus" style="margin-top: 8px; font-size: 13px;">Checking...</div>
          </div>
        </div>
        
        <div class="debug-log" id="debugLog">Dashboard initialized...</div>
      </div>
    </aside>
  </main>

<script>
class Dashboard {
  constructor() {
    this.elements = {
      status: document.getElementById('status'),
      familiesList: document.getElementById('familiesList'),
      debugLog: document.getElementById('debugLog'),
      apiStatus: document.getElementById('apiStatus'),
      endpointStatus: document.getElementById('endpointStatus'),
      hotCount: document.getElementById('hotCount'),
      warmCount: document.getElementById('warmCount'),
      aiCount: document.getElementById('aiCount'),
      totalCount: document.getElementById('totalCount')
    };
    
    this.init();
  }

  init() {
    this.log('Dashboard starting...');
    document.getElementById('refreshBtn').onclick = () => this.refresh();
    document.getElementById('analyzeBtn').onclick = () => this.runAI();
    this.checkEndpoints();
  }

  log(message) {
    const timestamp = new Date().toLocaleTimeString();
    this.elements.debugLog.textContent += `\n[${timestamp}] ${message}`;
    this.elements.debugLog.scrollTop = this.elements.debugLog.scrollHeight;
    console.log(message);
  }

  setStatus(text, type = 'ready') {
    this.elements.status.textContent = text;
    this.elements.status.className = `status status-${type}`;
  }

  async checkEndpoints() {
    this.log('Checking API endpoints...');
    const endpoints = [
      '/health',
      '/api/analytics/inquiries', 
      '/api/dashboard-data'
    ];

    const results = [];
    for (const endpoint of endpoints) {
      try {
        const response = await fetch(endpoint);
        const isJson = response.headers.get('content-type')?.includes('application/json');
        results.push(`${endpoint}: ${response.status} ${isJson ? '(JSON)' : '(HTML)'}`);
        
        if (!isJson && response.ok) {
          this.log(`WARNING: ${endpoint} returned HTML instead of JSON`);
        }
      } catch (error) {
        results.push(`${endpoint}: ERROR - ${error.message}`);
        this.log(`ERROR checking ${endpoint}: ${error.message}`);
      }
    }

    this.elements.endpointStatus.innerHTML = results.join('<br>');
    this.refresh();
  }

  async refresh() {
    this.setStatus('Loading...', 'loading');
    this.log('Refreshing data...');

    try {
      // Try different endpoints to see what works
      let inquiriesData = null;
      let dashboardData = null;

      // Try inquiries endpoint
      try {
        const inquiriesResponse = await fetch('/api/analytics/inquiries');
        this.log(`Inquiries response: ${inquiriesResponse.status} ${inquiriesResponse.headers.get('content-type')}`);
        
        if (inquiriesResponse.ok && inquiriesResponse.headers.get('content-type')?.includes('json')) {
          inquiriesData = await inquiriesResponse.json();
          this.log(`Got ${Array.isArray(inquiriesData) ? inquiriesData.length : 'non-array'} inquiries`);
        } else {
          const text = await inquiriesResponse.text();
          this.log(`Inquiries endpoint returned HTML: ${text.substring(0, 100)}...`);
        }
      } catch (error) {
        this.log(`Inquiries endpoint failed: ${error.message}`);
      }

      // Try dashboard endpoint
      try {
        const dashboardResponse = await fetch('/api/dashboard-data');
        this.log(`Dashboard response: ${dashboardResponse.status} ${dashboardResponse.headers.get('content-type')}`);
        
        if (dashboardResponse.ok && dashboardResponse.headers.get('content-type')?.includes('json')) {
          dashboardData = await dashboardResponse.json();
          this.log('Got dashboard data successfully');
        } else {
          const text = await dashboardResponse.text();
          this.log(`Dashboard endpoint returned HTML: ${text.substring(0, 100)}...`);
        }
      } catch (error) {
        this.log(`Dashboard endpoint failed: ${error.message}`);
      }

      // Render what we have
      if (inquiriesData && Array.isArray(inquiriesData)) {
        this.renderFamilies(inquiriesData);
        this.updateMetrics(inquiriesData);
        this.setStatus('Data loaded', 'ready');
        this.elements.apiStatus.textContent = 'APIs responding correctly';
        this.elements.apiStatus.style.color = 'var(--green)';
      } else if (dashboardData) {
        this.renderFromDashboard(dashboardData);
        this.setStatus('Partial data loaded', 'loading');
        this.elements.apiStatus.textContent = 'Some APIs returning HTML instead of JSON';
        this.elements.apiStatus.style.color = 'var(--amber)';
      } else {
        throw new Error('No valid JSON data received from any endpoint');
      }

    } catch (error) {
      this.log(`Refresh failed: ${error.message}`);
      this.setStatus('Load failed', 'error');
      this.elements.apiStatus.textContent = 'APIs not responding properly';
      this.elements.apiStatus.style.color = 'var(--red)';
      this.showError(error.message);
    }
  }

  renderFamilies(families) {
    this.log(`Rendering ${families.length} families`);
    
    if (families.length === 0) {
      this.elements.familiesList.innerHTML = '<div class="loading">No families found</div>';
      return;
    }

    this.elements.familiesList.innerHTML = '';
    
    families.forEach(family => {
      const row = this.createFamilyRow(family);
      this.elements.familiesList.appendChild(row);
      
      // Load additional data for each family
      this.loadFamilyData(family.id || family.inquiry_id, row);
    });
  }

  createFamilyRow(family) {
    const name = `${family.first_name || ''} ${family.family_surname || ''}`.trim() || 'Unknown';
    const email = family.parent_email || '';
    const entryYear = family.entry_year || '';
    const dwellMs = parseInt(family.dwell_ms || 0);
    const score = this.calculateScore(family);

    const row = document.createElement('div');
    row.className = 'family-row';
    
    row.innerHTML = `
      <div class="family-header">
        <div>
          <div class="family-name">${this.escapeHtml(name)} ${entryYear ? `<span style="color: var(--slate);">(${entryYear})</span>` : ''}</div>
          <div class="family-meta">${this.escapeHtml(email)}</div>
        </div>
        <div class="family-stats">
          <div class="stat-badge">Time: ${this.formatTime(dwellMs)}</div>
          <div class="stat-badge">Visits: <span data-visits>1</span></div>
          <div class="score-badge">${score}</div>
        </div>
      </div>
      
      <div class="ai-summary" data-summary>Loading engagement data...</div>
      
      <table class="section-table" data-sections style="display: none;">
        <thead>
          <tr><th>Section</th><th>Time</th><th>Scroll</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <div style="margin-top: 12px;">
        <button class="btn btn-secondary" onclick="app.regenerateAI('${family.id || family.inquiry_id}')">
          Regenerate AI
        </button>
      </div>
    `;
    
    return row;
  }

  async loadFamilyData(inquiryId, row) {
    try {
      // Try to get section data
      const sectionResponse = await fetch(`/api/section-data/${inquiryId}`);
      if (sectionResponse.ok) {
        const sectionData = await sectionResponse.json();
        this.renderSectionData(row, sectionData);
      }

      // Try to get AI summary
      const aiResponse = await fetch(`/api/ai/engagement-summary/${inquiryId}`);
      if (aiResponse.ok) {
        const aiData = await aiResponse.json();
        const summary = row.querySelector('[data-summary]');
        if (summary && aiData.summaryText) {
          summary.textContent = aiData.summaryText;
        }
      }
    } catch (error) {
      this.log(`Failed to load data for ${inquiryId}: ${error.message}`);
      const summary = row.querySelector('[data-summary]');
      if (summary) {
        summary.textContent = 'Additional data unavailable';
        summary.style.color = 'var(--slate)';
      }
    }
  }

  renderSectionData(row, data) {
    if (!data.sections || data.sections.length === 0) return;

    const table = row.querySelector('[data-sections]');
    const tbody = table.querySelector('tbody');
    
    tbody.innerHTML = data.sections.slice(0, 5).map(section => `
      <tr>
        <td>${this.escapeHtml(section.section_name || section.section)}</td>
        <td>${section.dwell_minutes || 0}m</td>
        <td>${section.max_scroll_pct || 0}%</td>
      </tr>
    `).join('');
    
    table.style.display = 'table';
  }

  updateMetrics(families) {
    const hot = families.filter(f => this.calculateScore(f) >= 80).length;
    const warm = families.filter(f => this.calculateScore(f) >= 60 && this.calculateScore(f) < 80).length;
    const ai = families.filter(f => f.aiEngagement).length;

    this.elements.hotCount.textContent = hot;
    this.elements.warmCount.textContent = warm;
    this.elements.aiCount.textContent = ai;
    this.elements.totalCount.textContent = families.length;
  }

  renderFromDashboard(data) {
    // Fallback rendering from dashboard data
    this.elements.familiesList.innerHTML = '<div class="loading">Using fallback data - some APIs returning HTML</div>';
    
    if (data.summary) {
      this.elements.hotCount.textContent = data.summary.hotLeads || 0;
      this.elements.warmCount.textContent = data.summary.warmLeads || 0;
      this.elements.aiCount.textContent = data.summary.aiAnalyzed || 0;
      this.elements.totalCount.textContent = data.summary.totalFamilies || 0;
    }
  }

  async runAI() {
    this.setStatus('Running AI...', 'loading');
    this.log('Starting AI analysis...');

    try {
      const response = await fetch('/api/ai/analyze-all-families', { method: 'POST' });
      const data = await response.json();
      
      if (response.ok && data.success) {
        this.log('AI analysis completed successfully');
        this.setStatus('AI complete', 'ready');
        this.refresh();
      } else {
        throw new Error(data.message || data.error || 'AI analysis failed');
      }
    } catch (error) {
      this.log(`AI analysis failed: ${error.message}`);
      this.setStatus('AI failed', 'error');
    }
  }

  async regenerateAI(inquiryId) {
    this.log(`Regenerating AI for ${inquiryId}`);
    
    try {
      const response = await fetch(`/api/ai/engagement-summary/${inquiryId}`, { method: 'POST' });
      const data = await response.json();
      
      if (response.ok) {
        this.log(`AI regenerated for ${inquiryId}`);
        this.refresh();
      } else {
        throw new Error(data.message || 'Regeneration failed');
      }
    } catch (error) {
      this.log(`AI regeneration failed: ${error.message}`);
      alert('Regeneration failed: ' + error.message);
    }
  }

  showError(message) {
    this.elements.familiesList.innerHTML = `
      <div class="error">
        <div style="margin-bottom: 16px;">Error: ${message}</div>
        <div style="font-size: 14px; color: var(--slate);">
          Check the debug log for details. Your API endpoints may be returning HTML instead of JSON.
        </div>
      </div>
    `;
  }

  calculateScore(family) {
    const dwellMs = parseInt(family.dwell_ms || 0);
    const minutes = dwellMs / (1000 * 60);
    return Math.min(Math.round(minutes * 10 + 25), 100);
  }

  formatTime(ms) {
    const minutes = Math.floor(ms / (1000 * 60));
    const seconds = Math.floor((ms % (1000 * 60)) / 1000);
    return minutes > 0 ? `${minutes}m` : `${seconds}s`;
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
}

// Initialize
const app = new Dashboard();
</script>
</body>
</html>