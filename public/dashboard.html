<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>More House School - SMART Analytics</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --blazer-navy: #091825;
      --award-gold: #FF9F1C;
      --sport-blue: #034674;
      --text-primary: #2C3E50;
      --white: #FFFFFF;
      --light-grey: #F8FAFC;
      --border-grey: #E5E7EB;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      --hot-lead: #FF4444;
      --warm-lead: #FF9F1C;
      --cold-lead: #034674;
      --font-heading: 'Playfair Display', serif;
      --font-body: 'Inter', sans-serif
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: var(--font-body);
      background: #FAFBFC;
      min-height: 100vh;
      color: var(--text-primary);
      font-size: 14px
    }

    /* Header - Refined Cheltenham Style */
    .header {
      background: var(--blazer-navy);
      color: #fff;
      padding: 2.5rem 3rem;
      border-bottom: 3px solid var(--award-gold);
      position: relative
    }

    .header-controls {
      position: absolute;
      top: 2.5rem;
      right: 3rem;
      display: flex;
      gap: 0.5rem
    }

    .refresh-btn,
    .ai-btn {
      background: transparent;
      border: 1.5px solid rgba(255, 255, 255, .25);
      color: #fff;
      padding: .625rem 1.25rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all .25s ease;
      font-size: .85rem;
      font-weight: 500;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      font-family: var(--font-body)
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, .08);
      border-color: rgba(255, 255, 255, .4)
    }

    .ai-btn {
      background: var(--award-gold);
      color: var(--blazer-navy);
      border-color: var(--award-gold);
      font-weight: 600
    }

    .ai-btn:hover {
      background: #FFB347;
      border-color: #FFB347
    }

    .header-brand {
      text-align: center;
      max-width: 800px;
      margin: 0 auto
    }

    .header h1 {
      font-family: var(--font-heading);
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      letter-spacing: -0.5px
    }

    .smart-text {
      color: var(--award-gold)
    }

    .analytics-text {
      color: #fff;
      font-weight: 400
    }

    .header p {
      font-size: 1rem;
      font-weight: 400;
      color: rgba(255, 255, 255, .75);
      letter-spacing: 0.3px
    }

    .dashboard {
      max-width: 1440px;
      margin: 0 auto;
      padding: 3rem 3rem 4rem;
      position: relative
    }

    /* Metrics - Clean Professional Cards */
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem
    }

    .metric-card {
      background: #fff;
      border-radius: 8px;
      padding: 1.75rem 1.5rem;
      border: 1px solid #E8EAED;
      transition: all .2s ease;
      position: relative;
      overflow: hidden
    }

    .metric-card:hover {
      border-color: #D1D5DB;
      box-shadow: 0 2px 12px rgba(9, 24, 37, .08)
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px
    }

    .metric-card.hot::before,
    .metric-card.contacted::before { background: var(--hot-lead) }
    .metric-card.warm::before,
    .metric-card.high-interest::before { background: var(--warm-lead) }
    .metric-card.engagement::before,
    .metric-card.booked::before { background: var(--success) }
    .metric-card.total::before { background: var(--sport-blue) }
    .metric-card.ai::before,
    .metric-card.applications::before { background: var(--award-gold) }

    .metric-title {
      font-size: .8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6B7280;
      margin-bottom: .75rem
    }

    .metric-value {
      font-size: 2.75rem;
      font-weight: 700;
      color: var(--blazer-navy);
      margin-bottom: .5rem;
      font-family: var(--font-heading);
      line-height: 1
    }

    .metric-subtitle {
      font-size: .875rem;
      font-weight: 500;
      color: #9CA3AF
    }

    /* Main Content Area */
    .main-content {
      margin-top: 0
    }

    /* Refined Filters */
    .filters {
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #E8EAED;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap
    }

    .filter-select,
    .search-box {
      padding: .75rem 1rem;
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      font-size: .875rem;
      font-family: var(--font-body);
      transition: all .2s ease;
      background: #fff
    }

    .filter-select:focus,
    .search-box:focus {
      outline: none;
      border-color: var(--sport-blue);
      box-shadow: 0 0 0 3px rgba(3, 70, 116, .1)
    }

    .search-box {
      flex: 1;
      min-width: 280px
    }

    .filter-select {
      min-width: 180px
    }

    /* Family Cards - Professional Layout */
    #familyList {
      display: grid;
      gap: 1.5rem
    }

    .family-card {
      background: #fff;
      border-radius: 8px;
      border: 1px solid #E8EAED;
      overflow: hidden;
      transition: all .2s ease
    }

    .family-card:hover {
      border-color: #D1D5DB;
      box-shadow: 0 2px 12px rgba(9, 24, 37, .08)
    }

    .family-header {
      padding: 1.75rem 2rem;
      cursor: pointer;
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 2rem;
      align-items: start;
      border-bottom: 1px solid transparent;
      transition: all .2s ease
    }

    .family-card.expanded .family-header {
      border-bottom-color: #F3F4F6;
      background: #FAFBFC
    }

    .family-info h3 {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--blazer-navy);
      font-family: var(--font-heading);
      margin-bottom: .75rem
    }

    .family-meta {
      display: flex;
      gap: 1.25rem;
      font-size: .85rem;
      color: #6B7280;
      flex-wrap: wrap;
      margin-bottom: .75rem
    }

    .family-meta span {
      display: flex;
      align-items: center;
      gap: .35rem
    }

    /* Interest Pills - Refined */
    .interests-container {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin-top: .75rem
    }

    .interest-pill {
      padding: .375rem .75rem;
      border-radius: 4px;
      font-size: .75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1.5px solid;
      background: transparent
    }

    .interest-pill.academic {
      color: var(--sport-blue);
      border-color: var(--sport-blue)
    }

    .interest-pill.creative {
      color: var(--award-gold);
      border-color: var(--award-gold)
    }

    .interest-pill.sport {
      color: var(--success);
      border-color: var(--success)
    }

    .interest-pill.priority {
      color: var(--hot-lead);
      border-color: var(--hot-lead)
    }

    /* Status Badges - Refined */
    .status-summary {
      display: flex;
      align-items: center;
      gap: .5rem
    }

    .status-badge {
      padding: .5rem 1rem;
      border-radius: 4px;
      font-size: .75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1.5px solid;
      background: transparent;
      white-space: nowrap
    }

    .status-badge.status-new { color: #6B7280; border-color: #D1D5DB }
    .status-badge.status-contacted { color: var(--sport-blue); border-color: var(--sport-blue) }
    .status-badge.status-high-interest { color: var(--hot-lead); border-color: var(--hot-lead) }
    .status-badge.status-tour-booked { color: var(--award-gold); border-color: var(--award-gold) }
    .status-badge.status-open-day-booked { color: var(--award-gold); border-color: var(--award-gold) }
    .status-badge.status-application-started { color: var(--success); border-color: var(--success) }
    .status-badge.status-application-complete { color: var(--success); border-color: var(--success) }
    .status-badge.status-not-interested { color: #9CA3AF; border-color: #D1D5DB }

    .family-stats {
      display: flex;
      align-items: center;
      gap: 1rem
    }

    /* Expand Icon */
    .expand-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1.5px solid #D1D5DB;
      border-radius: 4px;
      transition: all .2s ease;
      color: #6B7280;
      font-size: 1.25rem
    }

    .family-card.expanded .expand-icon {
      transform: rotate(180deg);
      background: var(--blazer-navy);
      border-color: var(--blazer-navy);
      color: #fff
    }

    /* Family Details */
    .family-details {
      display: none;
      padding: 2rem;
      background: #FAFBFC;
      border-top: 1px solid #F3F4F6
    }

    .family-card.expanded .family-details {
      display: block
    }

    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1.5fr;
      gap: 2rem
    }

    .detail-section h4 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--blazer-navy);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: var(--font-body)
    }

    /* Status Control */
    .status-control {
      margin: 1rem 0;
      padding: 1rem;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #E8EAED
    }

    .status-dropdown {
      padding: .625rem .875rem;
      border: 1.5px solid #D1D5DB;
      border-radius: 4px;
      font-size: .875rem;
      font-family: var(--font-body);
      background: #fff;
      cursor: pointer;
      transition: all .2s ease
    }

    .status-dropdown:focus {
      outline: none;
      border-color: var(--sport-blue);
      box-shadow: 0 0 0 3px rgba(3, 70, 116, .1)
    }

    .status-feedback {
      font-size: .8rem;
      color: var(--success);
      font-weight: 500
    }

    /* Buttons */
    .family-actions {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      margin-top: 1rem
    }

    .btn {
      padding: .625rem 1.25rem;
      border: 1.5px solid #D1D5DB;
      border-radius: 4px;
      background: #fff;
      color: var(--text-primary);
      font-size: .875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s ease;
      text-decoration: none;
      display: inline-block;
      font-family: var(--font-body)
    }

    .btn:hover {
      background: #F9FAFB;
      border-color: #9CA3AF
    }

    .btn.primary {
      background: var(--sport-blue);
      color: #fff;
      border-color: var(--sport-blue)
    }

    .btn.primary:hover {
      background: #034a8a;
      border-color: #034a8a
    }

    .btn.ai {
      background: var(--award-gold);
      color: var(--blazer-navy);
      border-color: var(--award-gold);
      font-weight: 600
    }

    .btn.ai:hover {
      background: #FFB347;
      border-color: #FFB347
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed
    }

    /* Sessions Container */
    .sessions-container h4 {
      font-size: .875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: #6B7280;
      margin-bottom: .75rem
    }

    .session-meta {
      font-size: .875rem;
      color: #6B7280;
      margin-bottom: 1rem
    }

    /* Session Cards */
    .session-card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #E8EAED;
      padding: 1.25rem;
      margin-bottom: .75rem;
      cursor: pointer;
      transition: all .2s ease
    }

    .session-card:hover {
      border-color: #D1D5DB
    }

    .session-card.open {
      background: #FAFBFC
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .session-info {
      flex: 1
    }

    .session-title {
      font-size: .95rem;
      font-weight: 600;
      color: var(--blazer-navy);
      margin-bottom: .25rem
    }

    .session-meta {
      font-size: .8rem;
      color: #6B7280
    }

    .session-body {
      display: none;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #F3F4F6
    }

    .session-card.open .session-body {
      display: block
    }

    .session-card.open .expand-icon {
      transform: rotate(180deg);
      background: var(--sport-blue);
      border-color: var(--sport-blue);
      color: #fff
    }

    /* Journey Timeline */
    .journey-timeline {
      padding: 1rem;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #E8EAED
    }

    .journey-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      margin-bottom: .75rem;
      background: #FAFBFC;
      border-radius: 4px;
      border-left: 3px solid #E5E7EB;
      transition: all .2s ease
    }

    .journey-item:hover {
      background: #F5F7FA;
      border-left-color: var(--sport-blue)
    }

    .journey-icon {
      width: 36px;
      height: 36px;
      min-width: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      border: 1.5px solid #D1D5DB;
      background: #fff;
      color: #6B7280;
      font-weight: 600
    }

    .journey-icon.section {
      border-color: var(--sport-blue);
      color: var(--sport-blue)
    }

    .journey-icon.video {
      border-color: var(--warning);
      color: var(--warning)
    }

    .journey-icon.tier {
      border-color: var(--award-gold);
      color: var(--award-gold)
    }

    .journey-icon.cta {
      border-color: var(--success);
      color: var(--success)
    }

    .journey-content {
      flex: 1
    }

    .journey-title {
      font-size: .9rem;
      font-weight: 600;
      color: var(--blazer-navy);
      margin-bottom: .25rem
    }

    .journey-meta {
      font-size: .8rem;
      color: #6B7280
    }

    .journey-progress {
      margin-top: .5rem;
      height: 4px;
      background: #E5E7EB;
      border-radius: 2px;
      overflow: hidden
    }

    .journey-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--sport-blue), var(--award-gold));
      border-radius: 2px;
      transition: width .3s ease
    }

    /* AI Summary */
    .ai-summary {
      background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
      border: 1.5px solid var(--award-gold);
      border-radius: 6px;
      padding: 1.5rem;
      margin-top: 1.5rem
    }

    .ai-summary-header {
      display: flex;
      align-items: center;
      gap: .75rem;
      margin-bottom: 1rem;
      padding-bottom: .75rem;
      border-bottom: 1px solid rgba(255, 159, 28, .2)
    }

    .ai-summary-title {
      display: flex;
      align-items: center;
      gap: .75rem;
      font-size: 1rem;
      font-weight: 700;
      color: var(--blazer-navy);
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .ai-badge {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--award-gold);
      color: var(--blazer-navy);
      font-size: .85rem;
      font-weight: 700;
      border: 1.5px solid var(--award-gold)
    }

    .ai-summary-content {
      font-size: .9rem;
      line-height: 1.6;
      color: var(--blazer-navy);
      margin-bottom: 1rem
    }

    .ai-recommendations {
      margin-top: 1rem
    }

    .ai-recommendations h5 {
      font-size: .85rem;
      font-weight: 700;
      color: var(--blazer-navy);
      margin-bottom: .5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .ai-recommendations ul {
      list-style: none;
      padding: 0
    }

    .ai-recommendations li {
      padding: .5rem 0;
      padding-left: 1.5rem;
      position: relative;
      font-size: .875rem;
      line-height: 1.5;
      color: var(--blazer-navy)
    }

    .ai-recommendations li::before {
      content: '‚Üí';
      position: absolute;
      left: 0;
      color: var(--award-gold);
      font-weight: 700
    }

    /* Utilities */
    .no-data {
      text-align: center;
      padding: 3rem;
      color: #9CA3AF;
      font-size: .95rem
    }

    .error {
      background: #FEE2E2;
      border: 1px solid #FCA5A5;
      color: #991B1B;
      padding: 1rem;
      border-radius: 6px;
      text-align: center;
      margin: 1rem
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #6B7280;
      font-size: .95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .75rem
    }

    /* Spinner Animation */
    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #D1D5DB;
      border-top-color: var(--award-gold);
      border-radius: 50%;
      animation: spin .6s linear infinite
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        padding: 2rem 1.5rem
      }

      .header h1 {
        font-size: 2.25rem
      }

      .header-controls {
        position: static;
        margin-top: 1.5rem;
        justify-content: center
      }

      .dashboard {
        padding: 2rem 1.5rem
      }

      .metrics {
        grid-template-columns: 1fr
      }

      .family-header {
        grid-template-columns: 1fr;
        gap: 1rem
      }

      .details-grid {
        grid-template-columns: 1fr
      }

      .family-meta {
        flex-direction: column;
        gap: .5rem
      }
    }
  </style>
  <style>
  .status-summary .status-badge{padding:.15rem .45rem;font-size:.85rem}
  </style>

</head>

<body>
  <header class="header">
    <div class="header-controls">
      <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
      <button class="ai-btn" onclick="generateAllSummaries()">Generate All AI Summaries</button>
    </div>
    <div class="header-brand">
      <h1><span class="smart-text">SMART</span> <span class="analytics-text">Analytics</span></h1>
      <p>More House School ‚Ä¢ Real-time Engagement Tracking</p>
    </div>
  </header>

  <div class="dashboard">
    <!-- Metrics -->
    <div class="metrics">
      <div class="metric-card total">
        <div class="metric-icon total">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
        <div class="metric-title">Total Enquiries</div>
        <div class="metric-value" id="totalFamilies">-</div>
        <div class="metric-subtitle">Active prospects</div>
      </div>
      <div class="metric-card hot">
        <div class="metric-icon hot">üìû</div>
        <div class="metric-title">Contacted</div>
        <div class="metric-value" id="contactedCount">-</div>
        <div class="metric-subtitle">Families reached</div>
      </div>
      <div class="metric-card warm">
        <div class="metric-icon warm">‚≠ê</div>
        <div class="metric-title">High Interest</div>
        <div class="metric-value" id="highInterestCount">-</div>
        <div class="metric-subtitle">Priority families</div>
      </div>
      <div class="metric-card engagement">
        <div class="metric-icon engagement">üéì</div>
        <div class="metric-title">Tours/Open Days</div>
        <div class="metric-value" id="bookedCount">-</div>
        <div class="metric-subtitle">Visits scheduled</div>
      </div>
      <div class="metric-card ai">
        <div class="metric-icon ai">üìù</div>
        <div class="metric-title">Applications</div>
        <div class="metric-value" id="applicationCount">-</div>
        <div class="metric-subtitle">In progress</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="filters">
        <select class="filter-select" id="sortFilter">
          <option value="recent">Sort by Most Recent</option>
          <option value="visits">Sort by Visit Count</option>
          <option value="time">Sort by Time Spent</option>
          <option value="status">Sort by Status</option>
        </select>
        <select class="filter-select" id="statusFilter">
          <option value="all">All Statuses</option>
          <option value="new">New Enquiries</option>
          <option value="contacted">Contacted</option>
          <option value="high-interest">High Interest</option>
          <option value="tour-booked">Tour Booked</option>
          <option value="open-day-booked">Open Day Booked</option>
          <option value="application-started">Application Started</option>
          <option value="not-interested">Not Interested</option>
        </select>
        <input type="text" class="search-box" placeholder="Search by family name..." id="searchBox" autocomplete="off">
      </div>

      <div id="familyList">
        <div class="loading">
          <div class="spinner"></div> Loading families...
        </div>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    let familyStatuses = {};
    let allFamilies = [];
    let isLoading = false;

    // Helpers
    const byId = id => document.getElementById(id);
    const setText = (id, v) => { const el = byId(id); if (el) el.textContent = String(v); };
    const fetchJson = async (url, opts = {}) => {
      const u = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const res = await fetch(u, { cache: 'no-store', ...opts });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    };
    // Status helpers (ADD)
    const STATUS_LABELS = {
      'new': 'New Inquiry',
      'contacted': 'Contacted',
      'high-interest': 'High Interest',
      'tour-booked': 'Tour Booked',
      'open-day-booked': 'Open Day Booked',
      'application-started': 'Application Started',
      'application-complete': 'Application Complete',
      'not-interested': 'Not Interested'
    };
    const statusToClass = s => `status-${s}`;
    const statusToLabel = s => STATUS_LABELS[s] || 'New Inquiry';

    // Format helpers
    const formatTimeAgo = (date) => {
      const now = new Date(), diff = now - date;
      const m = Math.floor(diff / 60000), h = Math.floor(diff / 3600000), d = Math.floor(diff / 86400000);
      if (m < 1) return 'Just now';
      if (m < 60) return `${m}m ago`;
      if (h < 24) return `${h}h ago`;
      if (d < 7) return `${d}d ago`;
      return date.toLocaleDateString('en-GB');
    };

        const formatDuration = (ms) => {
      const mins = Math.floor(ms / 60000);
      if (mins < 1) return '< 1 min';
      if (mins < 60) return `${mins} min`;
      const hours = Math.floor(mins / 60);
      return `${hours}h ${mins % 60}m`;
    };

    // Extract interests from enquiry data
    const extractInterests = (family) => {
      const interests = [];
      const interestMap = {
        // Academic
        sciences: { label: 'Sciences', type: 'academic' },
        mathematics: { label: 'Maths', type: 'academic' },
        english: { label: 'English', type: 'academic' },
        languages: { label: 'Languages', type: 'academic' },
        humanities: { label: 'Humanities', type: 'academic' },
        business: { label: 'Business', type: 'academic' },
        // Creative
        drama: { label: 'Drama', type: 'creative' },
        music: { label: 'Music', type: 'creative' },
        art: { label: 'Art', type: 'creative' },
        creative_writing: { label: 'Creative Writing', type: 'creative' },
        // Sport & Activities
        sport: { label: 'Sport', type: 'sport' },
        leadership: { label: 'Leadership', type: 'sport' },
        community_service: { label: 'Community Service', type: 'sport' },
        outdoor_education: { label: 'Outdoor Education', type: 'sport' },
        // Priorities
        academic_excellence: { label: 'Academic Excellence', type: 'priority' },
        pastoral_care: { label: 'Pastoral Care', type: 'priority' },
        university_preparation: { label: 'University Prep', type: 'priority' },
        personal_development: { label: 'Personal Development', type: 'priority' },
        career_guidance: { label: 'Career Guidance', type: 'priority' },
        extracurricular_opportunities: { label: 'Extracurriculars', type: 'priority' }
      };

      Object.keys(interestMap).forEach(key => {
        if (family[key] === true || family[key] === 'true' || family[key] === 1) {
          interests.push(interestMap[key]);
        }
      });

      return interests;
    };

    // Process and enrich family data
    function processRealData(raw) {
 return raw.map(f => {
   let totalDwellMs = 0;
   let actualVisits = 0;

   // Check multiple possible session fields
   if (f.sessions && Array.isArray(f.sessions)) {
     actualVisits = f.sessions.length;
     totalDwellMs = f.sessions.reduce((sum, s) => {
       // Try multiple duration fields and convert to ms
       const duration = Number(s.dwell_ms) || 
                       Number(s.duration_ms) || 
                       (Number(s.duration) * 1000) || 
                       (Number(s.dwell_seconds) * 1000) ||
                       (Number(s.duration_seconds) * 1000) ||
                       (Number(s.total_dwell_seconds) * 1000) || 0;
       return sum + duration;
     }, 0);
   } else {
     // Fallback to single values
     actualVisits = Number(f.session_count) || Number(f.sessions_count) || 
                   Number(f.total_sessions) || Number(f.return_visits) || 
                   Number(f.visits) || Number(f.total_visits) || 0;
     
     // Try to get total time from various fields
     totalDwellMs = Number(f.dwell_ms) || 
                    Number(f.total_dwell_ms) ||
                    (Number(f.dwell_seconds) * 1000) ||
                    (Number(f.total_dwell_seconds) * 1000) ||
                    (Number(f.total_time_seconds) * 1000) ||
                    (Number(f.time_on_page) * 1000) || 0;
   }

   // If still no visits but we have an inquiry, assume at least 1
   if (actualVisits === 0 && f.id) {
     actualVisits = 1;
   }

   // If we have visits but no time, assume 60s per visit
   if (actualVisits > 0 && totalDwellMs === 0) {
     totalDwellMs = actualVisits * 60000;
   }

   const last = f.updated_at || f.received_at || null;
   const isActiveToday = !!(last && (Date.now() - new Date(last).getTime()) <= 86400000);

   return {
     id: f.id || f.inquiry_id,
     name: `${f.first_name || ''} ${f.family_surname || ''}`.trim(),
     firstName: f.first_name,
     familySurname: f.family_surname,
     parentEmail: f.parent_email,
     entryYear: f.entry_year,
     ageGroup: f.age_group,
     receivedAt: f.received_at,
     lastActivity: last,
     timeOnPageMs: totalDwellMs,
     timeOnPageMinutes: Math.max(0, Math.round(totalDwellMs / 60000)),
     visits: actualVisits,
     sessionCount: actualVisits,
     isActiveToday,
     hasProspectus: !!f.prospectus_generated,
     prospectusUrl: f.prospectus_pretty_url || null,
     city: f.city || null,
     country: f.country || null,
     interests: extractInterests(f),
     rawData: f
   };
 }).filter(x => x.name.length);
}

    // Load main data
    async function loadData() {
      if (isLoading) return;
      isLoading = true;

      try {
        const data = await fetchJson('/api/analytics/inquiries');
        allFamilies = processRealData(Array.isArray(data) ? data : []);
        loadSavedStatuses();
        updateMetrics();
        renderFamilies();
      } catch (e) {
        showError('Failed to load data: ' + e.message);
        console.error('loadData:', e);
      } finally {
        isLoading = false;
      }
    }

    // Update metrics based on statuses
    function updateMetrics() {
      setText('totalFamilies', allFamilies.length);
      const statusCounts = {
        contacted: 0,
        'high-interest': 0,
        'tour-booked': 0,
        'open-day-booked': 0,
        'application-started': 0
      };

      allFamilies.forEach(family => {
        const status = familyStatuses[family.id] || 'new';
        if (statusCounts.hasOwnProperty(status)) {
          statusCounts[status]++;
        }
      });

      setText('contactedCount', statusCounts.contacted);
      setText('highInterestCount', statusCounts['high-interest']);
      setText('bookedCount', statusCounts['tour-booked'] + statusCounts['open-day-booked']);
      setText('applicationCount', statusCounts['application-started']);
    }

    // Update family status
    function updateFamilyStatus(familyId, newStatus) {
      familyStatuses[familyId] = newStatus;
      localStorage.setItem('familyStatuses', JSON.stringify(familyStatuses));
      updateMetrics();
    }

// Wire the dropdown to storage, badge, server save, and summary recalc (REPLACEMENT)
async function onStatusChange(id, val) {
  try {
    // 1) Update local state + counters
    updateFamilyStatus(id, val);

    // 2) Update badges (details + header)
    const summaryBadge = document.getElementById(`status-badge-summary-${id}`);
    const detailBadge  = document.getElementById(`status-badge-${id}`);
    if (summaryBadge) {
      summaryBadge.className = `status-badge status-${val}`;
      summaryBadge.textContent = statusToLabel(val);
    }
    if (detailBadge) {
      detailBadge.className = `status-badge status-${val}`;
      detailBadge.textContent = statusToLabel(val);
    }

    // 3) Inline feedback
    const fb = document.getElementById(`status-fb-${id}`);
    if (fb) fb.textContent = 'Saving‚Ä¶';

    // 4) Persist status to server (match your server route)
    // If you added the route under /api/analytics/... use that line and remove the other.
    const res = await fetch(`/api/analytics/inquiries/${encodeURIComponent(id)}/status`, {
    // const res = await fetch(`/api/inquiries/${encodeURIComponent(id)}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: val })
    });
    if (!res.ok) throw new Error(`Status save failed (${res.status})`);

    if (fb) fb.textContent = 'Saved ‚úì';

    // 5) Recalculate & persist the Overall AI Summary (uses your existing generator which does a PUT to /overall_summary)
    if (typeof generateOverallSummary === 'function') {
      await generateOverallSummary(id);
    }

    // 6) Clear feedback
    setTimeout(() => { if (fb) fb.textContent = ''; }, 2000);
  } catch (err) {
    console.error('onStatusChange error:', err);
    const fb = document.getElementById(`status-fb-${id}`);
    if (fb) fb.textContent = 'Save failed';
    setTimeout(() => { if (fb) fb.textContent = ''; }, 3500);
  }
}

    // Load saved statuses
    function loadSavedStatuses() {
      const saved = localStorage.getItem('familyStatuses');
      if (saved) {
        familyStatuses = JSON.parse(saved);
      }
    }

    // Get filtered families
    function getFilteredFamilies() {
      let families = [...allFamilies];

      const status = byId('statusFilter')?.value || 'all';
      if (status !== 'all') {
        families = families.filter(f => (familyStatuses[f.id] || 'new') === status);
      }

      const q = (byId('searchBox')?.value || '').toLowerCase();
      if (q) {
        families = families.filter(f =>
          f.name.toLowerCase().includes(q) ||
          (f.parentName || '').toLowerCase().includes(q) ||
          (f.parentEmail || '').toLowerCase().includes(q) ||
          (f.contactNumber || '').includes(q) ||
          (f.hearAboutUs || '').toLowerCase().includes(q)
        );
      }

      const sortBy = byId('sortFilter')?.value || 'recent';
      if (sortBy === 'recent') {
        families.sort((a, b) => new Date(b.lastActivity || b.receivedAt) - new Date(a.lastActivity || a.receivedAt));
      } else if (sortBy === 'time') {
        families.sort((a, b) => b.timeOnPageMs - a.timeOnPageMs);
      } else if (sortBy === 'visits') {
        families.sort((a, b) => b.visits - a.visits);
      } else if (sortBy === 'status') {
        const statusPriority = {
          'high-interest': 1,
          'tour-booked': 2,
          'open-day-booked': 3,
          'application-started': 4,
          'contacted': 5,
          'new': 6,
          'not-interested': 7,
          'enrolled': 8
        };
        families.sort((a, b) => {
          const aPriority = statusPriority[familyStatuses[a.id] || 'new'] || 99;
          const bPriority = statusPriority[familyStatuses[b.id] || 'new'] || 99;
          return aPriority - bPriority;
        });
      }

      return families;
    }

    // Render families
    function renderFamilies() {
      const container = byId('familyList');
      const list = getFilteredFamilies();

      if (!allFamilies.length) {
        container.innerHTML = '<div class="no-data">No enquiries yet</div>';
        return;
      }
      if (!list.length) {
        container.innerHTML = '<div class="no-data">No families found matching filters</div>';
        return;
      }

      container.innerHTML = list.map(f => {
        const interestPills = f.interests.map(i =>
          `<span class="interest-pill ${i.type}">${i.label}</span>`
        ).join('');

        return `
          <div class="family-card" data-id="${f.id}">
            <div class="family-header" onclick="toggleFamily('${f.id}')">
              <div class="family-info">
                <h3>${f.name}</h3>
                <div class="family-meta">
                  <span>üìß ${f.parentEmail || 'No email'}</span>
                  <span>üìÖ Entry ${f.entryYear || 'TBC'}</span>
                  <span>üéÇ ${f.ageGroup || 'Unknown'}</span>
                  <span>üìç ${formatLocation(f.city, f.country)}</span>
                  <span>‚è± ${f.timeOnPageMinutes} min total</span>
                  <span>üëÅ ${f.visits} visit${f.visits !== 1 ? 's' : ''}</span>
                </div>
                ${interestPills ? `<div class="interests-container">${interestPills}</div>` : ''}
              </div>
              <div class="family-stats">
                <div class="expand-icon">‚ñº</div>
              </div>
              <!-- Status summary badge (ALWAYS VISIBLE) -->
              <div class="status-summary" style="margin-top:.35rem;">
                <span
                  id="status-badge-summary-${f.id}"
                  class="status-badge ${'status-' + (familyStatuses[f.id] || 'new')}"
                  title="Pipeline status"
                >
                        ${statusToLabel(familyStatuses[f.id] || 'new')}
                      </span>
              </div>

              
            </div>
            <div class="family-details">
              <div class="details-grid">
                <div class="detail-section">
                  <h4>Contact & Profile</h4>
                  <div style="font-size:.875rem;line-height:1.6">
                    <strong>Email:</strong> ${f.parentEmail || 'Not provided'}<br>
                    <strong>Location:</strong> ${formatLocation(f.city, f.country)}<br>
                    <strong>Age Group:</strong> ${f.ageGroup || 'Not specified'}<br>
                    <strong>Entry Year:</strong> ${f.entryYear || 'TBC'}<br>
                    <strong>First Contact:</strong> ${f.receivedAt ? new Date(f.receivedAt).toLocaleDateString('en-GB') : 'Unknown'}<br>
                    <strong>Last Activity:</strong> ${f.lastActivity ? formatTimeAgo(new Date(f.lastActivity)) : 'No activity'}
                  </div>
                  <!-- Status Selector (ADD THIS BLOCK) -->
                  <div class="status-control" style="margin:.75rem 0;">
                    <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
                      <label for="status-${f.id}" style="font-weight:600;">Status</label>
                      <select id="status-${f.id}" class="status-dropdown"
                              onchange="onStatusChange('${f.id}', this.value)">
                        <option value="new"                 ${(familyStatuses[f.id] || 'new') === 'new' ? 'selected' : ''}>New Inquiry</option>
                        <option value="contacted"           ${(familyStatuses[f.id] || 'new') === 'contacted' ? 'selected' : ''}>Contacted</option>
                        <option value="high-interest"       ${(familyStatuses[f.id] || 'new') === 'high-interest' ? 'selected' : ''}>High Interest</option>
                        <option value="tour-booked"         ${(familyStatuses[f.id] || 'new') === 'tour-booked' ? 'selected' : ''}>Tour Booked</option>
                        <option value="open-day-booked"     ${(familyStatuses[f.id] || 'new') === 'open-day-booked' ? 'selected' : ''}>Open Day Booked</option>
                        <option value="application-started" ${(familyStatuses[f.id] || 'new') === 'application-started' ? 'selected' : ''}>Application Started</option>
                        <option value="application-complete"${(familyStatuses[f.id] || 'new') === 'application-complete' ? 'selected' : ''}>Application Complete</option>
                        <option value="not-interested"      ${(familyStatuses[f.id] || 'new') === 'not-interested' ? 'selected' : ''}>Not Interested</option>
                      </select>

                      <span class="status-badge ${'status-' + (familyStatuses[f.id] || 'new')}"
                            id="status-badge-${f.id}">
                        ${statusToLabel(familyStatuses[f.id] || 'new')}
                      </span>

                      <span id="status-fb-${f.id}" class="status-feedback" style="font-size:.85rem;opacity:.8;"></span>
                    </div>
                  </div>
                  <!-- /Status Selector -->

                  <div class="family-actions">
                    ${f.prospectusUrl ?
                      `<button class="btn primary" onclick="window.open('${f.prospectusUrl}','_blank')">View Prospectus</button>` :
                      `<button class="btn" disabled>No Prospectus</button>`}
                    ${f.parentEmail ?
                      `<a class="btn" href="mailto:${f.parentEmail}">Email Family</a>` : ''}
                    <button class="btn" onclick="copyInquiryId('${f.id}')">Copy ID</button>
                    <button class="btn" onclick="deleteInquiry('${f.id}')" 
                            style="background: #EF4444; color: white; border-color: #EF4444; margin-left: 0.5rem;"
                            title="Permanently delete this inquiry">
                      üóëÔ∏è Delete
                    </button>
                  </div>
                  

                  <!-- Overall AI Summary renders here (under Contact & Profile) -->
                  <div id="ai-overall-${f.id}" class="ai-summary" style="display:none; margin-top: 1rem;"></div>
                </div>

                <div>
                  <div class="sessions-container">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
                      <h4 style="font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#64748b">Session History</h4>
                      <button class="btn ai" onclick="generateOverallSummary('${f.id}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        Generate Overall AI Summary
                      </button>
                    </div>
                    <div id="sessions-${f.id}"></div>
                    <div style="margin-top:.5rem">
                      <button class="btn" onclick="loadSessionHistory('${f.id}')">Load All Sessions</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle family card
    function toggleFamily(id) {
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) {
        card.classList.toggle('expanded');
        if (card.classList.contains('expanded')) {
          // Try to load any saved overall summary from DB on first open
          maybeLoadSavedOverallSummary(id);
        }
      }
    }

    // Copy inquiry ID
    function copyInquiryId(id) {
      navigator.clipboard.writeText(id).catch(console.error);
    }

    // Delete inquiry with confirmation
    async function deleteInquiry(inquiryId) {
      const family = allFamilies.find(f => f.id === inquiryId);
      const familyName = family ? family.name : 'this inquiry';
      
      // Two-step confirmation for safety
      const confirmMessage = `Are you sure you want to delete ${familyName}?\n\nThis will permanently remove:\n‚Ä¢ All inquiry data\n‚Ä¢ Visit history and sessions\n‚Ä¢ AI summaries\n‚Ä¢ Status information\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      // Second confirmation
      const finalConfirm = `Final confirmation: Type "DELETE" to permanently remove ${familyName}`;
      const userInput = prompt(finalConfirm);
      
      if (userInput !== 'DELETE') {
        alert('Deletion cancelled - you must type "DELETE" exactly to confirm.');
        return;
      }

      try {
        // Show loading state
        const card = document.querySelector(`[data-id="${inquiryId}"]`);
        if (card) {
          card.style.opacity = '0.5';
          card.style.pointerEvents = 'none';
        }

        // Call delete endpoint
        const res = await fetch(`/api/analytics/inquiries/${encodeURIComponent(inquiryId)}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          throw new Error(`Delete failed: ${res.status} ${res.statusText}`);
        }

        // Remove from local data
        allFamilies = allFamilies.filter(f => f.id !== inquiryId);
        delete familyStatuses[inquiryId];
        localStorage.setItem('familyStatuses', JSON.stringify(familyStatuses));
        
        // Update UI
        updateMetrics();
        renderFamilies();
        
        // Show success message
        alert(`Successfully deleted ${familyName}`);
        
      } catch (error) {
        console.error('Delete error:', error);
        
        // Restore card if it exists
        if (card) {
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
        }
        
        alert(`Failed to delete inquiry: ${error.message}\n\nThe inquiry data has not been removed.`);
      }
    }

    // Try to fetch and render saved overall summary under Contact & Profile
    async function maybeLoadSavedOverallSummary(inquiryId) {
      const container = byId(`ai-overall-${inquiryId}`);
      if (!container || container.dataset.loaded === '1') return;
      try {
        const data = await fetchJson(`/api/analytics/inquiries/${encodeURIComponent(inquiryId)}/overall_summary`);
        if (data && (data.overview || data.summary)) {
          container.innerHTML = renderOverallSummaryBlock({
            overview: data.overview || data.summary,
            recommendations: data.recommendations || [],
            strategy: data.strategy || ''
          });
          container.style.display = 'block';
          container.dataset.loaded = '1';
        }
      } catch (e) {
        // If not found/implemented, silently ignore
      }
    }

    // Generate overall AI summary for all sessions ‚Üí renders under Contact & Profile
    async function generateOverallSummary(inquiryId) {
      const container = byId(`ai-overall-${inquiryId}`) || byId(`overall-summary-${inquiryId}`);
      if (!container) return;

      container.style.display = 'block';
      container.innerHTML = '<div class="loading"><div class="spinner"></div> Analysing all visits...</div>';

      const family = allFamilies.find(f => f.id === inquiryId);
      if (!family) {
        container.innerHTML = '<div class="error">Could not find family data</div>';
        return;
      }

      const sessionCards = document.querySelectorAll(`#sessions-${inquiryId} .session-card`);
      const actualVisits = sessionCards.length || family.visits || 1;

      const summary = generateComprehensiveSummary(family, actualVisits);

      container.innerHTML = renderOverallSummaryBlock(summary);

      // Persist to DB if your backend route exists
      try {
        await fetch(`/api/analytics/inquiries/${encodeURIComponent(inquiryId)}/overall_summary`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            overview: summary.overview,
            recommendations: summary.recommendations,
            strategy: summary.strategy
          })
        });
        container.dataset.loaded = '1';
      } catch (e) {
        // Ignore if not implemented yet
      }
    }

    function renderOverallSummaryBlock(summary) {
      return `
        <div class="ai-summary-header">
          <div class="ai-summary-title">
            <span class="ai-badge">AI</span>
            Comprehensive Engagement Analysis
          </div>
        </div>
        <div class="ai-summary-content">${summary.overview}</div>
        <div class="ai-recommendations">
          ${summary.recommendations && summary.recommendations.length ? `
            <h5>Recommended Actions</h5>
            <ul>${summary.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
          ` : ''}
        </div>
        ${summary.strategy ? `
          <div class="ai-recommendations">
            <h5>Engagement Strategy</h5>
            <p style="font-size: 0.875rem; line-height: 1.6;">${summary.strategy}</p>
          </div>
        ` : ''}
      `;
    }

    // Generate comprehensive summary for a family
    function generateComprehensiveSummary(family, actualVisits) {
      const visits = actualVisits || family.visits || 0;
      const totalMinutes = family.timeOnPageMinutes || 0;
      const interests = family.interests || [];

      let overview = '';
      const recommendations = [];
      let strategy = '';

      // Base analysis on actual data without artificial scoring
      if (visits >= 5) {
        overview = `Exceptional engagement with ${visits} visits totalling ${totalMinutes} minutes. Multiple return visits demonstrate serious consideration and strong intent. `;
        recommendations.push('URGENT: Immediate personal outreach required');
        recommendations.push('Schedule in-person tour this week');
        recommendations.push('Assign dedicated admissions officer');
        strategy = 'This family shows exceptional engagement through repeated visits. Focus on personal connection and converting interest to application. Address specific programme interests directly.';
      } else if (visits >= 3) {
        overview = `Strong engagement with ${visits} visits and ${totalMinutes} minutes spent exploring. Multiple return visits indicate growing interest. `;
        recommendations.push('Priority follow-up within 24 hours');
        recommendations.push('Personalised video message from Head');
        recommendations.push('Schedule call within 48 hours');
        strategy = 'Build on demonstrated interest with targeted follow-up. Focus on addressing potential concerns and showcasing programmes matching their interests.';
      } else if (visits >= 2) {
        overview = `Moderate engagement with ${visits} visits totalling ${totalMinutes} minutes. Return visit shows continued consideration. `;
        recommendations.push('Send tailored information pack within 3 days');
        recommendations.push('Add to priority nurture sequence');
        recommendations.push('Invite to next open event');
        strategy = 'Build on demonstrated interest with targeted follow-up. Focus on addressing potential concerns and showcasing programmes matching their interests.';
      } else {
        overview = `Initial engagement with ${visits} visit and ${totalMinutes} minutes of exploration. Early-stage prospect in research phase. `;
        recommendations.push('Add to welcome campaign');
        recommendations.push('Monitor for return visits');
        recommendations.push('Send general prospectus');
        strategy = 'Nurture early interest with broad information. Focus on building familiarity with the school and encouraging return engagement.';
      }

      const added = new Set();
      if (interests.length > 0) {
        overview += `Key interests include ${interests.slice(0, 3).map(i => i.label).join(', ')}. `;
        const academicInterests = interests.filter(i => i.type === 'academic');
        const creativeInterests = interests.filter(i => i.type === 'creative');
        const sportInterests = interests.filter(i => i.type === 'sport');
        const priorityInterests = interests.filter(i => i.type === 'priority');

        if (academicInterests.length > 0 && !added.has('academic')) {
          recommendations.push(`Share academic achievements and curriculum for: ${academicInterests.map(i => i.label).join(', ')}`);
          added.add('academic');
        }
        if (creativeInterests.length > 0 && !added.has('creative')) {
          recommendations.push(`Showcase creative programmes: ${creativeInterests.map(i => i.label).join(', ')}`);
          added.add('creative');
        }
        if (sportInterests.length > 0 && !added.has('sport')) {
          recommendations.push('Share sports facilities and team achievements');
          added.add('sport');
        }
        if (priorityInterests.find(i => i.label === 'Pastoral Care') && !added.has('pastoral')) {
          recommendations.push('Emphasise wellbeing support and house system');
          added.add('pastoral');
        }
        if (priorityInterests.find(i => i.label === 'University Prep') && !added.has('university')) {
          recommendations.push('Share university destinations and preparation programme');
          added.add('university');
        }
      }

      if (family.isActiveToday) {
        overview += 'Recent activity today shows current interest. ';
        const urgentRec = 'Strike while interest is high - contact today';
        const filteredRecs = recommendations.filter(r => r !== urgentRec);
        recommendations.length = 0;
        recommendations.push(urgentRec, ...filteredRecs);
      }

      return { overview, recommendations: recommendations.slice(0, 8), strategy };
    }

    // Load session history (no per-visit AI summary)
    async function loadSessionHistory(inquiryId) {
      const container = byId(`sessions-${inquiryId}`);
      if (!container) return;

      container.innerHTML = '<div class="loading"><div class="spinner"></div> Loading visits...</div>';

      const endpoints = [
        `/api/visits/${encodeURIComponent(inquiryId)}/history`,
        `/api/visits/${encodeURIComponent(inquiryId)}/sessions`,
        `/api/visits/${encodeURIComponent(inquiryId)}?limit=20`
      ];

      let sessions = null;
      for (const url of endpoints) {
        try {
          const data = await fetchJson(url);
          if (Array.isArray(data) && data.length) { sessions = data; break; }
          if (data && Array.isArray(data.sessions) && data.sessions.length) { sessions = data.sessions; break; }
        } catch (e) { }
      }

      if (!sessions) {
        container.innerHTML = '<div class="no-data">No visits found</div>';
        return;
      }

      sessions = sessions.slice().sort((a, b) => {
        const aDate = extractSessionDate(a);
        const bDate = extractSessionDate(b);
        return bDate - aDate;
      });

      const totalSessions = sessions.length;

      const family = allFamilies.find(f => f.id === inquiryId);
      if (family && totalSessions > family.visits) {
        let totalTimeSeconds = 0;
        for (const session of sessions) {
          let sessionDuration = 0;
          if (session.duration_seconds) sessionDuration = Number(session.duration_seconds);
          else if (session.dwell_seconds) sessionDuration = Number(session.dwell_seconds);
          else if (session.duration) sessionDuration = Number(session.duration);
          else if (session.total_dwell_seconds) sessionDuration = Number(session.total_dwell_seconds);
          else if (session.dwell_ms) sessionDuration = Number(session.dwell_ms) / 1000;
          totalTimeSeconds += sessionDuration;
        }

        family.visits = totalSessions;
        family.sessionCount = totalSessions;
        if (totalTimeSeconds > 0) {
          family.timeOnPageMs = totalTimeSeconds * 1000;
          family.timeOnPageMinutes = Math.round(totalTimeSeconds / 60);
        }
        updateFamilyDisplay(inquiryId, totalSessions, family.timeOnPageMinutes);
      }

      container.innerHTML = `
        <div class="session-meta" style="margin-bottom:1rem;color:#64748b;">
          <strong>${totalSessions}</strong> visit${totalSessions === 1 ? '' : 's'} recorded
        </div>
        ${sessions.map((s, index) => renderSessionCard(s, index, totalSessions, inquiryId)).join('')}
      `;
    }

    function updateFamilyDisplay(inquiryId, visitCount, totalMinutes) {
      const card = document.querySelector(`[data-id="${inquiryId}"]`);
      if (!card) return;

      const metaSpans = card.querySelectorAll('.family-meta span');
      metaSpans.forEach(span => {
        if (span.textContent.includes('visit')) {
          span.innerHTML = `üëÅ ${visitCount} visit${visitCount !== 1 ? 's' : ''}`;
        }
        if (span.textContent.includes('min total')) {
          span.innerHTML = `‚è± ${totalMinutes} min total`;
        }
      });
    }

    function extractSessionDate(session) {
      const sessionId = session.id || session.session_id || '';
      if (sessionId.startsWith('S-')) {
        const match = /^S-(\d{13})-/.exec(sessionId);
        if (match) {
          return new Date(Number(match[1]));
        }
      }
      const dateField = session.start || session.started_at || session.created_at;
      return dateField ? new Date(dateField) : new Date(0);
    }

    function renderSessionCard(session, index, totalSessions, inquiryId) {
      const sessionId = session.id || session.session_id || `session-${index}`;
      const visitNumber = totalSessions - index;

      let sessionDate = null;
      if (sessionId.startsWith('S-')) {
        const match = /^S-(\d{13})-/.exec(sessionId);
        if (match) {
          sessionDate = new Date(Number(match[1]));
        }
      }
      if (!sessionDate) {
        const dateField = session.start || session.started_at || session.created_at;
        if (dateField) sessionDate = new Date(dateField);
      }

      const formatDateTime = (date) => {
        if (!date) return 'Unknown time';
        return date.toLocaleString('en-GB', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      };

      const timeAgo = sessionDate ? formatTimeAgo(sessionDate) : '';

      return `
        <div class="session-card" data-session="${sessionId}" data-visit="${visitNumber}">
          <div class="session-header" onclick="toggleSession('${sessionId}', '${inquiryId}')">
            <div class="session-info">
              <div class="session-title">Visit ${visitNumber}</div>
              <div class="session-meta">
                ${formatDateTime(sessionDate)}
                ${timeAgo ? ` ‚Ä¢ ${timeAgo}` : ''}
              </div>
            </div>
            <div class="expand-icon">‚ñº</div>
          </div>
          <div class="session-body">
            <div class="journey-timeline" id="journey-${sessionId}">
              <div class="loading"><div class="spinner"></div> Click to load journey...</div>
            </div>
          </div>
        </div>
      `;
    }

    async function toggleSession(sessionId, inquiryId) {
      const card = document.querySelector(`[data-session="${sessionId}"]`);
      if (!card) return;

      card.classList.toggle('open');

      if (card.classList.contains('open')) {
        const container = byId(`journey-${sessionId}`);
        if (container && container.querySelector('.loading')) {
          await loadSessionEvents(sessionId, inquiryId);
        }
      }
    }

    async function loadSessionEvents(sessionId, inquiryId) {
      const container = byId(`journey-${sessionId}`);
      if (!container) return;

      container.innerHTML = '<div class="loading"><div class="spinner"></div> Loading journey...</div>';

      const urls = [
        `/api/visits/session/${encodeURIComponent(sessionId)}`,
        `/api/visits/session/${encodeURIComponent(sessionId)}/events`,
        `/api/sessions/${encodeURIComponent(sessionId)}`,
        `/api/session/${encodeURIComponent(sessionId)}`,
        `/api/visits/${encodeURIComponent(inquiryId)}/sessions/${encodeURIComponent(sessionId)}`,
        `/api/visits/${encodeURIComponent(inquiryId)}/session/${encodeURIComponent(sessionId)}`
      ];

      let events = null;

      for (const url of urls) {
        try {
          const data = await fetchJson(url);
          if (Array.isArray(data) && data.length && (data[0].type || data[0].name)) {
            events = data;
            break;
          }
          if (data && Array.isArray(data.events)) {
            events = data.events;
            break;
          }
          if (data && data.session && Array.isArray(data.session.events)) {
            events = data.session.events;
            break;
          }
        } catch (e) { }
      }

      if (!events || !events.length) {
        container.innerHTML = '<div class="no-data">No journey data available for this visit</div>';
        return;
      }

      const processedEvents = processEvents(events);
      container.innerHTML = renderCleanJourney(processedEvents);
    }

    function processEvents(events) {
      const journey = [];

      events.forEach(ev => {
        if (ev.type === 'heartbeat' || ev.type === 'page_hidden' || ev.type === 'page_visible' || ev.type === 'click') {
          return;
        }

        if (ev.type === 'page_load' || ev.type === '‚úì Visit start') {
          journey.push({ type: 'start', title: 'Started visit', icon: 'üöÄ' });
        } else if (ev.type === 'section_exit' && ev.section) {
          const dwellTime = ev.dwellSec || ev.dwell_seconds || 0;
          if (dwellTime > 0) {
            const sectionName = formatSectionName(ev.section);
            journey.push({ type: 'section', title: sectionName, duration: dwellTime, icon: getSectionIcon(ev.section) });
          }
        } else if (ev.type === 'video_open') {
          journey.push({ type: 'video', title: ev.title || 'Video', videoId: ev.youtubeId, icon: '‚ñ∂Ô∏è' });
        } else if (ev.type === 'tier_expand') {
          // Find if we already have an expand for this tier without a duration
          const existingTier = journey.find(j => j.type === 'tier' && j.tier === ev.tier && !j.duration);
          if (!existingTier) {
            journey.push({ type: 'tier', title: formatTierName(ev.tier), tier: ev.tier, icon: 'üìÇ' });
          }
        } else if (ev.type === 'tier_exit') {
          // Find the corresponding tier expand and add duration
          const tierItem = journey.find(j => j.type === 'tier' && j.tier === ev.tier);
          if (tierItem) {
            tierItem.duration = ev.dwellSec || 0;
          }
        } else if (ev.type === 'entry_point_interaction' && ev.action === 'exit') {
          // Also handle entry_point_interaction events for compatibility
          const tierItem = journey.find(j => j.type === 'tier' && j.tier === ev.tier);
          if (tierItem && !tierItem.duration) {
            tierItem.duration = ev.dwellSec || 0;
          }
        } else if (ev.type === 'cta_openmorning_click') {
          journey.push({ type: 'cta', title: 'Clicked Open Morning CTA', icon: '‚≠ê' });
        }
      });

      const cleaned = [];
      journey.forEach(item => {
        if (item.type === 'section') {
          if (cleaned.length && cleaned[cleaned.length - 1].type === 'section' && cleaned[cleaned.length - 1].title === item.title) {
            cleaned[cleaned.length - 1].duration += item.duration;
          } else {
            cleaned.push(item);
          }
        } else {
          cleaned.push(item);
        }
      });

      return cleaned;
    }

    function renderCleanJourney(journey) {
      if (!journey.length) {
        return '<div class="no-data">No meaningful activity recorded</div>';
      }

      const totalTime = journey
        .filter(j => j.type === 'section')
        .reduce((sum, j) => sum + (j.duration || 0), 0);

      const journeyHTML = journey.map(item => {
        if (item.type === 'start') {
          return `
            <div class="journey-item" style="background: linear-gradient(135deg, #E0F2FE, #DBEAFE);">
              <div class="journey-icon" style="background: var(--sport-blue);">${item.icon}</div>
              <div class="journey-content"><div class="journey-title">${item.title}</div></div>
            </div>
          `;
        }
        if (item.type === 'section') {
          const minutes = Math.floor(item.duration / 60);
          const seconds = item.duration % 60;
          const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
          const percentage = Math.min((item.duration / 120) * 100, 100);
          return `
            <div class="journey-item">
              <div class="journey-icon section">üìñ</div>
              <div class="journey-content">
                <div class="journey-title">${item.title}</div>
                <div class="journey-meta">Time spent: ${timeStr}</div>
                <div class="journey-progress"><div class="journey-progress-fill" style="width: ${percentage}%"></div></div>
              </div>
            </div>
          `;
        }
        if (item.type === 'video') {
          return `
            <div class="journey-item" style="background: #FEF3C7;">
              <div class="journey-icon video" style="background: var(--warning);">‚ñ∂Ô∏è</div>
              <div class="journey-content"><div class="journey-title">Watched: ${item.title}</div></div>
            </div>
          `;
        }
        if (item.type === 'tier') {
          const minutes = Math.floor((item.duration || 0) / 60);
          const seconds = (item.duration || 0) % 60;
          const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
          return `
            <div class="journey-item">
              <div class="journey-icon tier">üìÇ</div>
              <div class="journey-content">
                <div class="journey-title">Explored: ${item.title}</div>
                ${item.duration ? `<div class="journey-meta">Time spent: ${timeStr}</div>` : ''}
              </div>
            </div>
          `;
        }
        if (item.type === 'cta') {
          return `
            <div class="journey-item" style="background: #D1FAE5;">
              <div class="journey-icon cta" style="background: var(--success);">‚≠ê</div>
              <div class="journey-content"><div class="journey-title">${item.title}</div></div>
            </div>
          `;
        }
        return '';
      }).join('');

      const totalMinutes = Math.floor(totalTime / 60);
      const totalSeconds = totalTime % 60;
      const totalTimeStr = totalMinutes > 0 ? `${totalMinutes}m ${totalSeconds}s` : `${totalSeconds}s`;

      return `
        <div style="padding: 0.75rem; background: #f8fafc; border-radius: 6px; margin-bottom: 1rem;">
          <strong>Visit Summary:</strong> ${journey.filter(j => j.type === 'section').length} sections viewed ‚Ä¢ Total time: ${totalTimeStr}
        </div>
        ${journeyHTML}
      `;
    }

    function formatSectionName(section) {
      const nameMap = {
        'cover_page': 'Welcome Page',
        'heads_welcome': "Head's Welcome",
        'academic_excellence': 'Academic Excellence',
        'about_more_house': 'About More House',
        'day_in_the_life': 'Day in the Life',
        'creative_arts_hero': 'Creative Arts',
        'your_journey': 'Your Journey',
        'london_extended_classroom': 'London as Classroom',
        'city_curriculum_days': 'City Curriculum Days',
        'values_hero': 'Our Values',
        'ethical_leaders': 'Ethical Leaders',
        'discover_video': 'Discover More House',
        'cta_begin_your_journey': 'Begin Your Journey',
        'pastoral_care': 'Pastoral Care',
        'sport': 'Sports Programme'
      };

      return nameMap[section] || section.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function getSectionIcon() { return 'üìñ'; }

    function formatTierName(tier) {
      const tierMap = {
        'presenior': 'Pre-Senior (Years 5-6)',
        'senior': 'Senior (Years 7-11)',
        'sixthform': 'Sixth Form (Years 12-13)'
      };

      return tierMap[tier] || tier.replace(/\b\w/g, l => l.toUpperCase());
    }

    // Format location for display
    function formatLocation(city, country) {
      const countryNames = {
        'GB': 'United Kingdom',
        'UK': 'United Kingdom',
        'US': 'United States',
        'USA': 'United States',
        'FR': 'France',
        'DE': 'Germany',
        'ES': 'Spain',
        'IT': 'Italy',
        'IE': 'Ireland',
        'NL': 'Netherlands',
        'BE': 'Belgium',
        'CH': 'Switzerland',
        'AU': 'Australia',
        'NZ': 'New Zealand',
        'AE': 'United Arab Emirates',
        'CN': 'China',
        'HK': 'Hong Kong',
        'SG': 'Singapore',
        'IN': 'India',
        'CA': 'Canada'
      };
      const niceCountry = countryNames[country] || country || 'Unknown';
      const niceCity = city || 'Unknown';
      if (niceCity === 'Unknown' && niceCountry === 'Unknown') return 'Unknown';
      if (niceCity === 'Unknown') return niceCountry;
      if (niceCountry === 'Unknown') return niceCity;
      return `${niceCity}, ${niceCountry}`;
    }

    function showError(msg) {
      const list = byId('familyList');
      list.innerHTML = `<div class="error">${msg}</div>`;
    }

    async function generateAllSummaries() {
      // Generate overall summaries for all expanded cards only (non-intrusive)
      for (const f of allFamilies) {
        const card = document.querySelector(`[data-id="${f.id}"]`);
        if (card && card.classList.contains('expanded')) {
          await generateOverallSummary(f.id);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      byId('sortFilter').addEventListener('change', renderFamilies);
      byId('statusFilter').addEventListener('change', renderFamilies);
      byId('searchBox').addEventListener('input', renderFamilies);
      loadData();
    });
  </script>
</body>

</html>