<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>More House Analytics – Admissions Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --blazer-navy:#091825; --award-gold:#FF9F1C; --sport-blue:#034674;
      --text:#2C3E50; --white:#fff; --bg:#f6f8fb; --line:#e5e7eb; --light:#F8FAFC;
      --rate-high:#0F766E; --rate-med:#B45309; --rate-low:#374151; --rate-unrated:#6B7280;
      --heading:'Playfair Display',serif; --body:'Inter',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--body);background:linear-gradient(135deg,#f8fafc,#eef2f7);color:var(--text);font-size:14px}

    /* Header */
    .header{background:linear-gradient(135deg,#091825,#034674);color:#fff;padding:2rem;text-align:center;position:relative;box-shadow:0 4px 20px rgba(9,24,37,.25)}
    .header h1{font-family:var(--heading);font-size:3rem;letter-spacing:.2px}
    .smart{background:linear-gradient(135deg,var(--award-gold),#FFB84D);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .sub{opacity:.85;margin-top:.35rem}
    .refresh{position:absolute;right:16px;top:16px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;border-radius:8px;padding:.4rem .7rem;cursor:pointer}
    .refresh:hover{background:rgba(255,255,255,.18)}

    /* Error banner */
    #err{position:sticky;top:0;z-index:9999;background:#FEF2F2;color:#991B1B;border:1px solid #FCA5A5;padding:10px 12px;display:none;font:13px/1.3 system-ui}

    /* Layout */
    .container{max-width:1400px;margin:-24px auto 24px;padding:0 12px}
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:0 0 16px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}

    /* Cards / panels */
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 14px rgba(9,24,37,.06);overflow:hidden}
    .head{background:#034674;color:#fff;padding:.8rem 1rem;font-weight:600}
    .body{padding:1rem}
    .kpi{display:flex;align-items:center;gap:12px}
    .icon{width:44px;height:44px;border-radius:10px;background:#034674;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .val{font-size:2rem;font-family:var(--heading)}

    /* Controls */
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    input[type="text"],select,button{font:inherit}
    .input,.select{padding:.5rem;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .btn{padding:.5rem .75rem;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer}
    .btn.primary{background:#034674;color:#fff;border-color:#034674}
    .badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#eef2f7;border:1px solid var(--line);font-size:.75rem;margin-left:.35rem}

    /* Latest visit quick viewer */
    #latest-visit{border:1px solid var(--line);border-radius:10px;background:var(--light);padding:10px;margin:12px auto 16px}

    /* Families */
    .family{border:1px solid var(--line);border-radius:10px;margin-bottom:10px;overflow:hidden;background:#fff}
    .family .hdr{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;padding:.8rem 1rem;cursor:pointer}
    .family .meta{color:#64748b;font-size:.9rem}
    .family .details{display:none;border-top:1px solid var(--line);padding:1rem}
    .family.open .details{display:block}
    .pills{display:flex;gap:6px;flex-wrap:wrap}
    .pill{border:1px solid #d1d5db;border-radius:999px;padding:.25rem .6rem;font-size:.8rem;background:#fff;cursor:pointer}
    .pill.active{color:#fff;border-color:transparent}
    .pill.high.active{background:var(--rate-high)}
    .pill.medium.active{background:var(--rate-med)}
    .pill.low.active{background:var(--rate-low)}
    .pill.unrated.active{background:var(--rate-unrated)}
    textarea.notes{width:100%;min-height:72px;border:1px solid #d1d5db;border-radius:8px;padding:.6rem;margin-top:.6rem}

    /* Session summary cards */
    .session-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
    .session-card{border:1px solid var(--line);border-radius:10px;background:#fff;padding:.75rem}
    .session-card .row{display:flex;justify-content:space-between;font-size:.9rem;margin:.15rem 0}
    .session-card .bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:.4rem}
    .session-card .bar > div{height:100%;background:#034674}

    /* Timeline visual */
    .timeline{margin-top:.75rem;border:1px solid var(--line);border-radius:8px;padding:.6rem;background:#F8FAFC}
    .block{height:16px;background:#cfe2f3;border:1px solid #b6cde1;border-radius:4px;min-width:6px}
    .legend{font-size:.85rem;color:#475569;margin-top:.35rem}

    /* Sessions list */
    details.session{border:1px solid var(--line);border-radius:8px;margin:.4rem 0;background:#fff}
    details.session > summary{padding:.5rem .7rem;cursor:pointer}

    /* Leaderboard / Heatmap */
    .leader-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border-bottom:1px solid var(--line);padding:.4rem 0}
    .leader-row:last-child{border-bottom:0}
    .heat{height:10px;width:120px;background:#eef2f7;border-radius:999px;overflow:hidden}
    .heat > div{height:100%;background:#034674}

    /* Misc states */
    .loading{display:flex;gap:8px;align-items:center;justify-content:center;padding:1rem;color:#64748b}
    .error{background:#fef2f2;border:1px solid #fecaca;padding:.8rem;border-radius:8px;color:#b91c1c}
  </style>
</head>
<body>

  <div id="err"></div>

  <header class="header">
    <button class="refresh" onclick="loadAll()">Refresh</button>
    <h1><span class="smart">SMART</span> Analytics</h1>
    <div class="sub">More House School — team-rated pipeline (no automatic lead labelling)</div>
  </header>

  <!-- Latest visit viewer -->
  <div id="latest-visit">
    <strong>Latest Visit Timeline</strong>
    <div class="controls" style="margin-top:6px">
      <input id="lv-id" class="input" placeholder="Paste Inquiry ID (e.g. INQ-1756…)" style="min-width:260px;flex:1">
      <button class="btn primary" onclick="loadLatestTimeline()">Load</button>
    </div>
    <div id="lv-meta" style="font-size:.9rem;color:#334155;margin-top:4px"></div>
    <div id="lv-list" style="margin-top:6px"></div>
  </div>

  <div class="container">

    <!-- KPIs (team-rated only) -->
    <div class="metrics">
      <div class="card"><div class="body kpi"><div class="icon">👨‍👩‍👧‍👦</div><div><div style="font-size:.8rem;opacity:.7">Total Families</div><div class="val" id="k_total">-</div></div></div></div>
      <div class="card"><div class="body kpi"><div class="icon" style="background:var(--rate-high)">▲</div><div><div style="font-size:.8rem;opacity:.7">Team-Rated High</div><div class="val" id="k_high">-</div></div></div></div>
      <div class="card"><div class="body kpi"><div class="icon" style="background:var(--rate-med)">◼</div><div><div style="font-size:.8rem;opacity:.7">Team-Rated Medium</div><div class="val" id="k_med">-</div></div></div></div>
      <div class="card"><div class="body kpi"><div class="icon" style="background:var(--rate-low)">▼</div><div><div style="font-size:.8rem;opacity:.7">Team-Rated Low</div><div class="val" id="k_low">-</div></div></div></div>
      <div class="card"><div class="body kpi"><div class="icon" style="background:var(--rate-unrated)">•</div><div><div style="font-size:.8rem;opacity:.7">Unrated</div><div class="val" id="k_unrated">-</div></div></div></div>
      <div class="card"><div class="body kpi"><div class="icon" style="background:linear-gradient(135deg,#10B981,#34d399)">📊</div><div><div style="font-size:.8rem;opacity:.7">Active Today</div><div class="val" id="k_active">-</div></div></div></div>
    </div>

    <div class="grid">
      <!-- Left column -->
      <div>
        <div class="card">
          <div class="head">Family Prospects</div>
          <div class="body">
            <div class="controls">
              <select id="f_sort" class="select">
                <option value="recent">Sort by Recent Activity</option>
                <option value="time">Sort by Time Spent</option>
                <option value="visits">Sort by Return Visits</option>
              </select>
              <select id="f_rate" class="select">
                <option value="all">All Ratings</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
                <option value="unrated">Unrated</option>
              </select>
              <input id="f_q" class="input" placeholder="Search families…">
            </div>
            <div id="families"><div class="loading">Loading families…</div></div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="head">Engagement Summary (latest sessions)</div>
          <div class="body">
            <div id="sessionCards" class="session-cards"><div class="loading">Loading sessions…</div></div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div>
        <div class="card">
          <div class="head">Section Leaderboard (aggregate)</div>
          <div class="body" id="leaderboard">
            <div class="loading">Computing section stats…</div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="head">Recent Activity</div>
          <div class="body" id="recent"><div class="loading">Loading…</div></div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="head">AI Summaries (disabled)</div>
          <div class="body">
            <p style="font-size:.9rem;color:#475569">To protect trust, automated “hot/warm” wording is <strong>disabled</strong>. You can enable neutral, single-sentence summaries later.</p>
            <div class="controls" style="margin-top:8px">
              <label><input type="checkbox" id="ai_toggle"> Enable neutral AI summaries</label>
            </div>
            <div id="ai_status" style="font-size:.9rem;color:#64748b;margin-top:6px">AI summariser is off.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  'use strict';

  /* ========= Helpers ========= */
  const $ = id => document.getElementById(id);
  const setTxt = (id,v)=>{ const el=$(id); if (el) el.textContent = String(v); };
  const showErr = msg => { const b = $('err'); b.textContent='⚠️ '+msg; b.style.display='block'; };

  // Keep your original fetch style
  async function fetchJson(url, opts){
    const u = url + (url.includes('?')?'&':'?') + '_ts=' + Date.now();
    const res = await fetch(u, opts || { cache:'no-store' });
    if (!res.ok) throw new Error(res.status+' '+res.statusText);
    const ctype = (res.headers.get('content-type')||'').toLowerCase();
    if (ctype.includes('application/json')) return res.json();
    // allow callers to parse text logs if needed
    return res.text();
  }

  // State
  let familiesRaw=[], families=[], sessionsFlat=[];

  /* ========= Load All ========= */
  async function loadAll(){
    try{
      const data = await fetchJson('/api/analytics/inquiries');
      familiesRaw = Array.isArray(data) ? data : [];
      families = familiesRaw.map(shapeFamily);

      updateKPIs();
      bindControls();
      renderFamilies();
      renderRecent();

      sessionsFlat = [];
      await buildSessionCards();
      await buildSectionLeaderboard();
    }catch(e){
      console.error(e);
      showErr('Failed to load families: '+e.message);
      if ($('families')) $('families').innerHTML = '<div class="error">Could not load families.</div>';
    }
  }

  function shapeFamily(f){
    const dwellMs = Number(f.dwell_ms)||0;
    const minutes = Math.round(dwellMs/60000);
    const rating = (f.team_rating||'').toLowerCase();
    return {
      id: f.id,
      name: `${f.first_name||''} ${f.family_surname||''}`.trim() || (f.family_name||'Family'),
      email: f.parent_email||'',
      city: f.city||'',
      ageGroup: f.age_group||'',
      entryYear: f.entry_year||'TBC',
      last: f.updated_at || f.received_at || null,
      visits: Number(f.return_visits)||0,
      minutes,
      prospectusUrl: f.prospectus_pretty_url||null,
      rating: ['high','medium','low'].includes(rating)?rating:'unrated',
      notes: f.team_notes||'',
      activeToday: f.updated_at ? (Date.now()-new Date(f.updated_at).getTime())<=86400000 : false
    };
  }

  function updateKPIs(){
    setTxt('k_total', families.length);
    setTxt('k_high', families.filter(f=>f.rating==='high').length);
    setTxt('k_med', families.filter(f=>f.rating==='medium').length);
    setTxt('k_low', families.filter(f=>f.rating==='low').length);
    setTxt('k_unrated', families.filter(f=>f.rating==='unrated').length);
    setTxt('k_active', families.filter(f=>f.activeToday).length);
  }

  function bindControls(){
    ['f_q','f_rate','f_sort'].forEach(id=>{
      const el=$(id); if(!el) return;
      if (id==='f_q') el.addEventListener('input',renderFamilies);
      else el.addEventListener('change',renderFamilies);
    });
    const ai = $('ai_toggle');
    if (ai) ai.addEventListener('change',()=>{
      $('ai_status').textContent = ai.checked
        ? 'Enabled (client only). Wire your server endpoint when ready.'
        : 'AI summariser is off.';
    });

    const lv = $('lv-id');
    if (lv) lv.addEventListener('keydown', e=>{ if(e.key==='Enter') loadLatestTimeline(); });
  }

  /* ========= Families UI ========= */
  function renderFamilies(){
    const wrap = $('families'); if(!wrap) return;
    const q = ($('#f_q')?.value||'').toLowerCase();
    const rf = $('#f_rate')?.value||'all';
    const sort = $('#f_sort')?.value||'recent';

    let list = families.slice();
    if (rf!=='all') list = list.filter(f=>f.rating===rf);
    if (q) list = list.filter(f=>(f.name.toLowerCase().includes(q) || (f.email||'').toLowerCase().includes(q) || (f.city||'').toLowerCase().includes(q)));
    if (sort==='time') list.sort((a,b)=>b.minutes-a.minutes);
    else if (sort==='visits') list.sort((a,b)=>b.visits-a.visits);
    else list.sort((a,b)=>new Date(b.last||0)-new Date(a.last||0));

    if (!list.length){ wrap.innerHTML='<div class="loading">No families for current filters</div>'; return; }

    wrap.innerHTML = list.map(f=>{
      return `
        <div class="family" data-id="${f.id}">
          <div class="hdr" onclick="toggleCard('${f.id}')">
            <div><strong>${f.name} Family</strong> <span class="badge">${f.entryYear}</span></div>
            <div class="meta">${f.minutes} min • ${f.visits} visit${f.visits===1?'':'s'} • ${f.city||'—'}</div>
          </div>
          <div class="details">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <div><strong>Email:</strong> ${f.email||'—'}</div>
                <div><strong>Age Group:</strong> ${f.ageGroup||'—'}</div>
                <div><strong>Last Activity:</strong> ${f.last?new Date(f.last).toLocaleString():'—'}</div>
              </div>
              <div>
                <div><strong>Team Rating</strong></div>
                <div class="pills" style="margin-top:6px">
                  ${ratingPill(f,'high')}
                  ${ratingPill(f,'medium')}
                  ${ratingPill(f,'low')}
                  ${ratingPill(f,'unrated')}
                </div>
              </div>
            </div>

            <div class="controls" style="margin-top:10px">
              ${f.prospectusUrl?`<button class="btn primary" onclick="openProspectus('${encodeURI(f.prospectusUrl)}')">Open Prospectus</button>`:`<button class="btn" disabled>Open Prospectus</button>`}
              <button class="btn" onclick="loadCardLatest('${f.id}')">Load Timeline</button>
              <button class="btn" onclick="loadSessions('${f.id}')">Load Sessions</button>
              <button class="btn" onclick="copyId('${f.id}')">Copy Inquiry ID</button>
            </div>

            <textarea id="n-${f.id}" class="notes" placeholder="Team notes (saved on blur)" onblur="saveNotes('${f.id}')">${(f.notes||'').replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]))}</textarea>

            <div id="tl-${f.id}" class="timeline" style="display:none">
              <div id="tlm-${f.id}" style="font-size:.9rem;color:#334155;margin-bottom:.25rem"></div>
              <div id="tlb-${f.id}"></div>
              <div class="legend">Block widths reflect dwell time; hover for labels.</div>
            </div>

            <div id="ss-${f.id}" style="margin-top:8px"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function ratingPill(f, key){
    const active = f.rating===key?'active':'';
    const cls = key==='high'?'high':key==='medium'?'medium':key==='low'?'low':'unrated';
    const label = key.charAt(0).toUpperCase()+key.slice(1);
    return `<button class="pill ${cls} ${active}" onclick="setRating(event,'${f.id}','${key}')">${label}</button>`;
  }

  function toggleCard(id){ const el = document.querySelector(\`.family[data-id="\${id}"]\`); if(el) el.classList.toggle('open'); }
  function openProspectus(u){ window.open(u,'_blank'); }
  function copyId(id){ navigator.clipboard.writeText(id).catch(()=>{}); }

  async function setRating(ev,id,val){
    ev.stopPropagation();
    try{
      const f = families.find(x=>x.id===id); if (!f) return;
      f.rating = val;
      await fetchJson(`/api/inquiries/${encodeURIComponent(id)}/rating`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rating:val})});
      updateKPIs();
      renderFamilies();
    }catch(e){ console.error(e); showErr('Could not save rating: '+e.message); }
  }
  async function saveNotes(id){
    const ta = $(`n-${id}`); if (!ta) return;
    try{
      await fetchJson(`/api/inquiries/${encodeURIComponent(id)}/notes`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({notes:ta.value||''})});
    }catch(e){ console.error(e); showErr('Could not save notes: '+e.message); }
  }

  /* ========= Latest visit quick viewer ========= */
  async function loadLatestTimeline(){
    const id = ($('#lv-id')?.value||'').trim();
    const meta = $('lv-meta'), list = $('lv-list');
    if (!id){ meta.textContent='Please paste an Inquiry ID.'; list.innerHTML=''; return; }
    meta.textContent='Loading…'; list.innerHTML='';
    const body = await getLatestVisit(id);
    if (!body || !body.ok || !body.session){ meta.textContent='No visits found.'; return; }
    const fmt = ts => new Date(ts).toLocaleString();
    meta.textContent = `Session ${body.session.id} — ${fmt(body.session.start)} → ${fmt(body.session.end)}`;
    list.innerHTML = body.events.map(renderEventHTML).join('');
  }

  async function getLatestVisit(inquiryId){
    try{
      const data = await fetchJson(`/api/visits/${encodeURIComponent(inquiryId)}/latest`);
      if (typeof data === 'string'){ // text page/log
        const parsed = parseSessionLog(data);
        return parsed.length ? { ok:true, session:{id:'latest',start:null,end:null}, events:parsed } : null;
      }
      return data;
    }catch(e){ showErr('Latest visit failed: '+e.message); return null; }
  }

  function renderEventHTML(e){
    if (e.type==='section_enter')  return `→ Enter section: ${e.section}`;
    if (e.type==='section_exit')   return `↩︎ Exit section: ${e.section} — ${e.dwellSec??0}s${e.reason?` [${e.reason}]`:''}`;
    if (e.type==='tier_expand')    return `⟫ Tier opened: ${e.tier}`;
    if (e.type==='tier_exit')      return `⟪ Tier closed: ${e.tier} — ${e.dwellSec??0}s${e.reason?` [${e.reason}]`:''}`;
    if (e.type==='video_open')     return `▶︎ Video open: ${e.youtubeId||''}${e.title?` — ${e.title}`:''}`;
    if (e.type==='video_close')    return `■ Video close: ${e.youtubeId||''}`;
    if (e.type==='page_load')      return '✓ Visit start';
    if (e.type==='page_unload')    return '✕ Visit end';
    return e.name || e.type;
  }

  /* ========= Family timeline & sessions ========= */
  async function loadCardLatest(id){
    const tl = $(`tl-${id}`), tlm = $(`tlm-${id}`), tlb = $(`tlb-${id}`);
    if (!tl||!tlm||!tlb) return;
    tl.style.display='block'; tlm.textContent='Loading…'; tlb.innerHTML='';
    const body = await getLatestVisit(id);
    if (!body || !body.ok || !body.session){ tlm.textContent='No visits found.'; return; }
    tlm.textContent = formatSessionHeader(body.session);
    drawTimelineBlocks(tlb, body.events);
    upsertSessionsFlat(id, body.session, body.events);
    buildSectionLeaderboard();
  }
  function formatSessionHeader(s){ const f = d=>d?new Date(d).toLocaleString():'?'; return `Session ${s.id||''} — ${f(s.start)} → ${f(s.end)}`; }

  async function loadSessions(id){
    const box = $(`ss-${id}`); if (!box) return;
    box.innerHTML = '<div class="loading">Loading sessions…</div>';
    const hist = await fetchVisitHistory(id);
    if (!hist || !hist.sessions || !hist.sessions.length){ box.innerHTML='<div class="loading">No sessions</div>'; return; }

    // Render list, lazy-load events
    box.innerHTML = hist.sessions.slice().sort((a,b)=>new Date(b.start||b.started_at||0)-new Date(a.start||a.started_at||0))
      .map(s=>{
        const sid = s.id || s.session_id || '';
        const start = s.start || s.started_at || '';
        const end = s.end || s.ended_at || '';
        return `
          <details class="session">
            <summary><strong>${sid||'Session'}</strong> — ${start?new Date(start).toLocaleString():'?'}${end?' → '+new Date(end).toLocaleString():''}</summary>
            <div id="ev-${sid}" style="padding:.5rem .7rem">Click to load events…</div>
          </details>
        `;
      }).join('');

    box.querySelectorAll('details.session').forEach(d=>{
      d.addEventListener('toggle', async ()=>{
        if (!d.open) return;
        const sid = (d.querySelector('summary').textContent||'').replace(/^Session\s*/,'').split('—')[0].trim();
        const tgt = d.querySelector(`#ev-${sid}`);
        if (!tgt || tgt.dataset.loaded) return;
        tgt.textContent = 'Loading events…';
        const res = await fetchSessionEvents(sid,id);
        const evs = (res && res.events)||[];
        tgt.innerHTML = evs.length ? renderEventListWithMiniTimeline(evs) : 'No events';
        tgt.dataset.loaded = '1';
        upsertSessionsFlat(id, {id:sid}, evs);
        buildSectionLeaderboard();
      });
    });
  }

  // History: try many endpoints + parse text lists
  async function fetchVisitHistory(inquiryId){
    const urls = [
      `/api/visits/${encodeURIComponent(inquiryId)}/history`,
      `/api/visits/${encodeURIComponent(inquiryId)}/sessions`,
      `/api/visits/${encodeURIComponent(inquiryId)}?limit=20`,
      `/api/inquiries/${encodeURIComponent(inquiryId)}/sessions`,
      `/api/sessions?inquiryId=${encodeURIComponent(inquiryId)}`,
      `/api/sessions?inquiry_id=${encodeURIComponent(inquiryId)}`
    ];
    for (const u of urls){
      try{
        const resp = await fetchJson(u);
        if (typeof resp === 'string'){ // text page/log; try to extract session IDs
          const ids = Array.from(new Set(resp.match(/S-\d{13}-[a-z0-9]+/g)||[]));
          if (ids.length) return { sessions: ids.map(id=>({id})) };
          continue;
        }
        const d = resp;
        if (Array.isArray(d) && d.length) return { sessions: d };
        if (d && Array.isArray(d.sessions) && d.sessions.length) return { sessions: d.sessions };
        if (d && d.data && Array.isArray(d.data.sessions) && d.data.sessions.length) return { sessions: d.data.sessions };
      }catch(e){ /* try next */ }
    }
    return null;
  }

  // Events: try JSON endpoints first, then parse text logs if needed
  async function fetchSessionEvents(sessionId,inquiryId){
    const urls = [
      `/api/visits/session/${encodeURIComponent(sessionId)}`,
      `/api/visits/session/${encodeURIComponent(sessionId)}/events`,
      `/api/visits/${encodeURIComponent(inquiryId)}/sessions/${encodeURIComponent(sessionId)}`,
      `/api/sessions/${encodeURIComponent(sessionId)}`,
      `/api/sessions/${encodeURIComponent(sessionId)}/events`,
    ];
    for (const u of urls){
      try{
        const res = await fetch(u + (u.includes('?')?'&':'?') + '_ts=' + Date.now(), {cache:'no-store'});
        const ctype = (res.headers.get('content-type')||'').toLowerCase();
        const text = await res.text();

        if (ctype.includes('application/json')){
          try{
            const d = JSON.parse(text);
            if (Array.isArray(d) && d.length && (d[0].type||d[0].name)) return {events:d,hit:u};
            if (d && Array.isArray(d.events)) return {events:d.events,hit:u};
            if (d && d.data && Array.isArray(d.data.events)) return {events:d.data.events,hit:u};
          }catch{ /* fall through */ }
        }
        const parsed = parseSessionLog(text);
        if (parsed.length) return {events:parsed,hit:u};
      }catch(e){ /* try next */ }
    }
    return {events:[]};
  }

  // Parse your plain-text session logs into structured events
  function parseSessionLog(text){
    if (!text || typeof text!=='string') return [];
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if (!lines.length) return [];
    const evs = [];
    for (const line of lines){
      if (/^✓\s*Visit start/i.test(line)){ evs.push({type:'page_load'}); continue; }
      if (/^✕\s*Visit end/i.test(line)){ evs.push({type:'page_unload'}); continue; }

      let m = line.match(/^→\s*Enter section:\s*(.+)$/i);
      if (m){ evs.push({type:'section_enter', section:m[1].trim()}); continue; }

      m = line.match(/^↩︎?\s*Exit section:\s*([—\-\w\d_ ]+?)(?:\s*[—-]\s*(\d+)s)?(?:\s*\[(.+?)\])?$/i);
      if (m){
        const section = (m[1]||'').trim();
        const dwellSec = m[2] ? Number(m[2]) : undefined;
        const reason = m[3] ? m[3].trim() : undefined;
        evs.push({type:'section_exit', section, dwellSec, reason}); continue;
      }

      m = line.match(/^⟫\s*Tier opened:\s*(.+)$/i);
      if (m){ evs.push({type:'tier_expand', tier:m[1].trim()}); continue; }

      m = line.match(/^⟪\s*Tier closed.*?:\s*(.+?)(?:\s*[—-]\s*(\d+)s)?(?:\s*\[(.+?)\])?$/i);
      if (m){
        const tier = (m[1]||'').trim();
        const dwellSec = m[2] ? Number(m[2]) : undefined;
        const reason = m[3] ? m[3].trim() : undefined;
        evs.push({type:'tier_exit', tier, dwellSec, reason}); continue;
      }

      m = line.match(/^▶︎\s*Video open:\s*([A-Za-z0-9_-]+)(?:\s*[—-]\s*(.+))?$/i);
      if (m){ evs.push({type:'video_open', youtubeId:m[1], title:m[2]?.trim()}); continue; }

      m = line.match(/^■\s*Video close:\s*([A-Za-z0-9_-]+)/i);
      if (m){ evs.push({type:'video_close', youtubeId:m[1]}); continue; }

      // generic fallback to preserve context
      evs.push({type:'log', name: line});
    }
    return evs;
  }

  function drawTimelineBlocks(container, events){
    const segs = [];
    events.forEach(e=>{
      if (e.type==='section_exit'){
        const secs = Number(e.dwellSec)||0;
        segs.push({label:e.section||'section', secs});
      }
    });
    const total = segs.reduce((a,b)=>a+b.secs,0)||1;
    container.innerHTML = segs.map(s=>{
      const w = Math.max(3, Math.round((s.secs/total)*100));
      return `<div style="display:flex;gap:6px;align-items:center;margin:.25rem 0">
        <div class="block" style="width:${w}%;" title="${s.label} — ${s.secs}s"></div>
        <div style="font-size:.9rem">${s.label} <span class="badge">${s.secs}s</span></div>
      </div>`;
    }).join('') || '<div style="color:#64748b">No section dwell recorded.</div>';
  }

  function renderEventListWithMiniTimeline(events){
    const blocks = [];
    events.forEach(e=>{
      if (e.type==='section_exit'){
        const secs = Number(e.dwellSec)||0;
        blocks.push({label:e.section||'section', secs});
      }
    });
    const total = blocks.reduce((a,b)=>a+b.secs,0)||1;
    const mini = `<div class="session-card bar" title="Section dwell proportions" style="margin:0 0 .4rem 0">
      <div style="width:100%;display:flex;gap:0">
        ${blocks.map(b=>`<div style="width:${Math.max(2,Math.round((b.secs/total)*100))}%;height:8px;background:#034674"></div>`).join('')}
      </div>
    </div>`;
    const list = events.map(e=>`<div>${renderEventHTML(e)}</div>`).join('');
    return mini + list;
  }

  function upsertSessionsFlat(inquiryId, session, events){
    if (!events || !events.length) return;
    const sections = [];
    events.forEach(e=>{
      if (e.type==='section_exit'){
        const secs = Number(e.dwellSec)||0;
        sections.push({name:e.section||'section', secs});
      }
    });
    if (!sections.length) return;
    sessionsFlat.push({inquiryId, sessionId: session.id||'', sections});
  }

  /* ========= Session cards ========= */
  async function buildSessionCards(){
    const target = $('sessionCards'); if (!target) return;
    const subset = families.slice(0,12);
    if (!subset.length){ target.innerHTML='<div class="loading">No sessions yet</div>'; return; }

    const rows = [];
    for (const f of subset){
      let res = null;
      try{
        const data = await fetchJson(`/api/visits/${encodeURIComponent(f.id)}/latest`);
        res = (typeof data === 'string') ? { ok:true, session:{id:'latest',start:null,end:null}, events:parseSessionLog(data) } : data;
      }catch{}
      if (!res || !res.ok || !res.session) continue;

      const secs = [];
      res.events.forEach(e=>{ if (e.type==='section_exit') secs.push(Number(e.dwellSec)||0); });
      const total = secs.reduce((a,b)=>a+b,0)||1;
      const pct = Math.min(100, Math.round((total/480)*100)); // ~8 min baseline
      upsertSessionsFlat(f.id, res.session, res.events);

      rows.push(`
        <div class="session-card" title="${f.name}">
          <div class="row"><strong>${f.name}</strong><span>${f.entryYear}</span></div>
          <div class="row"><span>Sections viewed</span><span>${secs.length}</span></div>
          <div class="row"><span>Estimated dwell</span><span>${Math.round(total)}s</span></div>
          <div class="bar"><div style="width:${pct}%"></div></div>
        </div>
      `);
    }
    target.innerHTML = rows.join('') || '<div class="loading">No recent sessions</div>';
  }

  /* ========= Leaderboard ========= */
  async function buildSectionLeaderboard(){
    const agg = {};
    sessionsFlat.forEach(s=>{
      s.sections.forEach(x=>{
        const k = x.name||'section';
        if (!agg[k]) agg[k]={count:0, secs:0};
        agg[k].count += 1;
        agg[k].secs  += Number(x.secs)||0;
      });
    });
    const box = $('leaderboard'); if (!box) return;
    const rows = Object.keys(agg).map(k=>({name:k, count:agg[k].count, secs:agg[k].secs}))
                  .sort((a,b)=>b.count-a.count).slice(0,12);
    if (!rows.length){ box.innerHTML = '<div class="loading">No section data yet</div>'; return; }
    const maxC = Math.max(1, ...rows.map(r=>r.count));
    const maxS = Math.max(1, ...rows.map(r=>r.secs));
    box.innerHTML = `
      <div style="font-size:.85rem;color:#475569;margin-bottom:6px">Left bar = visits · Right bar = total dwell</div>
      ${rows.map(r=>`
        <div class="leader-row">
          <div><strong>${r.name}</strong></div>
          <div class="heat" title="Visits: ${r.count}"><div style="width:${Math.round((r.count/maxC)*100)}%"></div></div>
          <div class="heat" title="Dwell: ${r.secs}s"><div style="width:${Math.round((r.secs/maxS)*100)}%"></div></div>
        </div>
      `).join('')}
    `;
  }

  /* ========= Recent activity ========= */
  function renderRecent(){
    const box = $('recent');
    const list = families.slice().sort((a,b)=>new Date(b.last||0)-new Date(a.last||0)).slice(0,10);
    if (!list.length){ box.innerHTML='<div class="loading">No recent activity</div>'; return; }
    box.innerHTML = list.map(f=>{
      const initial = (f.name||'F').charAt(0).toUpperCase();
      const ago = f.last?timeAgo(new Date(f.last)):'—';
      const label = f.prospectusUrl?'viewed personalised prospectus':'interacted';
      return `<div style="display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--line);padding:.6rem 0">
        <div style="width:36px;height:36px;border-radius:50%;background:var(--award-gold);color:var(--blazer-navy);display:flex;align-items:center;justify-content:center;font-weight:700">${initial}</div>
        <div style="flex:1;font-size:.95rem"><strong>${f.name}</strong> ${label}</div>
        <div style="font-size:.8rem;color:#64748b">${ago}</div>
      </div>`;
    }).join('');
  }
  function timeAgo(d){
    const diff = Date.now()-d.getTime();
    const m = Math.floor(diff/60000), h=Math.floor(diff/3600000), dd=Math.floor(diff/86400000);
    if (m<1) return 'Just now';
    if (m<60) return `${m}m ago`;
    if (h<24) return `${h}h ago`;
    if (dd<7) return `${dd}d ago`;
    return d.toLocaleDateString();
  }

  /* ========= Bootstrap ========= */
  document.addEventListener('DOMContentLoaded', ()=>loadAll());
  </script>
</body>
</html>
