<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SMART Analytics (v2)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--navy:#0a2540;--gold:#ff9f1c;--grey:#e5e7eb}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
  header{background:linear-gradient(135deg,#0a2540,#034674);color:#fff;padding:16px 20px}
  h1{margin:0;font-size:20px}
  .bar{display:flex;gap:8px;align-items:center;margin-top:8px}
  button{border:1px solid #cbd5e1;background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  button:hover{background:#f3f4f6}
  button.primary{background:var(--gold);border-color:#e07f00;color:#141b2a;font-weight:700}
  button.primary:hover{filter:brightness(.95)}
  main{padding:16px 20px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--grey);border-radius:12px;overflow:hidden}
  .card h2{font-size:16px;margin:0;padding:12px 14px;border-bottom:1px solid var(--grey);background:#fff}
  .card .body{padding:12px 14px}
  .metrics{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:12px 0}
  .metric{border:1px solid var(--grey);border-radius:10px;padding:10px;background:#fff}
  .metric .k{font-size:22px;font-weight:700;color:var(--navy)}
  .list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
  .row{border:1px solid #e5e7eb;border-radius:8px;padding:10px;display:flex;justify-content:space-between;gap:10px;background:#fff}
  .muted{opacity:.75}
  .ok{color:#059669}.warn{color:#b45309}.err{color:#dc2626}
  .pill{font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px}
  .ai-block{margin-top:8px;border-left:3px solid var(--gold);padding-left:10px}
  .ai-block .title{font-weight:600;margin-bottom:4px}
  .ai-block ul{margin:6px 0 0 16px;padding:0}
  .ai-block li{margin:2px 0;list-style:disc}
  .mini{width:100%;border-collapse:collapse;margin-top:6px}
  .mini th,.mini td{border-top:1px solid #e5e7eb;padding:6px 4px;text-align:left;font-size:12px}
  pre{white-space:pre-wrap;background:#0b1220;color:#e2e8f0;padding:10px;border-radius:8px;max-height:30vh;overflow:auto}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>SMART Analytics (v2)</h1>
  <div class="bar">
    <button id="refreshBtn">↻ Refresh</button>
    <button id="analyzeAllBtn" class="primary">Run SMART AI for all</button>
    <span id="status" class="muted">Ready</span>
  </div>
</header>

<main>
  <section class="card">
    <h2>Enquiries</h2>
    <div class="body">
      <div class="metrics">
        <div class="metric"><div class="muted">Hot Leads</div><div id="mHot" class="k">-</div></div>
        <div class="metric"><div class="muted">Warm Leads</div><div id="mWarm" class="k">-</div></div>
        <div class="metric"><div class="muted">AI Analysed</div><div id="mAI" class="k">-</div></div>
        <div class="metric"><div class="muted">Total</div><div id="mTotal" class="k">-</div></div>
      </div>
      <div id="families" class="list"><div class="muted">Loading...</div></div>
    </div>
  </section>

  <aside class="card">
    <h2>Live Activity</h2>
    <div class="body">
      <div id="activity" class="list"><div class="muted">Loading...</div></div>
      <h2 style="margin-top:12px">Last response</h2>
      <div class="body"><pre id="lastResp">(none)</pre></div>
    </div>
  </aside>
</main>

<script>
const S = (id) => document.getElementById(id);
const statusTxt = S('status'), familiesEl = S('families'), activityEl = S('activity'), lastResp = S('lastResp');

S('refreshBtn').onclick = init;
S('analyzeAllBtn').onclick = analyzeAll;

async function init(){
  status('Loading...');
  try{
    const fam = await fetchJson('/api/analytics/inquiries');   
    const dash = await fetchJson('/api/dashboard-data');       
    renderFamilies(Array.isArray(fam) ? fam : []);
    renderActivity(dash?.recentlyActive || []);
    renderMetrics(Array.isArray(fam) ? fam : [], dash);
    status('Loaded');
  }catch(e){
    status('Load failed - Check API endpoints', 'err', e);
    familiesEl.innerHTML = '<div class="muted">API endpoints not available. Please check your server.</div>';
    activityEl.innerHTML = '<div class="muted">No activity data - server offline.</div>';
  }
}

/* ---------- Actions ---------- */

async function analyzeAll(){
  status('Running SMART AI for all...');
  try{
    const r = await fetch('/api/ai/analyze-all-families', { method:'POST' });
    const data = await safeJson(r);
    lastResp.textContent = JSON.stringify(data ?? {http:r.status}, null, 2);
    if(!r.ok || !data?.success) throw new Error((data && (data.message||data.error)) || ('HTTP '+r.status));
    status('AI analysis complete','ok');
    await init();
  }catch(e){
    status('AI analysis failed','err', e);
    alert('SMART AI Analysis failed: ' + e.message);
  }
}

async function generateOne(inquiryId, btn){
  try{
    btn.disabled = true; 
    btn.textContent = 'Analysing...';
    const r = await fetch('/api/ai/engagement-summary/' + encodeURIComponent(inquiryId), { method:'POST' });
    const data = await safeJson(r);
    lastResp.textContent = JSON.stringify(data ?? {http:r.status}, null, 2);
    if(!r.ok || (data && data.success === false)) throw new Error((data && (data.message||data.error)) || ('HTTP '+r.status));
    await init();
  }catch(e){
    alert('Could not generate engagement summary: ' + e.message);
  }finally{
    btn.disabled = false; 
    btn.textContent = 'Regenerate AI summary';
  }
}

/* ---------- New: live GET for each enquiry ---------- */

async function fetchEngagementSummary(inquiryId){
  const url = '/api/ai/engagement-summary/' + encodeURIComponent(inquiryId);
  const r = await fetch(url);
  const data = await safeJson(r);
  if(!r.ok) throw new Error((data&&(data.message||data.error))||('HTTP '+r.status+' '+url));
  // Coerce numeric strings → numbers (PG can return text)
  data.sections = (data.sections||[]).map(s => ({
    ...s,
    dwell_seconds: Number(s.dwell_seconds||0),
    max_scroll_pct: Number(s.max_scroll_pct||0),
    video_plays: Number(s.video_plays||0),
    video_completes: Number(s.video_completes||0),
  }));
  data.visits = Number(data.visits||0);
  data.score  = Number(data.score||0);
  return data;
}

/* ---------- Renderers ---------- */

function renderFamilies(rows){
  if(!rows.length){ 
    familiesEl.innerHTML = '<div class="muted">No enquiries.</div>'; 
    return; 
  }
  familiesEl.innerHTML = '';
  rows.forEach(enq => {
    // Try common keys; fall back to id if needed
    const inquiryId = enq.inquiry_id || enq.id || enq.InquiryID || enq.InquiryId;
    const name = `${escapeHtml(enq.first_name||enq.child_name||'')} ${escapeHtml(enq.family_surname||enq.last_name||'')}`.trim();
    const entryYear = escapeHtml(enq.entry_year||enq.entryYear||'');
    const email = escapeHtml(enq.parent_email||enq.email||'');
    const pretty = enq.prospectus_pretty_url
      || (enq.prospectus_pretty_path ? (location.origin + enq.prospectus_pretty_path)
      : (enq.slug ? (location.origin + '/' + enq.slug) : null));

    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <div style="flex:1">
        <div><strong>${name}</strong> <span class="muted">(${entryYear})</span></div>
        <div class="muted">${email}</div>
        ${pretty? `<div class="pill" style="margin-top:6px"><a href="${pretty}" target="_blank" rel="noopener">Open prospectus</a></div>`:''}

        <div class="ai-block" data-ai>
          <div class="title">AI summary</div>
          <div class="muted" data-ai-text>Loading...</div>
          <table class="mini" data-ai-table style="display:none">
            <thead><tr><th>Section</th><th>Dwell</th><th>Scroll</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div style="text-align:right;min-width:220px">
        <div class="muted" style="font-weight:700">Score <span data-ai-score>—</span></div>
        <div class="muted" style="margin:6px 0"><span data-ai-visits>—</span> visit(s)</div>
        <button data-id="${inquiryId}" class="gen">Regenerate AI summary</button>
      </div>
    `;
    familiesEl.appendChild(row);

    // Wire up regenerate button
    row.querySelector('.gen').onclick = () => generateOne(inquiryId, row.querySelector('.gen'));

    // Live load the engagement summary per enquiry
    if(inquiryId){
      loadRowAI(inquiryId, row);
    }
  });
}

async function loadRowAI(inquiryId, row){
  const textEl = row.querySelector('[data-ai-text]');
  const table  = row.querySelector('[data-ai-table]');
  const tbody  = table?.querySelector('tbody');
  const scoreEl  = row.querySelector('[data-ai-score]');
  const visitsEl = row.querySelector('[data-ai-visits]');

  try{
    const { visits, score, sections, summaryText } = await fetchEngagementSummary(inquiryId);

    // Update right-hand badges
    if(scoreEl)  scoreEl.textContent  = String(score);
    if(visitsEl) visitsEl.textContent = String(visits);

    // Summary text
    if(textEl) { 
      textEl.classList.remove('muted'); 
      textEl.textContent = summaryText || '—'; 
    }

    // Sections table (top 5)
    if(tbody){
      const top = (sections||[]).slice(0,5);
      if(top.length){
        tbody.innerHTML = top.map(s => `
          <tr>
            <td>${escapeHtml(s.section)}</td>
            <td>${Math.round((s.dwell_seconds||0)/60)} min</td>
            <td>${s.max_scroll_pct}%</td>
          </tr>
        `).join('');
        table.style.display = '';
      }else{
        tbody.innerHTML = `<tr><td colspan="3" class="muted">No section data yet</td></tr>`;
        table.style.display = '';
      }
    }
  }catch(e){
    if(textEl){ 
      textEl.textContent = 'Could not load engagement summary.'; 
      textEl.classList.add('muted'); 
    }
    console.error('Engagement summary error for', inquiryId, e);
  }
}

function renderActivity(items){
  if(!items.length){ 
    activityEl.innerHTML = '<div class="muted">No recent activity.</div>'; 
    return; 
  }
  activityEl.innerHTML = '';
  items.slice(0,20).forEach(a => {
    const div = document.createElement('div'); 
    div.className='row';
    const when = a.when || a.timestamp;
    div.innerHTML = `<div><strong>${escapeHtml(a.name||'Unknown')}</strong> — ${escapeHtml(a.activity||'activity')}</div><div class="muted">${timeAgo(when)}</div>`;
    activityEl.appendChild(div);
  });
}

function renderMetrics(fam, dash){
  // Keep your legacy score calc for "hot/warm" tallies until all rows have live scores
  const hot  = fam.filter(f => calcScore(f.engagement||{},f) >= 80).length;
  const warm = fam.filter(f => {const s = calcScore(f.engagement||{},f); return s >= 60 && s < 80}).length;
  const ai   = fam.filter(f => f.aiEngagement && f.aiEngagement.narrative).length;
  S('mHot').textContent   = hot;
  S('mWarm').textContent  = warm;
  S('mAI').textContent    = ai;
  S('mTotal').textContent = fam.length || (dash?.totalFamilies ?? 0);
}

/* ---------- Helpers ---------- */

async function fetchJson(url){
  const r = await fetch(url);
  const d = await safeJson(r);
  if(!r.ok) throw new Error((d&&(d.message||d.error))||('HTTP '+r.status+' '+url));
  // Keep your "last response" pane useful but compact
  lastResp.textContent = JSON.stringify({url, ok:r.ok, sample:Array.isArray(d)?d.slice(0,1):d}, null, 2);
  return d;
}

async function safeJson(r){
  try{
    return await r.json();
  }catch(e){
    try{
      const text = await r.text();
      console.error('Expected JSON but got:', text.slice(0,200));
    }catch(_){}
    return null;
  }
}

function status(t,cls,e){ 
  statusTxt.className='muted'; 
  if(cls) statusTxt.className=cls; 
  statusTxt.textContent=t; 
  if(e) console.error(t,e); 
}

function timeAgo(ts){ 
  if(!ts) return '-'; 
  const d = new Date(ts);
  const n = new Date();
  const m = Math.floor((n-d)/60000);
  const h = Math.floor(m/60);
  const D = Math.floor(h/24); 
  if(m < 1) return 'Just now'; 
  if(m < 60) return m + ' min ago'; 
  if(h < 24) return h + 'h ago'; 
  if(D < 7) return D + 'd ago'; 
  return d.toLocaleDateString('en-GB'); 
}

function calcScore(eng,e){
  let s = 0;
  const mins = (eng.timeOnPage||eng.time_on_page||0)/60; 
  s += mins >= 30 ? 40 : mins >= 15 ? 30 : mins >= 5 ? 20 : Math.min(mins*4,15);
  const depth = eng.scrollDepth||eng.scroll_depth||0;     
  s += Math.min(depth*0.3,30);
  const v = eng.totalVisits||eng.total_visits||1;         
  s += v >= 5 ? 20 : v >= 3 ? 15 : v >= 2 ? 10 : 5;
  const c = eng.clickCount||eng.clicks_on_links||0;       
  s += Math.min(c*2,10);
  return Math.min(Math.round(s),100);
}

function escapeHtml(x){ 
  return String(x).replace(/[&<>"']/g, function(m) {
    var entities = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return entities[m];
  }); 
}

init();
</script>
</body>
</html>