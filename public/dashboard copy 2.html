<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admissions Dashboard</title>
  <style>
    :root { --bg:#0b0c10; --panel:#12141a; --muted:#7d8590; --text:#e6edf3; --accent:#3fb950; --warn:#f0883e; --danger:#ff6b6b; --line:#23262d; }
    * { box-sizing: border-box }
    html,body { height:100% }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text) }
    .wrap { max-width: 1200px; margin: 24px auto 80px; padding: 0 20px }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 18px }
    h1 { font-size: 20px; margin: 0 }
    .sub { color: var(--muted); font-size: 12px }
    .row { display:grid; gap:14px }
    @media(min-width:720px){ .row.cols-4 { grid-template-columns: repeat(4, 1fr) } .row.cols-2 { grid-template-columns: repeat(2, 1fr) } }
    .card { background: var(--panel); border:1px solid var(--line); border-radius: 10px; padding: 14px }
    .kpi { display:flex; flex-direction:column; gap:4px }
    .kpi .label { color: var(--muted); font-size: 12px }
    .kpi .value { font-size: 28px; font-weight: 700; line-height: 1.1 }
    .kpi .delta { font-size: 12px; color: var(--muted) }
    .controls { display:flex; gap:8px; align-items:center }
    button { background:#1f232b; color:var(--text); border:1px solid var(--line); padding:8px 12px; border-radius:8px; cursor:pointer }
    button:hover { border-color:#2b3038 }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 10px; border-bottom: 1px solid var(--line); font-size: 14px; vertical-align: top }
    th { text-align:left; color: var(--muted); font-weight:600 }
    td.right { text-align:right }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1f232b; border:1px solid var(--line) }
    .ok { color: var(--accent) }
    .warn { color: var(--warn) }
    .bad { color: var(--danger) }
    .muted { color: var(--muted) }
    .link { color:#58a6ff; text-decoration:none }
    .link:hover { text-decoration: underline }
    .section { margin-top: 18px }
    .section h2 { font-size: 16px; margin: 0 0 10px }
    .empty { color: var(--muted); font-style: italic; padding: 8px 0 }
    .errorbar { background:#2b1515; border:1px solid #5a1e1e; color:#ffd2d2; padding:10px 12px; border-radius:8px; display:none; margin-bottom:12px }
    .loading { opacity: .6 }
    code.inline { background:#1f232b; border:1px solid var(--line); padding:1px 6px; border-radius:6px }
    .grid-2 { display:grid; gap:14px }
    @media(min-width:900px){ .grid-2 { grid-template-columns: 1fr 1fr } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Admissions Dashboard</h1>
        <div class="sub" id="lastUpdated">Loading…</div>
      </div>
      <div class="controls">
        <button id="refreshBtn" type="button">Refresh</button>
      </div>
    </header>

    <div class="errorbar" id="errorBar"></div>

    <!-- KPIs -->
    <div class="row cols-4" id="kpis">
      <div class="card kpi">
        <div class="label">Ready for Contact</div>
        <div class="value" id="statReady">0</div>
        <div class="delta muted">Families with prospectuses generated</div>
      </div>
      <div class="card kpi">
        <div class="label">Highly Engaged</div>
        <div class="value" id="statEngaged">0</div>
        <div class="delta muted">&gt; 5 minutes dwell time</div>
      </div>
      <div class="card kpi">
        <div class="label">New Inquiries (7d)</div>
        <div class="value" id="statNew">0</div>
        <div class="delta muted">Rolling last 7 days</div>
      </div>
      <div class="card kpi">
        <div class="label">Total Families</div>
        <div class="value" id="statTotal">0</div>
        <div class="delta muted">All inquiries</div>
      </div>
    </div>

    <!-- Latest Prospectuses -->
    <div class="section card">
      <h2>Latest Prospectuses</h2>
      <div id="latestProspectusesWrap">
        <table>
          <thead>
            <tr><th>Name</th><th>Generated</th><th>Pretty Link</th><th>Direct File</th></tr>
          </thead>
          <tbody id="latestProspectusesBody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="grid-2">
      <!-- Recently Active -->
      <div class="section card">
        <h2>Recently Active</h2>
        <table>
          <thead>
          <tr><th>Name</th><th>Activity</th><th>When</th></tr>
          </thead>
          <tbody id="recentBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>

      <!-- Priority Families -->
      <div class="section card">
        <h2>Priority Families</h2>
        <table>
          <thead>
          <tr><th>Name</th><th>Age Group</th><th>Entry Year</th><th class="right">Score</th></tr>
          </thead>
          <tbody id="priorityBody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="grid-2">
      <!-- Top Interests -->
      <div class="section card">
        <h2>Top Interests (from inquiries)</h2>
        <table>
          <thead>
          <tr><th>Subject</th><th class="right">Count</th></tr>
          </thead>
          <tbody id="interestsBody"><tr><td colspan="2" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>

      <!-- Raw Inquiries (debug) -->
      <div class="section card">
        <h2>Raw Inquiries (for debugging)</h2>
        <table>
          <thead>
          <tr>
            <th>Family</th><th>Email</th><th>Age Group</th><th>Entry Year</th><th>Status</th><th>Received</th><th>Links</th>
          </tr>
          </thead>
          <tbody id="rawBody"><tr><td colspan="7" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);
    const setText = (id, v) => { const el = $(id); if (el) el.textContent = (v ?? '') + ''; }
    const esc = (s) => (s == null) ? '' : (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtDateTime = (iso) => {
      if (!iso) return '—';
      try { return new Date(iso).toLocaleString('en-GB', { hour12:false }); } catch { return iso; }
    };
    const fmtTime = (secs) => {
      secs = Math.max(0, Math.floor(+secs || 0));
      const m = Math.floor(secs/60), s = secs%60;
      return `${m}:${String(s).padStart(2,'0')}`;
    };
    const link = (url, text) => url ? `<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${esc(text||url)}</a>` : '<span class="muted">—</span>';

    function showError(msg) {
      const bar = $('errorBar');
      bar.textContent = msg;
      bar.style.display = 'block';
      console.error('[Dashboard]', msg);
    }

    // ---------- Data fetch ----------
    async function fetchJson(url, timeoutMs = 20000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(url, { signal: ctrl.signal, headers: { 'Accept':'application/json' }});
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function loadAll() {
      $('errorBar').style.display = 'none';
      setText('lastUpdated', 'Loading…');

      let dash = null, raw = null, dashErr = null, rawErr = null;

      await Promise.allSettled([
        fetchJson('/api/dashboard-data').then(j => dash = j).catch(e => dashErr = e),
        fetchJson('/api/analytics/inquiries').then(j => raw = j).catch(e => rawErr = e)
      ]);

      if (dashErr) showError('Failed to load /api/dashboard-data: ' + dashErr.message);
      if (rawErr)  showError('Failed to load /api/analytics/inquiries: ' + rawErr.message);

      try { renderDashboard(dash || {}); }
      catch (e) { showError('Dashboard render error: ' + e.message); }

      try { renderRaw(raw || []); }
      catch (e) { showError('Raw inquiries render error: ' + e.message); }

      setText('lastUpdated', 'Updated: ' + new Date().toLocaleString('en-GB', { hour12:false }));
    }

    // ---------- Renderers ----------
    function renderDashboard(data) {
      // KPI summary – be tolerant to old/next schemas
      const summary = data.summary || data.metrics || {};
      const ready        = summary.readyForContact ?? 0;
      const engaged      = summary.highlyEngaged ?? 0;
      const new7d        = (summary.newInquiries ?? summary.newInquiries7d) ?? 0;
      const total        = summary.totalFamilies ?? 0;

      setText('statReady', ready);
      setText('statEngaged', engaged);
      setText('statNew', new7d);
      setText('statTotal', total);

      // Latest prospectuses
      const lp = Array.isArray(data.latestProspectuses) ? data.latestProspectuses : [];
      const lpBody = $('latestProspectusesBody');
      if (!lp.length) {
        lpBody.innerHTML = `<tr><td colspan="4" class="muted">No prospectuses yet</td></tr>`;
      } else {
        lpBody.innerHTML = lp.map(r => {
          const pretty = r.prospectusPrettyUrl || r.prettyUrl || null;
          const direct = r.prospectusDirectUrl || r.directUrl || null;
          return `<tr>
            <td>${esc(r.name || '')}</td>
            <td>${fmtDateTime(r.generatedAt)}</td>
            <td>${link(pretty, 'Open pretty link')}</td>
            <td>${link(direct, 'Open direct file')}</td>
          </tr>`;
        }).join('');
      }

      // Recently Active
      const recent = (data.recentlyActive || []).map(r => ({
        name: r.name,
        activity: r.activity,
        when: r.when || r.timestamp
      }));
      const recentBody = $('recentBody');
      if (!recent.length) {
        recentBody.innerHTML = `<tr><td colspan="3" class="muted">No recent activity yet</td></tr>`;
      } else {
        recentBody.innerHTML = recent.map(r => `<tr>
          <td>${esc(r.name || '—')}</td>
          <td>${esc(r.activity || '—')}</td>
          <td>${fmtDateTime(r.when)}</td>
        </tr>`).join('');
      }

      // Priority Families – derive a score if not provided
      const pfBody = $('priorityBody');
      const pf = (data.priorityFamilies || []).map(p => {
        const score = (typeof p.engagementScore === 'number')
          ? p.engagementScore
          : Math.min(100, Math.round((Number(p.timeOnPage||0)/600)*70 + (Number(p.totalVisits||0)*10)));
        return { ...p, engagementScore: score };
      });
      if (!pf.length) {
        pfBody.innerHTML = `<tr><td colspan="4" class="muted">No priority families yet</td></tr>`;
      } else {
        pfBody.innerHTML = pf.map(p => `<tr>
          <td>${esc(p.name || '—')}</td>
          <td>${esc(p.ageGroup || '—')}</td>
          <td>${esc(p.entryYear || '—')}</td>
          <td class="right"><span class="pill">${p.engagementScore || 0}/100</span></td>
        </tr>`).join('');
      }

      // Top Interests
      const interests = data.topInterests || (data.analytics && data.analytics.topInterests) || [];
      const intBody = $('interestsBody');
      if (!interests.length) {
        intBody.innerHTML = `<tr><td colspan="2" class="muted">No interests recorded yet</td></tr>`;
      } else {
        intBody.innerHTML = interests.map(t => `<tr>
          <td>${esc(t.subject)}</td>
          <td class="right">${Number(t.count||0)}</td>
        </tr>`).join('');
      }
    }

    function renderRaw(list) {
      // list is an array of inquiry objects from /api/analytics/inquiries
      const body = $('rawBody');
      if (!Array.isArray(list) || !list.length) {
        body.innerHTML = `<tr><td colspan="7" class="muted">No inquiries yet</td></tr>`;
        return;
      }
      body.innerHTML = list.map(i => {
        const name = `${i.first_name||''} ${i.family_surname||''}`.trim() || '—';
        const pretty = i.prospectus_pretty_url;
        const direct = i.prospectus_direct_url;
        const links = (pretty || direct)
          ? [link(pretty, 'Pretty'), link(direct, 'Direct')].join(' · ')
          : '<span class="muted">—</span>';
        return `<tr>
          <td>${esc(name)}</td>
          <td>${esc(i.parent_email || '—')}</td>
          <td>${esc(i.age_group || '—')}</td>
          <td>${esc(i.entry_year || '—')}</td>
          <td>${esc(i.status || '—')}</td>
          <td>${fmtDateTime(i.received_at)}</td>
          <td>${links}</td>
        </tr>`;
      }).join('');
    }

    // ---------- Init ----------
    $('refreshBtn').addEventListener('click', () => loadAll());
    loadAll();
  </script>
</body>
</html>
