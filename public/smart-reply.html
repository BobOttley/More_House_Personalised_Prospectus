<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMART Reply - More House School</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blazer-navy: #091825;
      --award-gold: #FF9F1C;
      --sport-blue: #034674;
      --text-primary: #2C3E50;
      --white: #FFFFFF;
      --light-grey: #F8FAFC;
      --border-grey: #E5E7EB;
      --success: #10B981;
      --warning: #F59E0B;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #FAFBFC;
      color: var(--text-primary);
      font-size: 14px;
    }

    .content-wrapper {
      padding: 2rem;
    }

    /* Header */
    .page-header {
      background: var(--blazer-navy);
      color: #fff;
      padding: 2rem;
      border-bottom: 4px solid var(--award-gold);
      margin-bottom: 2rem;
      text-align: center;
    }

    .page-header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      margin-bottom: 0;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .smart-text {
      color: var(--award-gold);
    }

    .reply-text {
      color: #fff;
      font-weight: 400;
    }

    .page-header p {
      display: none;
    }

    /* Main Grid */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 968px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 8px;
      border: 1px solid var(--border-grey);
      padding: 1.5rem;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--light-grey);
    }

    .card-icon {
      font-size: 1.5rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--blazer-navy);
    }

    .card-subtitle {
      font-size: 0.85rem;
      color: #6B7280;
      margin-top: 0.25rem;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-grey);
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--sport-blue);
      box-shadow: 0 0 0 3px rgba(3, 70, 116, 0.1);
    }

    .form-textarea {
      min-height: 250px;
      font-family: 'Courier New', monospace;
      resize: vertical;
    }

    .form-textarea.reply-output {
      min-height: 400px;
      background: #F9FAFB;
      line-height: 1.6;
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--blazer-navy);
      color: white;
    }

    .btn-primary:hover {
      background: var(--sport-blue);
    }

    .btn-primary:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      border: 1.5px solid var(--border-grey);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--light-grey);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .button-group {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    /* Loading State */
    .loading {
      display: none;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: #FEF3C7;
      border: 1px solid #FCD34D;
      border-radius: 4px;
      margin: 1rem 0;
      color: #92400E;
      font-size: 0.875rem;
    }

    .loading.active {
      display: flex;
    }

    .loading::before {
      content: 'Loading';
      display: inline-block;
      font-size: 0.875rem;
      margin-right: 0.25rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Info Box */
    .info-box {
      background: #EFF6FF;
      border-left: 4px solid var(--sport-blue);
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }

    .info-box h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--sport-blue);
      margin-bottom: 0.5rem;
    }

    .info-box p {
      font-size: 0.85rem;
      color: #1E40AF;
      line-height: 1.5;
    }

    .info-box ul {
      margin-top: 0.5rem;
      margin-left: 1.25rem;
      font-size: 0.85rem;
      color: #1E40AF;
    }

    .info-box li {
      margin-bottom: 0.25rem;
    }

    /* Quick Templates */
    .template-chips {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .chip {
      padding: 0.5rem 1rem;
      background: white;
      border: 1.5px solid var(--border-grey);
      border-radius: 20px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chip:hover {
      background: var(--award-gold);
      border-color: var(--award-gold);
      color: white;
    }

    /* Copy Button Container */
    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .copy-btn {
      padding: 0.5rem 1rem;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .copy-btn:hover {
      background: #059669;
    }

    .copy-btn.copied {
      background: var(--blazer-navy);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="page-header">
    <h1><span class="smart-text">SMART</span> <span class="reply-text">Reply</span></h1>
  </div>

  <div class="content-wrapper">
    <!-- Main Grid -->
    <div class="grid">
      <!-- Input Card -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Parent Email</div>
            <div class="card-subtitle">Paste the email you received</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Email Template Type</label>
          <select class="form-select" id="templateType">
            <option value="initial">Initial Response - First contact</option>
            <option value="followup">Follow-up - Nurturing enquiry</option>
            <option value="open_day">Open Day - Event invitation</option>
            <option value="sixth_form">Sixth Form - A Level information</option>
            <option value="custom">Custom - Flexible response</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">From (Parent Name)</label>
          <input type="text" class="form-input" id="parentName" placeholder="e.g., Sarah Johnson">
        </div>

        <div class="form-group">
          <label class="form-label">Email Content</label>
          <textarea 
            class="form-textarea" 
            id="emailInput" 
            placeholder="Paste the parent's email here...

Example:
Dear Admissions Team,

I am interested in learning more about More House School for my daughter Emma (age 13). She is particularly interested in sciences and drama.

Could you provide information about your curriculum and any upcoming open days?

Best regards,
Sarah Johnson"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Additional Instructions (Optional)</label>
          <input 
            type="text" 
            class="form-input" 
            id="additionalInstructions" 
            placeholder="e.g., Focus on science programmes, mention upcoming open day">
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="generateBtn">
            Generate Reply
          </button>
          <button class="btn btn-secondary" id="clearBtn">
            Clear All
          </button>
        </div>

        <div class="loading" id="loadingIndicator">
          <span>Generating AI response using school knowledge base...</span>
        </div>
      </div>

      <!-- Output Card -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Generated <span class="smart-text">SMART</span> Reply</div>
          </div>
        </div>

        <div class="output-header">
          <label class="form-label">Professional Email Response</label>
          <button class="copy-btn" id="copyBtn" style="display:none;">Copy Reply</button>
        </div>

        <textarea 
          class="form-textarea reply-output" 
          id="replyOutput" 
          readonly 
          placeholder="Your AI-generated reply will appear here...

The assistant will:
- Address the parent by name
- Reference specific questions from their email
- Use accurate information from the school knowledge base
- Maintain a professional yet warm tone
- Use British English spelling and school terminology
- Include relevant links and resources
- Remember More House is an all-girls day school"></textarea>
        
        <!-- Feedback Area - Shows after generation -->
        <div id="feedbackContainer" style="margin-top: 1rem;">
          <!-- Feedback controls will appear here after email generation -->
        </div>

      </div>
    </div>
  </div>

  <script>
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const emailInput = document.getElementById('emailInput');
    const replyOutput = document.getElementById('replyOutput');
    const parentName = document.getElementById('parentName');
    const templateType = document.getElementById('templateType');
    const additionalInstructions = document.getElementById('additionalInstructions');

    // Generate Reply
    generateBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const parent = parentName.value.trim();
      
      if (!email) {
        alert('Please paste the parent email first');
        return;
      }

      if (!parent) {
        alert('Please enter the parent name');
        return;
      }

      // Show loading
      generateBtn.disabled = true;
      loadingIndicator.classList.add('active');
      replyOutput.value = 'Generating response...';

      try {
        const response = await fetch('/api/ai/generate-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            originalEmail: {
              from: parent,
              text: email,
              subject: 'Enquiry',
              date: new Date().toISOString()
            },
            templateType: templateType.value,
            instructions: (additionalInstructions.value ? additionalInstructions.value + '. ' : '') + 
              'IMPORTANT: Use British English spelling throughout (e.g., colour, organise, programme, behaviour, centre). ' +
              'Use British school terminology (Year groups not Grades, sixth form, A Levels, GCSE, head teacher not principal). ' +
              'Remember More House is an all-girls day school (no boarding facilities).'
          })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.email) {
          replyOutput.value = data.email;
          copyBtn.style.display = 'block';
          
          // Add feedback controls if we have a history ID
          if (data.historyId) {
            addFeedbackControls(data.historyId);
          }
        } else {
          throw new Error(data.error || 'Failed to generate response');
        }
      } catch (error) {
        console.error('Error:', error);
        replyOutput.value = `Error generating reply: ${error.message}\n\nPlease try again or contact support.`;
      } finally {
        generateBtn.disabled = false;
        loadingIndicator.classList.remove('active');
      }
    });

    // Clear All
    clearBtn.addEventListener('click', () => {
      emailInput.value = '';
      replyOutput.value = '';
      parentName.value = '';
      additionalInstructions.value = '';
      templateType.value = 'initial';
      copyBtn.style.display = 'none';
    });

    // Copy Reply
    copyBtn.addEventListener('click', () => {
      replyOutput.select();
      document.execCommand('copy');
      
      copyBtn.textContent = 'Copied!';
      copyBtn.classList.add('copied');
      
      setTimeout(() => {
        copyBtn.textContent = 'Copy Reply';
        copyBtn.classList.remove('copied');
      }, 2000);
    });

    // Enable Enter key to generate (Ctrl+Enter)
    emailInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        generateBtn.click();
      }
    });

    // FEEDBACK SYSTEM FUNCTIONS
    function addFeedbackControls(historyId) {
      // Get the feedback container
      const feedbackContainer = document.getElementById('feedbackContainer');
      if (!feedbackContainer) {
        console.error('Feedback container not found!');
        return;
      }

      // Clear any existing feedback
      feedbackContainer.innerHTML = '';

      // Add new feedback controls
      const feedbackHTML = `
        <div class="feedback-section" id="feedbackSection" style="padding: 1rem; background: #FFF3CD; border: 2px solid var(--award-gold); border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 600; color: var(--blazer-navy);">‚úèÔ∏è Improve AI Accuracy</span>
            <button class="btn btn-primary" onclick="enableEditing('${historyId}')" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--award-gold); border: none; color: var(--blazer-navy); font-weight: 600;">
              Edit & Train AI
            </button>
          </div>
          <div id="editingControls" style="display: none; margin-top: 1rem;">
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
              <h3 style="font-size: 1rem; color: var(--blazer-navy); margin-bottom: 0.5rem;">üìö Help the AI Learn</h3>
              <p style="font-size: 0.875rem; color: #6B7280;">Edit the email above, then tell us what needed fixing so the AI learns from this correction.</p>
            </div>
            
            <label class="form-label">What type of correction?</label>
            <select id="correctionType" class="form-select" style="margin-bottom: 0.75rem;">
              <option value="">Select correction type...</option>
              <option value="tone">Tone - too formal/casual</option>
              <option value="facts">Facts - incorrect information</option>
              <option value="grammar">Grammar/spelling</option>
              <option value="structure">Structure/format</option>
              <option value="personalization">Personalization - not specific enough</option>
              <option value="terminology">Terminology - wrong terms used</option>
            </select>
            
            <label class="form-label">Specific feedback (required):</label>
            <input type="text" id="feedbackNotes" class="form-input" 
                   placeholder="e.g., 'Too formal - should be warmer', 'Used Grade instead of Year'" 
                   style="margin-bottom: 1rem;">
            
            <div class="button-group">
              <button class="btn btn-success" onclick="submitCorrection('${historyId}')" id="submitCorrectionBtn">
                üíæ Save Correction & Train AI
              </button>
              <button class="btn btn-secondary" onclick="cancelEditing()">
                Cancel
              </button>
            </div>
            
            <div id="feedbackStatus" style="margin-top: 1rem; display: none; padding: 0.75rem; border-radius: 4px;"></div>
          </div>
        </div>
      `;
      
      // Insert into the container
      feedbackContainer.innerHTML = feedbackHTML;
    }

    // FEEDBACK SYSTEM FUNCTIONS - Make them globally accessible
    window.enableEditing = function(historyId) {
      // Make textarea editable
      replyOutput.readOnly = false;
      replyOutput.style.background = '#FFFFFF';
      replyOutput.style.border = '2px solid var(--award-gold)';
      
      // Show editing controls
      document.getElementById('editingControls').style.display = 'block';
      
      // Store the history ID for submission
      window.currentHistoryId = historyId;
    }

    window.cancelEditing = function() {
      // Make textarea read-only again
      replyOutput.readOnly = true;
      replyOutput.style.background = '#F9FAFB';
      replyOutput.style.border = '1px solid var(--border-grey)';
      
      // Hide editing controls
      const editingControls = document.getElementById('editingControls');
      if (editingControls) {
        editingControls.style.display = 'none';
      }
    }

    window.submitCorrection = async function(historyId) {
      const correctedEmail = replyOutput.value;
      const correctionType = document.getElementById('correctionType').value;
      const feedbackNotes = document.getElementById('feedbackNotes').value;
      
      if (!correctionType) {
        alert('Please select what type of correction this is');
        return;
      }
      
      if (!feedbackNotes) {
        alert('Please provide specific feedback to help the AI learn');
        return;
      }
      
      const submitBtn = document.getElementById('submitCorrectionBtn');
      const statusDiv = document.getElementById('feedbackStatus');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Training AI...';
      
      try {
        const response = await fetch('/api/ai/email-feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            historyId,
            correctedEmail,
            correctionNotes: feedbackNotes,
            correctionType
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = '#D1FAE5';
          statusDiv.style.color = '#065F46';
          statusDiv.style.border = '2px solid #10B981';
          statusDiv.style.padding = '1rem';
          statusDiv.innerHTML = `
            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">
              ‚úÖ AI Training Successful!
            </div>
            <div>
              The AI learned ${result.patternsLearned || 1} new pattern${result.patternsLearned !== 1 ? 's' : ''} from your correction.
              It won't make this mistake again!
            </div>
          `;
          
          // Reset after success
          setTimeout(() => {
            window.cancelEditing();
            feedbackContainer.innerHTML = '<div style="padding: 1rem; background: #D1FAE5; border-radius: 4px; text-align: center; color: #065F46;">‚úÖ Correction saved! Generate another email to continue training the AI.</div>';
          }, 4000);
        } else {
          throw new Error(result.error || 'Failed to save correction');
        }
      } catch (error) {
        console.error('Feedback submission error:', error);
        statusDiv.style.display = 'block';
        statusDiv.style.color = '#EF4444';
        statusDiv.textContent = `Error: ${error.message}`;
        
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Correction & Train AI';
      }
    }
  </script>
</body>
</html>